
/* Smart UI v9.3.53 (2021-05-10) 
Copyright (c) 2011-2021 jQWidgets. 
License: https://htmlelements.com/license/ */ //

Smart("smart-filter-builder",class extends Smart.BaseElement{static get properties(){return{customOperations:{value:[],type:"array",reflectToAttribute:!1},disableContextMenu:{value:!1,type:"boolean"},fields:{value:null,type:"array?",reflectToAttribute:!1},formatStringDate:{value:"dd-MMM-yy",type:"string"},formatStringDateTime:{value:"dd-MMM-yy HH:mm:ss",type:"string"},hint:{value:null,type:"string?"},icons:{value:{"=":"=","<>":"≠",">":">",">=":"≥","<":"<","<=":"≤",startswith:"a|bc",endswith:"ab|c",contains:"abc",notcontains:"!abc",isblank:"○",isnotblank:"●"},type:"object",reflectToAttribute:!1},maxConditions:{value:null,type:"number?",validator:"_maxValidator"},maxConditionsPerGroup:{value:null,type:"number?",validator:"_maxValidator"},maxLevel:{value:null,type:"number?",validator:"_maxValidator"},messages:{value:{en:{add:"Add",addCondition:"Add Condition",addGroup:"Add Group",and:"And",notand:"Not And",or:"Or",notor:"Not Or","=":"Equals","<>":"Does not equal",">":"Greater than",">=":"Greater than or equal to","<":"Less than","<=":"Less than or equal to",startswith:"Starts with",endswith:"Ends with",contains:"Contains",notcontains:"Does not contain",isblank:"Is blank",isnotblank:"Is not blank",wrongParentGroupIndex:'{{elementType}}: Wrong parent group index in "{{method}}" method.',missingFields:'{{elementType}}: Fields are required for proper condition\'s adding. Set "fields" source and then conditions will be added as expected.',wrongElementNode:'{{elementType}}: Incorect node / node Id in "{{method}}" method.',invalidDataStructure:"{{elementType}}: Used invalid data structure in updateCondition/updateGroup method.",dateTabLabel:"DATE",timeTabLabel:"TIME"}},type:"object",extend:!0},restrictedMode:{value:!1,type:"boolean"},showIcons:{value:!1,type:"boolean"},value:{value:["or"],type:"array?",reflectToAttribute:!1},valueFormatFunction:{value:null,type:"function?",reflectToAttribute:!1},valuePlaceholder:{value:"&lt;enter a value&gt;",type:"string"}}}static get requires(){return{"Smart.Button":"smart.button.js","Smart.CheckBox":"smart.checkbox.js","Smart.ScrollBar":"smart.scrollbar.js","Smart.ListBox":"smart.listbox.js","Smart.DropDownList":"smart.dropdownlist.js","Smart.ComboBox":"smart.combobox.js","Smart.Calendar":"smart.calendar.js","Smart.TimePicker":"smart.timepicker.js","Smart.Tooltip":"smart.tooltip.js","Smart.Utilities.DateTime":"smart.date.js","Smart.DateTimePicker":"smart.datetimepicker.js","Smart.Menu":"smart.menu.js"}}static get listeners(){return{down:"_downHandler","document.click":"_documentClickHandler","conditionsMenu.itemClick":"_menuItemClickHandler","container.change":"_containerChangeHandler","scrollableContainer.wheel":"_scrollViewerWheelHandler","scrollableOuterContainer.resize":"_resizeHandler","innerContainer.keydown":"_innerContainerKeydownHandler"}}static get styleUrls(){return["smart.filterbuilder.css"]}template(){return'<div id="container" title="[[hint]]">\n                    <div id="innerContainer" class="smart-inner-container">\n                            <div id="scrollableOuterContainer" class="smart-scrollable-outer-container">\n                                <smart-scroll-viewer id="scrollableContainer" class="smart-scrollable-container" animation="[[animation]]">\n                                    <div id="contentContainer" class="smart-content-container"></div>\n                                </smart-scroll-viewer>\n                            </div>\n                            <div id="editorsContainer" class="smart-editors-container">\n                                <div id="customEditor" class="smart-custom-editor smart-hidden"></div>\n                            </div>\n                    </div>\n                    <smart-menu id="conditionsMenu" mode="dropDown" class="smart-conditions-menu" theme="[[theme]]" animation="[[animation]]"></smart-menu>\n            </div>'}propertyChangedHandler(e,t,a){const i=this,l=["textBoxEditor","numericTextBoxEditor","comboBoxEditor","dateTimePickerEditor","checkBoxEditor"];switch(super.propertyChangedHandler(e,t,a),e){case"animation":case"theme":l.forEach((t=>i.$[t]&&(i.$[t][e]=a)));break;case"customOperations":i._handleCustomOperations(),i._refresh();break;case"fields":i._mapFieldsToMenu(),i._refresh();break;case"formatStringDate":case"formatStringDateTime":case"showIcons":case"valueFormatFunction":i._refresh();break;case"locale":case"messages":i._localizeInitialValues(),i._refresh(),i._handleCustomOperations(),i.$.dateTimePickerEditor&&(i.$.dateTimePickerEditor.messages[i.locale]||(i.$.dateTimePickerEditor.messages[i.locale]={}),i.$.dateTimePickerEditor.messages[i.locale].dateTabLabel=i.localize("dateTabLabel"),i.$.dateTimePickerEditor.messages[i.locale].timeTabLabel=i.localize("timeTabLabel"),"locale"===e?i.$.dateTimePickerEditor.locale=i.locale:"messages"===e&&(i.$.dateTimePickerEditor.$.selectDate.innerHTML=i.$.dateTimePickerEditor.messages[i.locale].dateTabLabel,i.$.dateTimePickerEditor.$.selectTime.innerHTML=i.$.dateTimePickerEditor.messages[i.locale].timeTabLabel));break;case"maxConditions":case"maxConditionsPerGroup":case"maxLevel":case"value":{i._totalConditions=0,i._validateValue(),i._emptyElementsStructure(!0),i._convertValueToFlat(i.value),i._getFieldsFromValue(),i._mapFieldsToMenu(),i._generateHTMLStructureFromFlatValue(),i.$.scrollableContainer.refresh();const e=JSON.stringify(i.value);i._oldValueAsString!==e&&(i._oldValueAsString=e,i.$.fireEvent("change",{value:JSON.parse(e)}));break}case"valuePlaceholder":i._updatePlaceholder()}}_maxValidator(e,t){return"number"!=typeof t?t:Math.max(1,t)}ready(){super.ready();const e=this;e._validateValue(),e._setInitialValues(),e._handleCustomOperations(),e._emptyElementsStructure(!0),e._totalConditions=0,e._convertValueToFlat(e.value),e._getFieldsFromValue(),e._generateHTMLStructureFromFlatValue(),e.$.conditionsMenu._noAutoFocus=!0,e._oldValueAsString=JSON.stringify(e.value),e.$.scrollableContainer.refresh()}addCondition(e,t){this._checkFieldsExistence(),this._addElement("condition",e,t)}addGroup(e,t){this._addElement("group",e,t)}removeCondition(e){const t=this;t._validateNode(e,"removeCondition"),t._deleteElement(e,"condition"),t._refresh()}removeGroup(e){const t=this;t._validateNode(e,"removeGroup"),t._deleteElement(e,"group"),t._refresh()}toString(e){const t=this;if(!e)return JSON.stringify(t.value);let a=[],i=[];for(let e=0;e<t._valueFlat.length;e++){const i=t._valueFlat[e];let l={};if("condition"===i.type){const e=t._getFieldByFieldName(i.data[0]),a=e.dataType,o="["+(e.label||e.value)+"]",r=t.localize(i.data[1]),n=-1!==["boolean","number"].indexOf(a)?i.data[2]+"":"'"+i.data[2]+"'";l.data=o+" "+r+" "+n}else l.data=i.data;l.nodeId=i.nodeId,l.parentId=i.parentId,l.type=i.type,a.push(l)}for(let e=0;e<a.length;e++){const l=a[e];let o={};if("group"===l.type){const e=a.filter((e=>e.parentId===l.nodeId&&"condition"===e.type));if(e.length>0){let a=e.map((e=>e.data)),r="",n="",s=l.data;-1!==["notand","notor"].indexOf(s)&&(r="Not (",n=")",s=s.substring(3)),o.nodeId=l.nodeId,o.parentId=l.parentId,o.data=l.data,o.structure=r+a.join(" "+t.localize(s)+" ")+n,i.push(o)}}}i=i.filter((e=>e.structure.length>1)),i.sort((function(e,t){return t.nodeId.split(".").length-e.nodeId.split(".").length}));for(let e=0;e<i.length;e++){const a=i[e],l=i.filter((e=>e.nodeId===a.parentId))[0];if(l&&l.structure){let e=l.data;-1!==["notand","notor"].indexOf(e)?(e=e.substring(3),l.structure=l.structure.slice(0,l.structure.length-1)+" "+t.localize(e)+" ("+a.structure+"))"):l.structure=l.structure+" "+t.localize(e)+" ("+a.structure+")"}}return i[i.length-1].structure}updateCondition(e,t){const a=this,i=a._validateNode(e,"updateCondition");a._validateUserData(t,!0),i.data=t,a._refresh()}updateGroup(e,t){const a=this,i=a._validateNode(e,"updateGroup");a._validateUserData(t),i.data=t,a._refresh()}_addElement(e,t,a){t=t||"0";const i=this,l=i._valueFlat.filter((e=>e.nodeId===t&&"group"===e.type)),o=l.length>0&&l[0],r=i._valueFlat.filter((e=>e.parentId===t));let n=0,s="";if(o||i.error(i.localize("wrongParentGroupIndex",{elementType:i.nodeName.toLowerCase(),method:"addGroup/addCondition"})),"group"===e)a=a||"or";else{if(r.filter((e=>"condition"===e.type)).length===i.maxConditionsPerGroup||i._totalConditions===i.maxConditions)return;const e=i.fields&&i.fields.length>0?i.fields[0].dataField:i._valueFields[0].dataField;i._totalConditions++,(a=a||[])[0]=a[0]||e,a[1]=a[1]||"=",a[2]=void 0!==typeof a[2]?a[2]:null}if(r){let e=r.map((e=>{const t=e.nodeId.split(".");return parseInt(t[t.length-1])}));e=0===e.length?[0]:e,n=e.reduce((function(e,t){return Math.max(e,t)}))+1}t&&t.length>0&&(s=".");const d={nodeId:t+s+n,parentId:t,type:e,data:a,htmlNode:null};i._valueFlat.push(d),i._refresh()}_clearConditionsValue(e,t){const a=this,i=(a.shadowRoot||a).querySelector('[node-id="'+(e||0)+'"]').querySelector(".smart-value-container");for(let i=0;i<a._valueFlat.length;i++)if(a._valueFlat[i].nodeId===e){const e=a._valueFlat[i],l=t?a.fields.find((e=>e.dataField===t)).dataType:a.fields.find((t=>t.dataField===e.data[0])).dataType;e.data[2]=a._defaultValueByType(l)}i.innerHTML=a.valuePlaceholder,i.closest(".smart-filter-value").setAttribute("placeholder","")}_convertValueToFlat(e,t){const a=this,i=/^(and|or|notAnd|notOr)$/i;if(!e)return;const l=e.filter((e=>"string"==typeof e&&e.match(i))),o=l?l[0]:null,r=e.filter((e=>Array.isArray(e)&&3===e.length&&0===e.filter((e=>"string"==typeof e&&e.match(i))).length)),n=e.filter((e=>!r.includes(e)&&e!==o));if(!l)return;const s=a._lastProcessedItemInCurrentGroup.parentId?".":"",d=(a._lastProcessedItemInCurrentGroup.parentId||"")+s+(t||0);if(a._isMaxLevelExceeded(d))return;const c={nodeId:d,parentId:a._lastProcessedItemInCurrentGroup.parentId,type:"group",data:o,htmlNode:null};a._valueFlat.push(c),a._lastProcessedItemInCurrentGroup.position=0;for(let e=0;e<r.length&&r[e];e++){const t=d+"."+(a._lastProcessedItemInCurrentGroup.position||0);if(a._isMaxLevelExceeded(t))break;const i={nodeId:t,parentId:d,type:"condition",data:r[e],htmlNode:null};a._totalConditions++,a._valueFlat.push(i),a._lastProcessedItemInCurrentGroup.position++}for(let e=0;e<n.length;e++)a._lastProcessedItemInCurrentGroup.parentId=d,a._convertValueToFlat(n[e],r.length+e),a._lastProcessedItemInCurrentGroup.position++}_isMaxLevelExceeded(e){const t=this,a=t._valueFlat;if(!(null===t.maxLevel||a.length<1)){if(e)return e.split(".").length-2>=t.maxLevel;for(let e=0;e<a.length;e++)if(a[e].nodeId.split(".").length-2>t.maxLevel)return!0}}_clickHandler(e){const t=this,a=t.shadowRoot||t.isInShadowDOM?e.composedPath()[0]:e.target,i=a?a.closest(".smart-filter-group-condition"):null,l=i?i.getAttribute("node-id"):null,o=a?a.closest(".smart-filter-group"):null,r=o?o.getAttribute("node-id"):null,n=a.closest(".smart-filter-add-btn"),s=a.closest(".smart-filter-delete-btn"),d=a.closest(".filter-builder-item"),c=l||r,u=t._getItemById(c);let m;if(t.disabled)return;if((d||s||n)&&(m=d?d.classList.contains("smart-filter-field-name")?"fieldButton":d.classList.contains("smart-filter-operation")?"operationButton":d.classList.contains("smart-filter-value")?"valueButton":"groupOperationButton":n?"addButton":"deleteButton",t.$.fireEvent("itemClick",{id:u.nodeId,type:u.type,component:m,data:u.data})),s){const e=a.closest(".smart-filter-group-operator"),i=a.closest(".smart-filter-group-condition");return void t._clickHandlerDeleteButton(e,i,o)}if(n)return t._closeEditor(),t._contextMenuOptions=t._addOptions,void t._handleContextMenu(a);if(d){const e=d.classList;return void t._clickHandlerFilterButton(e,c,a)}t.$.conditionsMenu.opened&&(t.$.fireEvent("menuClosing"),t.$.conditionsMenu.close(),t.$.fireEvent("menuClose"));const p=a.closest(".smart-drop-down"),f=t._editor&&t._editor.contains(a)||p&&p.ownerElement===t._editor||a.closest(".smart-custom-editor");t._editorIsOpen&&t._editor&&!f&&(t._scrollBarDown?delete t._scrollBarDown:t._closeEditor())}_clickHandlerDeleteButton(e,t,a){const i=this;i.$.conditionsMenu.opened&&(i.$.fireEvent("menuClosing"),i.$.conditionsMenu.close(),i.$.fireEvent("menuClose")),i._closeEditor(),e?(i._deleteElement(a,"group"),i._generateValue()):t&&(i._deleteElement(t),i._generateValue()),i.$.scrollableContainer.refresh()}_clickHandlerFilterButton(e,t,a){const i=this;if(!a.closest(".smart-editors-container")&&(i._closeEditor(),i._editedItem=i._getItemById(t),e.contains("smart-filter-field-name")||i._editedItem.data&&i._editedItem.data.length))if(e.contains("smart-filter-group-operation"))l(a,i._groupOperationDescriptions,i._editedItem.data);else if(e.contains("smart-filter-add-btn"))l(a,i._groupOperationDescriptions);else{if(e.contains("smart-filter-field-name"))return i._fields||i._mapFieldsToMenu(),void l(a,i._fields,i._editedItem.data[0]);if(e.contains("smart-filter-operation")){const e=i._getFieldByFieldName(i._editedItem.data[0]);if(!e)return;let t=i._filterOperationDescriptions.slice();if(e&&e.filterOperations)t=i._filterOperationDescriptions.filter((t=>e.filterOperations.indexOf(t.value)>-1));else{let a;switch(e.dataType){case"number":case"date":case"dateTime":a=["=","<>","<",">","<=",">=","isblank","isnotblank"];break;case"boolean":a=["=","<>","isblank","isnotblank"];break;case"object":a=["isblank","isnotblank"];break;case"string":a=["contains","notcontains","startswith","endswith","=","<>","isblank","isnotblank"];break;default:a=["contains","notcontains","startswith","endswith","=","<>","<",">","<=",">=","isblank","isnotblank"]}t=i._filterOperationDescriptions.filter((e=>a.indexOf(e.value)>-1))}return i.showIcons&&(t=t.map((e=>(e.label='<div class="smart-filter-builder-icon">'+i.icons[e.value]+'</div><div class="smart-filter-builder-menu-item">'+i.localize(e.value)+"</div>",e)))),void l(a,t.slice(),i._editedItem.data[1])}i._openEditor(a)}function l(e,t,a){!function(){const e=i.$.conditionsMenu.querySelector(".smart-selected-menu-item");e&&e.classList.remove("smart-selected-menu-item")}(),i._contextMenuOptions=0===t.length?i._defaultFilterOperationDescriptions:t,i._handleContextMenu(e);const l=a,o=i.$.conditionsMenu.querySelector('smart-menu-item[value="'+l+'"]');i.$.conditionsMenu.opened&&o&&o.classList.add("smart-selected-menu-item")}}_closeEditor(e){const t=this;let a;if(!t._editedItem||!t._editorIsOpen)return;if(t._editor===t.$.dateTimePickerEditor)t._editor._inputChangeHandler(),a=t._editor.value,a&&(a=a.toDate());else if(t._editor===t.$.checkBoxEditor)a=t._editor.checked;else if(t._editor===t.$.customEditor)a=t._selectedCustomCondition.handleValue(t._editor);else if(t._editor===t.$.numericTextBoxEditor)t._editor._inputBlurHandler(),a=t._editor.value;else{const e=t._getFieldByFieldName(t._editedItem.data[0]);a="array"===e.dataType?t._editor.value.split(","):"object"===e.dataType?JSON.parse(t._editor.value):t._editor.value}const i=t._editedItem,l=i.htmlNode,o=i.nodeId,r=t._getFieldByFieldName(i.data[0]).dataType,n=l.querySelector(".smart-filter-value"),s=l.querySelector(".smart-value-container"),d={value:a,valueType:r||"string",editedItem:i};if(t.$.fireEvent("editorClosing",d),t._updateValueInFlatArray(o,a,"value",r||"string"),t._generateValue(e),n.removeAttribute("edited"),t.$.editorsContainer.removeAttribute("open"),t._editor===t.$.checkBoxEditor)s.innerHTML=t._editor.checked?"true":"false";else if(t._editor===t.$.customEditor){const e=t._selectedCustomCondition.valueTemplate(t._editor);s.innerHTML=e}else s.innerHTML=t._formatValueStringRepresentation(t._editor.value,t._editedItem.data[0]);t._editor.classList.add("smart-hidden"),t._editorIsOpen=t._enterIsPressedInEditor=!1,t.$.fireEvent("editorClose",d),t.$.scrollableContainer.refresh()}_defaultValueByType(e){let t;switch(e){case"number":t=0;break;case"date":case"dateTime":t=new Date,t.setHours(0,0,0);break;case"boolean":t=!1;break;case"object":t=null;break;default:t=""}return t}_deleteElement(e,t){const a=this,i=e instanceof HTMLElement?e:a._valueFlat.find((t=>t.nodeId===e)).htmlNode,l="string"==typeof e?e:e.getAttribute("node-id");if(l&&1!==l.length){"group"===t?function e(t){const i=a._valueFlat.filter((e=>t===e.nodeId)),l=i?i[0]:null;for(let i=0;i<a._valueFlat.length;i++){const l=a._valueFlat[i],r=l.nodeId;l.parentId===t&&("group"===l.type?e(r):o(r))}a._valueFlat.indexOf(l)>-1&&a._valueFlat.splice(a._valueFlat.indexOf(l),1)}(l):o(l);for(let e=a._valueFlat.length-1;e>=0;e--)0===a._valueFlat.filter((t=>a._valueFlat[e].parentId===t.nodeId)).length&&"0"!==a._valueFlat[e].nodeId&&(a._valueFlat.splice(e,1),a._totalConditions--);a._generateValue(),i.parentElement.removeChild(i),function e(t,i){t.forEach(((t,l)=>{const o=a._valueFlat.find((e=>e.htmlNode===t)),r=i+"."+l;t.setAttribute("node-id",r),o.parentId=i,o.nodeId=r,t.classList.contains("smart-filter-group")&&e(Array.from(t.children[1].children),r)}))}(Array.from(a.$.contentContainer.firstElementChild.children[1].children),"0")}function o(e){const t=a._valueFlat.filter((t=>e===t.nodeId));let i=t?t[0]:null;a._valueFlat.splice(a._valueFlat.indexOf(i),1),a._totalConditions--}}_documentClickHandler(e){const t=this;(t.isInShadowDOM?e.composedPath()[0]:e.target).closest("smart-filter-builder")?t._clickHandler(e):(t._editorIsOpen&&!t._scrollBarDown&&t._closeEditor(),delete t._scrollBarDown)}_downHandler(e){const t=this;(t.shadowRoot||t.isInShadowDOM?e.composedPath()[0]:e.target).closest("smart-scroll-bar")?t._scrollBarDown=!0:delete t._scrollBarDown}_containerChangeHandler(e){e.stopPropagation()}_emptyElementsStructure(e){const t=this,a=t.$.contentContainer;for(;a.firstChild;)a.removeChild(a.firstChild);t._valueFlat=e?[]:t._valueFlat,t._lastProcessedItemInCurrentGroup={parentId:null,id:null,position:null}}_filterGroupRow(e){e=this.localize(e||"or");let t=document.createElement("div"),a=`<span class="smart-filter-delete-btn"></span>\n                <span class="filter-builder-item smart-filter-group-operation">${e}</span>\n                <span class="smart-filter-add-btn"></span>`;return t.className="smart-filter-group-operator",t.innerHTML=a,t.data=e||"or",t}_formatValueStringRepresentation(e,t){const a=this,i=a._getFieldByFieldName(t);let l;if(!i)return e;if((!e||0===e.length)&&"boolean"!==i.dataType&&"number"===i.dataType&&null===e||"string"===i.dataType&&(!e||0===e.length))return a.valuePlaceholder;switch(i.dataType){case"date":case"dateTime":e?((e=function(e){return 0===e||"number"==typeof e||"string"==typeof e||!0===e||""===e||"0"===e||Array.isArray(e)||"object"==typeof e&&e.constructor===Date?new Smart.Utilities.DateTime(e):e}(e)).calendar.days=a._localizedDays,e.calendar.months=a._localizedMonths,e.calendar.locale=a.locale,Smart.Utilities.DateTime.cache=[],l=e.toString("date"===i.dataType?a.formatStringDate:a.formatStringDateTime)):l=a.valuePlaceholder;break;case"array":l="string"==typeof e?e.split(","):e;break;case"object":l="string"==typeof e?e:JSON.stringify(e);break;case"number":l=e;break;case"boolean":l=!1===e?"false":"true";break;default:l=e+""}return a.valueFormatFunction?a.valueFormatFunction(l,t,i.dataType||"string"):l}_generateHTMLStructureFromFlatValue(){const e=this,t=document.createDocumentFragment();if(e._valueFlat&&0!==e._valueFlat.length)for(let a=0;a<e._valueFlat.length;a++){const i=e._valueFlat[a],l=!!e.customOperations&&e.customOperations.find((e=>e.name===i.data[1])),o=i.parentId?(e.shadowRoot||e).querySelector('[node-id="'+i.parentId+'"]').querySelector(".smart-filter-group-condition-container"):e.$.contentContainer;if("group"===i.type){const l=document.createElement("div"),o=e._filterGroupRow(i.data),r=document.createElement("div");l.className="smart-filter-group",r.className="smart-filter-group-condition-container",l.appendChild(o),l.appendChild(r),t.appendChild(l),l.setAttribute("node-id",i.nodeId),e._valueFlat[a].htmlNode=l,e._isMaxLevelExceeded(i.nodeId+".0")&&l.setAttribute("max-level","")}else{const o=e._newFilterConditionRow(i.data);o.setAttribute("node-id",i.nodeId),t.appendChild(o),e._valueFlat[a].htmlNode=o,(-1!==["isblank","isnotblank"].indexOf(i.data[1])||l&&l.hideValue)&&o.children[3].classList.add("smart-hidden")}o.appendChild(t)}}_generateValue(){const e=this;let t=[];!function(e){for(let a=0;a<e.length;a++){const i=e[a];let l={};"group"===i.type&&(l.nodeId=i.nodeId,l.parentId=i.parentId,l.structure=[i.data||"or"],t.push(l))}for(let a=0;a<t.length;a++){const i=t[a],l=e.filter((e=>e.parentId===i.nodeId&&"condition"===e.type));for(let e=0;e<l.length;e++)0===e?i.structure.unshift(l[e].data):i.structure.push(l[e].data)}t=t.filter((e=>e.structure.length>1)),t.sort((function(e,t){return t.nodeId.split(".").length-e.nodeId.split(".").length}));for(let e=0;e<t.length;e++){const a=t[e],i=t.filter((e=>e.nodeId===a.parentId))[0];i&&i.structure&&i.structure.push(a.structure)}}(e._valueFlat.slice()),t.length>0?e.value=e._valueFlat.length>1?t[t.length-1].structure:t:e.value=[e._getItemById("0").data];const a=JSON.stringify(e.value);e._oldValueAsString!==a&&(e._oldValueAsString=a,e.$.fireEvent("change",{value:JSON.parse(a)}))}_getFieldByFieldName(e){const t=this;return(t.fields?t.fields.filter((t=>t.dataField===e)):t._valueFields.filter((t=>t.dataField===e)))[0]||null}_getFieldsFromValue(){const e=this._valueFlat,t=[],a=[];for(let i=0;i<e.length;i++)if("condition"===e[i].type){const l=e[i].data[0];if(-1===t.indexOf(l)){const e={label:l,dataField:l,dataType:"string",format:null};t.push(l),a.push(e)}}this._valueFields=a}_getItemById(e,t){const a=this._valueFlat.filter((a=>t?a.parentId===e:a.nodeId===e));return a.length>0?a[0]:null}_handleContextMenu(e){const t=this;if(t._selectedElement===e&&t.$.conditionsMenu.opened)return;const a=e.getBoundingClientRect(),i=t.getBoundingClientRect(),l=a.height,o=a.left+t.$.contentContainer.scrollLeft-i.left,r=a.top+t.$.contentContainer.scrollTop-i.top+l;if(e.closest(".smart-filter-add-btn")&&t.restrictedMode){t._checkFieldsExistence();const e=t.fields?t.fields[0]:t._valueFields[0],a=e.filterOperations&&e.filterOperations.length>0?e.filterOperations[0]:"=";t._addElement("condition",0,[e.dataField,a,t._defaultValueByType(e.dataType)])}else t._closeEditor(),t.disableContextMenu?t._selectedElement=e:(t.$.conditionsMenu.dataSource=t._contextMenuOptions,t.$.conditionsMenu.open(o,r),t._selectedElement=e,t.$.scrollableContainer.refresh())}_handleCustomOperations(){const e=this;e._filterOperationDescriptions=e._defaultFilterOperationDescriptions;for(let t=0;t<e.customOperations.length;t++){const a=e.customOperations[t];e._filterOperationDescriptions.push({label:a.label,value:a.name,custom:!0,index:t,editorTemplate:a.editorTemplate,valueTemplate:a.valueTemplate,handleValue:a.handleValue,validateValue:a.validateValue})}}_initializeEditor(e){const t=this,a="smart-"+Smart.Utilities.Core.toDash(e),i=document.createElement(a);"numericTextBox"===e?(i.spinButtons=!0,i.inputFormat="floatingPoint"):"dateTimePicker"===e&&(i.calendarButton=!0,i.dropDownDisplayMode="auto",i.enableMouseWheelAction=!0,i.locale=t.locale,i.messages[t.locale]||(i.messages[t.locale]={}),i.messages[t.locale].dateTabLabel=t.localize("dateTabLabel"),i.messages[t.locale].timeTabLabel=t.localize("timeTabLabel")),i.tabIndex="1",i.theme=t.theme,i.animation=t.animation,t.$[e+"Editor"]=i,i.$=Smart.Utilities.Extend(i),i.className=a+"-editor smart-hidden",t.$.editorsContainer.appendChild(i),t["_"+e+"Initialized"]=!0}_innerContainerKeydownHandler(e){"Escape"!==e.key&&"Enter"!==e.key||!this._editorIsOpen||this._closeEditor()}_inputBlurHandler(){const e=this;let t;if(e._editor===e.$.dateTimePickerEditor)t=e._editor.value,t&&(t=t.toDate());else if(e._editor===e.$.checkBoxEditor)t=e._editor.checked;else if(e._editor===e.$.customEditor)t=e._selectedCustomCondition.handleValue(e._editor);else{const a=e._getFieldByFieldName(e._editedItem.data[0]);t="array"===a.dataType?e._editor.value.split(","):"object"===a.dataType?JSON.parse(e._editor.value):e._editor.value}const a=e._editedItem,i=a.nodeId,l=e._getFieldByFieldName(a.data[0]).dataType;e._updateValueInFlatArray(i,t,"value",l||"string"),e._generateValue()}_localizeInitialValues(){const e=this,t=Smart.Utilities.DateTime.getLocalizedNames(e.locale);e._addOptions=[{label:e.localize("addCondition"),value:"addCondition"},{label:e.localize("addGroup"),value:"addGroup"}],e._groupOperationDescriptions=[{label:e.localize("and"),value:"and"},{label:e.localize("notand"),value:"notand"},{label:e.localize("or"),value:"or"},{label:e.localize("notor"),value:"notor"}],e._defaultFilterOperationDescriptions=e._filterOperationDescriptions=[{label:e.localize("="),value:"=",custom:!1},{label:e.localize("<>"),value:"<>",custom:!1},{label:e.localize(">"),value:">",custom:!1},{label:e.localize(">="),value:">=",custom:!1},{label:e.localize("<"),value:"<",custom:!1},{label:e.localize("<="),value:"<=",custom:!1},{label:e.localize("startswith"),value:"startswith",custom:!1},{label:e.localize("endswith"),value:"endswith",custom:!1},{label:e.localize("contains"),value:"contains",custom:!1},{label:e.localize("notcontains"),value:"notcontains",custom:!1},{label:e.localize("isblank"),value:"isblank",custom:!1},{label:e.localize("isnotblank"),value:"isnotblank",custom:!1}],e._localizedDays=t.days,e._localizedMonths=t.months}_mapFieldsToMenu(){const e=this;(e.fields||e._valueFields)&&(e._fields=(e.fields||e._valueFields).map((e=>{let t={};return t.label=e.label,t.value=e.dataField,t.dataType=e.dataType,t})))}_menuItemClickHandler(e){const t=this,a=t._selectedElement.closest(".filter-builder-item"),i=e.detail,l=i.value,o=t.localize(l)||i.label;if(a){const e=a.closest(".smart-filter-group-condition"),i=a.closest(".smart-filter-group"),r=e?e.getAttribute("node-id"):i.getAttribute("node-id");let n=2;if(a.innerHTML=o,a.value=l,t._editedItem&&a.classList.contains("smart-filter-field-name")&&t._editedItem.data[0]!==l){const e=a.parentNode.querySelector(".smart-filter-value"),i=t.customOperations.map((e=>{if(e.hideValue)return e.name})).filter((e=>e)).concat(["isblank","isnotblank"]);t._clearConditionsValue(r,l),t._setInitialFilterOperation(r,l),i.indexOf(l)>-1?e.classList.add("smart-hidden"):e.classList.remove("smart-hidden")}if(a.classList.contains("smart-filter-field-name"))n=0;else if(a.classList.contains("smart-filter-operation")){const e=a.parentNode.querySelector(".smart-filter-value");let i;if(t.customOperations){const e=t.customOperations.filter((e=>e.name===l));e.length>0&&(i=e[0])}["isblank","isnotblank"].indexOf(l)>-1||i&&i.hideValue?(t._clearConditionsValue(r),e.classList.add("smart-hidden")):e.classList.remove("smart-hidden"),n=1}else if(a.classList.contains("smart-filter-group-operation")){for(let e=0;e<t._valueFlat.length;e++)t._valueFlat[e].nodeId===r&&(t._valueFlat[e].data=a.value);return t._generateValue(),void t.$.scrollableContainer.refresh()}for(let e=0;e<t._valueFlat.length;e++)t._valueFlat[e].nodeId===r&&(t._valueFlat[e].data[n]=a.value);return t._generateValue(),void t.$.scrollableContainer.refresh()}const r=t._selectedElement.closest(".smart-filter-group").getAttribute("node-id");if(!t._isMaxLevelExceeded(r+".0")){if("addCondition"===l&&(t.maxConditions&&t._totalConditions<t.maxConditions||!t.maxConditions)){t._checkFieldsExistence();const e=t.fields?t.fields[0]:t._valueFields[0],a=e.filterOperations&&e.filterOperations.length>0?e.filterOperations[0]:"=";t._addElement("condition",r,[e.dataField,a,t._defaultValueByType(e.dataType)])}else"addGroup"===l&&t._addElement("group",r,"and");t.$.scrollableContainer.refresh()}}_setInitialFilterOperation(e,t){const a=this,i=a.fields.find((e=>e.dataField===t)),l=a._valueFlat.find((t=>t.nodeId===e)),o=l.htmlNode.getElementsByClassName("smart-filter-operation")[0],r=i&&i.filterOperations&&i.filterOperations.length>0?i.filterOperations[0]:"=";let n=a.localize(r);n||(n=a.customOperations.find((e=>e.name===r)).label),l.data[1]=r,o.innerHTML=n}_checkFieldsExistence(){const e=this;e.fields&&0!==e.fields.length||e._valueFields&&0!==e._valueFields.length||e.error(e.localize("missingFields",{elementType:e.nodeName.toLowerCase()}))}_newFilterConditionRow(e){const t=this,a=(e=e||[])[0]?e[0]:t.fields[0].dataField,i=t._formatValueStringRepresentation(e[2],e[0]),l=t.fields?t.fields.filter((e=>e.dataField===a)):t._valueFields.filter((e=>e.dataField===a)),o=l.length>0?l[0].label:e[0];let r=t.localize(e[1]);!r&&t.customOperations&&t.customOperations.length>0&&(r=t.customOperations.find((t=>t.name===e[1])).label);let n=document.createElement("div"),s=`<span class="smart-filter-delete-btn"></span>\n                <span class="filter-builder-item smart-filter-field-name">${o}</span>\n                <span class="filter-builder-item smart-filter-operation">${r||""}</span>\n                <span class="filter-builder-item smart-filter-value"><span class="smart-value-container">${i}</span></span>`;return n.className="smart-filter-group-condition",n.innerHTML=s,n}_openEditor(e){const t=this,a=e&&e.closest(".smart-filter-group-condition")?e.closest(".smart-filter-group-condition").getAttribute("node-id"):null,i=e.closest(".smart-filter-value"),l=t._getItemById(a),o=l.data[0]||t.fields[0].dataField||t._valueFields[0].dataField,r=t._getFieldByFieldName(o);let n;if(l?(n=l.data[2],void 0===n&&(n="")):n="",!r)return;t._editorIsOpen&&t._closeEditor(),t.$.conditionsMenu.opened&&t.$.conditionsMenu.close(),i.setAttribute("edited",""),t._editedItem=l;const s=(t.fields||t._valueFields).filter((e=>e.dataField===o)),d=t._filterOperationDescriptions.filter((e=>e.value===l.data[1]&&e.custom)),c=s.length>0?s[0]:null,u=r.lookup&&r.lookup.dataSource?"lookup":c.dataType;0!==d.length&&d[0].editorTemplate?(t._selectedCustomCondition=d[0],t._openCustomEditor(u,n,r)):t._openEditorByFieldType(u,n,r),t.$.fireEvent("editorOpening",{value:n,type:u,editedItem:l}),setTimeout((function(){t._editor.focus(),t._editor!==t.$.numericTextBoxEditor&&t._editor!==t.$.textBoxEditor||(t.$.scrollableContainer.scrollLeft=t.$.scrollableContainer.$.scrollViewerContainer.scrollLeft,t.$.scrollableContainer.scrollTop=t.$.scrollableContainer.$.scrollViewerContainer.oldTop,t.$.scrollableContainer.$.scrollViewerContainer.scrollLeft=0,t.$.scrollableContainer.$.scrollViewerContainer.scrollTop=0,t._editor.$.input.selectionStart=t._editor.$.input.selectionEnd=t._editor.$.input.value.length),t.$.scrollableContainer.refresh(),t.$.fireEvent("editorOpen",{value:n,type:u,editedItem:l})}),0),t._editor.classList.remove("smart-hidden"),t._editorIsOpen=!0,t.$.editorsContainer.setAttribute("open",""),i.appendChild(t.$.editorsContainer),t.$.scrollableContainer.refresh()}_openEditorByFieldType(e,t,a){const i=this;switch(e){case"lookup":i._comboBoxInitialized||i._initializeEditor("comboBox"),i._editor=i.$.comboBoxEditor,i._editor.dataSource=a.lookup.dataSource,i._editor.dropDownAppendTo=i.$.container,i._editor.selectedValues=[t];break;case"boolean":i._checkBoxInitialized||i._initializeEditor("checkBox"),i._editor=i.$.checkBoxEditor,i._editor.checked=!!t;break;case"dateTime":i._dateTimePickerInitialized||i._initializeEditor("dateTimePicker"),i._editor=i.$.dateTimePickerEditor,i._editor.formatString=i.formatStringDateTime,i._editor.dropDownAppendTo=i.$.container,i._editor.value=t;break;case"date":i._dateTimePickerInitialized||i._initializeEditor("dateTimePicker"),i._editor=i.$.dateTimePickerEditor,i._editor.formatString=i.formatStringDate,i._editor.dropDownAppendTo=i.$.container,i._editor.value=t;break;case"number":i._numericTextBoxInitialized||i._initializeEditor("numericTextBox"),t=t||0,i._editor=i.$.numericTextBoxEditor,i._editor.value=t;break;case"array":i._textBoxInitialized||i._initializeEditor("textBox"),i._editor=i.$.textBoxEditor,i._editor.value=t.toString();break;case"object":i._textBoxInitialized||i._initializeEditor("textBox"),t=t||{},i._editor=i.$.textBoxEditor,i._editor.value=JSON.stringify(t);break;default:i._textBoxInitialized||i._initializeEditor("textBox"),i._editor=i.$.textBoxEditor,i._editor.value=t+""}}_openCustomEditor(e,t,a){const i=this,l=i.customOperations[i._selectedCustomCondition.index].editorTemplate(e,t,a);i.$.customEditor.innerHTML="",l&&i.$.customEditor.appendChild(l),i._editor=i.$.customEditor}_refresh(){const e=this;e._generateValue(),e._emptyElementsStructure(),e._generateHTMLStructureFromFlatValue(),e.$.scrollableContainer.refresh()}refresh(){const e=this;e._setInitialValues(),e._handleCustomOperations(),e._applyValue(),e._refresh()}_resizeHandler(){this.$.scrollableContainer.refresh()}_scrollViewerWheelHandler(e){"wheel"===e.type&&this.$.scrollableContainer.scrollHeight&&(e.stopPropagation(),e.preventDefault())}_setInitialValues(){const e=this;e._mapFieldsToMenu(),e._localizeInitialValues(),e.$.conditionsMenu.dropDownAppendTo=e.$.container,e.$.conditionsMenu.dataSource=e._groupOperationDescriptions,e._valueFlat=[],e._lastProcessedItemInCurrentGroup={parentId:null,id:null,position:null}}_updatePlaceholder(){const e=this;for(let t=0;t<e._valueFlat.length;t++){const a=e._valueFlat[t];"condition"!==a.type||null!==a.data[2]&&""!==a.data[2]||(a.htmlNode.querySelector(".smart-value-container").innerHTML=e.valuePlaceholder)}e.$.textBoxEditor&&(e.$.textBoxEditor.placeholder=e.valuePlaceholder)}_updateValueInFlatArray(e,t,a,i){const l=this;if(e&&!l.disabled){if(i=i||"string",a=a||"value",null!==t)switch(i){case"number":t=parseFloat(t);break;case"boolean":t=!!t;break;case"string":t+=""}for(let i=0;i<l._valueFlat.length;i++)if(l._valueFlat[i].nodeId===e)switch(a){case"column":l._valueFlat[i].data[0]=t;break;case"filterCondition":l._valueFlat[i].data[1]=t;break;case"value":l._valueFlat[i].data[2]=t;break;case"groupCondition":l._valueFlat[i].data=t}}}_validateNode(e,t){const a=this;let i;return e instanceof HTMLElement?i=a._getItemById(e.getAttribute("node-id")):"string"==typeof e?i=a._getItemById(e):a.error(a.localize("wrongElementNode",{elementType:a.nodeName.toLowerCase(),method:t})),i||a.error(a.localize("wrongElementNode",{elementType:a.nodeName.toLowerCase(),method:t})),i}_validateUserData(e,t){const a=this;if(t)(!Array.isArray(e)||e.length<3)&&a.error(a.localize("invalidDataStructure",{elementType:a.nodeName.toLowerCase()}));else{const t=/^(and|or|notAnd|notOr)$/i;"string"==typeof e&&e.match(t)||a.error(a.localize("invalidDataStructure",{elementType:a.nodeName.toLowerCase()}))}}_validateValue(){const e=this,t=e.maxConditions,a=e.maxConditionsPerGroup,i=e.maxLevel;let l=0;if(null===t&&null===a&&null===i)return;const o=[];!function e(o,r,n){let s=0;o.forEach((o=>{if(Array.isArray(o))if(function(e){return 3===e.length&&"string"==typeof e[0]&&"string"==typeof e[1]}(o)){if(null!==t&&t===l||null!==a&&a===s)return;n.push(o),s++,l++}else{if(null!==i&&i===r+1)return;const t=[];n.push(t),e(o,r+1,t)}else n.push(o)}))}(e.value,0,o),e.value=o}}),Smart("smart-query-builder",class extends Smart.BaseElement{static get properties(){return{allowDrag:{value:!1,type:"boolean"},autoPrompt:{value:!1,type:"boolean"},applyMode:{allowValues:["immediately","change"],value:"change",type:"string"},customOperations:{value:[],type:"array",reflectToAttribute:!1},customOperators:{value:{},type:"object",reflectToAttribute:!1},dropDownWidth:{type:"any",value:"100%"},fields:{value:null,type:"array?",reflectToAttribute:!1},fieldsMode:{value:"dynamic",allowedValues:["dynamic","static"],type:"string"},formatStringDate:{value:"dd-MMM-yy",type:"string"},formatStringDateTime:{value:"dd-MMM-yy HH:mm:ss",type:"string"},getDynamicField:{value:null,type:"function?"},icons:{value:{"=":"equals","<>":"notequals",">":"greaterthan",">=":"greaterthanorequal","<":"lessthan","<=":"lessthanorequal",startswith:"startswith",endswith:"endswith",contains:"contains",notcontains:"notcontains",isblank:"isblank",isnotblank:"isnotblank"},type:"object",reflectToAttribute:!1},messages:{value:{en:{add:"Add",addCondition:"Add Condition",addGroup:"Add Group",and:"And",notand:"Not And",or:"Or",notor:"Not Or","=":"Equals","<>":"Does not equal",">":"Greater than",">=":"Greater than or equal to","<":"Less than","<=":"Less than or equal to",startswith:"Starts with",endswith:"Ends with",contains:"Contains",notcontains:"Does not contain",isblank:"Is blank",isnotblank:"Is not blank",wrongParentGroupIndex:'{{elementType}}: Wrong parent group index in "{{method}}" method.',wrongElementNode:'{{elementType}}: Incorect node / node Id in "{{method}}" method.',invalidDataStructure:"{{elementType}}: Used invalid data structure in updateCondition/updateGroup method.",dateTabLabel:"DATE",timeTabLabel:"TIME",queryLabel:"Query"}},type:"object",extend:!0},operatorPlaceholder:{value:"Operator",type:"string"},propertyPlaceholder:{value:"Property",type:"string"},showIcons:{value:!1,type:"boolean"},showFieldNameArrow:{value:!1,type:"boolean"},value:{value:[],type:"any",reflectToAttribute:!1},valueFormatFunction:{value:null,type:"function?",reflectToAttribute:!1},valuePlaceholder:{value:"Value",type:"string"}}}static get requires(){const e={"Smart.Button":"smart.button.js","Smart.Calendar":"smart.calendar.js","Smart.CheckBox":"smart.checkbox.js","Smart.DateTimePicker":"smart.datetimepicker.js","Smart.DropDownList":"smart.dropdownlist.js","Smart.Input":"smart.input.js","Smart.ListBox":"smart.listbox.js","Smart.Menu":"smart.menu.js","Smart.NumericTextBox":"smart.numerictextbox.js","Smart.ScrollBar":"smart.scrollbar.js","Smart.TimePicker":"smart.timepicker.js","Smart.Tooltip":"smart.tooltip.js","Smart.Utilities.BigNumber":"smart.math.js","Smart.Utilities.DateTime":"smart.date.js","Smart.Utilities.Draw":"smart.draw.js","Smart.Utilities.NumericProcessor":"smart.numeric.js"};return window.NIComplex||(e["Smart.Utilities.Complex"]="smart.complex.js"),e}static get listeners(){return{down:"_downHandler",resize:"_resizeHandler","editorsContainer.keydown":"_innerContainerKeydownHandler","conditionsMenu.close":"_menuCloseHandler","conditionsMenu.closing":"_menuClosingHandler","conditionsMenu.itemClick":"_menuItemClickHandler","contentContainer.change":"_contentContainerChangeHandler","scrollableContainer.touchmove":"_scrollableContainerTouchmoveHandler","document.down":"_documentDownHandler","document.move":"_documentMoveHandler","document.up":"_documentUpHandler"}}static get styleUrls(){return["smart.querybuilder.css"]}template(){return'<div id="container" role="presentation">\n                    <smart-scroll-viewer id="scrollableContainer" class="smart-scrollable-container" animation="[[animation]]" right-to-left="[[rightToLeft]]">\n                        <div id="queryLabel" class="smart-query-builder-label smart-unselectable"></div>\n                        <div id="contentContainer" class="smart-content-container"></div>\n                    </smart-scroll-viewer>\n                    <div id="editorsContainer" class="smart-editors-container" role="presentation">\n                        <div id="customEditor" class="smart-custom-editor smart-hidden"></div>\n                    </div>\n                    <smart-menu id="conditionsMenu" mode="dropDown" class="smart-conditions-menu" theme="[[theme]]" animation="[[animation]]" right-to-left="[[rightToLeft]]"></smart-menu>\n                </div>'}propertyChangedHandler(e,t,a){super.propertyChangedHandler(e,t,a);const i=this;switch(e){case"animation":case"theme":["textBoxEditor","numericTextBoxEditor","comboBoxEditor","dateTimePickerEditor","checkBoxEditor"].forEach((t=>i.$[t]&&(i.$[t][e]=a)));break;case"formatStringDate":case"formatStringDateTime":case"valueFormatFunction":i._refresh();break;case"operatorPlaceholder":Array.from((i.shadowRoot||i).querySelectorAll(".smart-filter-operation[placeholder]")).forEach((e=>e.firstElementChild.innerHTML=a));break;case"propertyPlaceholder":Array.from((i.shadowRoot||i).querySelectorAll(".smart-filter-field-name[placeholder]")).forEach((e=>e.firstElementChild.innerHTML=a));break;case"showIcons":i._closeEditor(),a?i._filterOperationDescriptions.map((e=>e.icon=i.icons[e.value])):i._filterOperationDescriptions.map((e=>delete e.icon));break;case"customOperations":case"fields":case"value":{const t=JSON.stringify(i._validValue),l=i._queryParser;"customOperations"===e?i._handleCustomOperations():""===e&&i._mapFieldsToMenu(),i._applyValue(),"customOperations"!==e&&"fields"!==e||(l[e]=a),i._oldValueAsString!==t&&(i._oldValueAsString=t,i.$.fireEvent("change",{value:JSON.parse(t),linq:l.toLinq(i._validValue)}));break}case"valuePlaceholder":Array.from((i.shadowRoot||i).querySelectorAll(".smart-filter-value[placeholder]")).forEach((e=>e.firstElementChild.innerHTML=a));break;case"locale":case"messages":i._localizeInitialValues(),i._refresh(),i._handleCustomOperations(),i.$.dateTimePickerEditor&&(i.$.dateTimePickerEditor.messages[i.locale]||(i.$.dateTimePickerEditor.messages[i.locale]={}),i.$.dateTimePickerEditor.messages[i.locale].dateTabLabel=i.localize("dateTabLabel"),i.$.dateTimePickerEditor.messages[i.locale].timeTabLabel=i.localize("timeTabLabel"),"locale"===e?i.$.dateTimePickerEditor.locale=i.locale:"messages"===e&&(i.$.dateTimePickerEditor.$.selectDate.innerHTML=i.$.dateTimePickerEditor.messages[i.locale].dateTabLabel,i.$.dateTimePickerEditor.$.selectTime.innerHTML=i.$.dateTimePickerEditor.messages[i.locale].timeTabLabel));break;case"icons":i._closeEditor()}}ready(){super.ready();const e=this;e.$.queryLabel.id||(e.$.queryLabel.id=e.id+"Label"),e.setAttribute("role","dialog"),e.setAttribute("aria-labelledby",e.$.queryLabel.id),-1!==navigator.platform.toLowerCase().lastIndexOf("mac")&&e.$.contentContainer.classList.add("mac"),e._queryParser=new Smart.Utilities.QueryParser,e._setInitialValues(),e._handleCustomOperations(),e._applyValue(),Object.defineProperty(e,"value",{get:function(){return e.context===e?e.properties.value.value:e._validValue},set(t){e.updateProperty(e,e._properties.value,t)}})}getLinq(){const e=this;if(e._validValue)return e._queryParser.toLinq(e._validValue)}get validationStatus(){const e=this;return!e.isReady||void 0===e._validationStatus||e._validationStatus}_setInitialValues(){const e=this;e._autoScrollCoefficient=Smart.Utilities.Core.Browser.Firefox?4:Smart.Utilities.Core.Browser.Edge?8:2,e._isMobile=Smart.Utilities.Core.isMobile,e._manuallyAddedFields=[],e._localizeInitialValues(),e.$.conditionsMenu.dropDownAppendTo=e.$.container,e.$.conditionsMenu.dataSource=e._groupOperationDescriptions,e._valueFlat=[],e._lastProcessedItemInCurrentGroup={parentId:null,id:null,position:null}}_applyValue(){const e=this;e._emptyElementsStructure(!0),e._validateValue(),e._convertValueToFlat(e.value),e._getFieldsFromValue(),e._mapFieldsToMenu(),e._validateValueByType(),e._generateHTMLStructureFromFlatValue(!0),e._restrictNesting(),e._validValue=e._getValidValue(),e._oldValueAsString=JSON.stringify(e._validValue)}_validateValueByType(){const e=this;if(!e._valueFlat||!e._valueFlat.length)return;const t=e._valueFlat;for(let a=0;a<t.length;a++){const i=t[a];if("condition"!==i.type)continue;const l=i.data[0];!l||i.data.length<3||(i.data[2]=e._validateStoredValue(i.data[2],l))}e._generateValue(!0)}_setRequiredFields(){const e=this;if(!e.requiredFields||!e.requiredFields.length)return;const t=e.value;let a=[];for(let i=0;i<e.requiredFields.length;i++){const l=e.requiredFields[i],o=e.fields.find((e=>e.dataField===l));if(o){let e=[];if(t){let a=0;for(;a<t.length;){const i=t[a];if(Array.isArray(i)){let t=0;for(;t<i.length;){let a=i[t];a&&a[0]===o.dataField?(e.push(a),i.splice(t>0?t-1:t,2)):t++}}i.length?a++:t.splice(a,2)}}if(e)for(let t=0;t<e.length;t++)a.push(e[t]),a.push("and");else a.push([l]),a.push("and")}}"string"==typeof a[a.length-1]&&a.pop(),e.value.unshift(a,"and")}_contentContainerChangeHandler(e){const t=this,a=e.target,i=t.applyMode;if(e.stopPropagation(),"immediately"!==i||!t._editorIsOpen||!t._editor||"immediately"===i&&a!==t._editor)return;const l=t._editor.closest(".filter-builder-item");l.classList.contains("smart-filter-value")||(t._closeEditor(),t._handleAutoPrompt(l))}_handleAutoPrompt(e){const t=this;if(e&&t.autoPrompt&&"immediately"===t.applyMode&&!e.classList.contains("smart-filter-value")){const a=e.closest(".smart-filter-group-condition")||e.closest(".smart-filter-nested-operator")||e.closest(".smart-filter-group");if(!a)return;const i=t._getItemById(a.getAttribute("node-id")),l=a.querySelector(".smart-filter-value");if(!i||!l)return;t._clickHandlerFilterButton(e.classList,i.nodeId,l)}}_mapFieldsToMenu(){const e=this;(e.fields||e._valueFields)&&(e._fields=(e.fields||e._valueFields).concat(e._manuallyAddedFields).map((e=>({label:e.label,value:e.dataField,dataType:e.dataType,filterOperations:e.filterOperations,lookup:e.lookup}))))}_localizeInitialValues(){const e=this;e.$.queryLabel.innerHTML=e.localize("queryLabel"),e._addOptions=[{label:e.localize("addCondition"),value:"addCondition"},{label:e.localize("addGroup"),value:"addGroup"}],e._groupOperationDescriptions=[{label:e.localize("and"),value:"and"},{label:e.localize("or"),value:"or"}],e._defaultFilterOperationDescriptions=e._filterOperationDescriptions=[{label:e.localize("="),value:"=",custom:!1},{label:e.localize("<>"),value:"<>",custom:!1},{label:e.localize(">"),value:">",custom:!1},{label:e.localize(">="),value:">=",custom:!1},{label:e.localize("<"),value:"<",custom:!1},{label:e.localize("<="),value:"<=",custom:!1},{label:e.localize("startswith"),value:"startswith",custom:!1},{label:e.localize("endswith"),value:"endswith",custom:!1},{label:e.localize("contains"),value:"contains",custom:!1},{label:e.localize("notcontains"),value:"notcontains",custom:!1},{label:e.localize("isblank"),value:"isblank",custom:!1},{label:e.localize("isnotblank"),value:"isnotblank",custom:!1}];const t=Smart.Utilities.DateTime.getLocalizedNames(e.locale);e._localizedDays=t.days,e._localizedMonths=t.months}_handleCustomOperations(){const e=this;e._filterOperationDescriptions=e._defaultFilterOperationDescriptions.slice(0);for(let t=0;t<e.customOperations.length;t++){let a=e.customOperations[t],i=e._filterOperationDescriptions.findIndex((e=>e.value===a.name)),l={label:a.label,value:a.name,custom:!0,index:t,editorTemplate:a.editorTemplate,valueTemplate:a.valueTemplate,handleValue:a.handleValue,hideValue:a.hideValue,validateValue:a.validateValue};i>-1?e._filterOperationDescriptions[i]=l:e._filterOperationDescriptions.push(l)}}_innerContainerKeydownHandler(e){const t=this;if(t._editorIsOpen&&("Escape"===e.key||"Enter"===e.key)){t._closeEditor();const e=t._editor.closest(".filter-builder-item");e&&!e.classList.contains("smart-filter-value")&&t._handleAutoPrompt(e)}}_documentDownHandler(e){const t=this,a=t.shadowRoot||t.isInShadowDOM?e.originalEvent.composedPath()[0]:e.originalEvent.target;if(a.shadowParent&&a.shadowParent.closest(".smart-input-drop-down-menu")||a.closest(".smart-input-drop-down-menu")||t.$.conditionsMenu.contains(a))return;const i=a.closest(".smart-drop-down");if(a.getRootNode().host===t||a.closest("smart-query-builder")===t||i&&t.contains(i.ownerElement))if(t._isMobile){const a=t.$.scrollableContainer.scrollTop,i=t.getBoundingClientRect().top;setTimeout((function(){if(t.$.scrollableContainer.scrollTop===a&&t.getBoundingClientRect().top===i){const a=t.context;t.context=t,t._clickHandler(e.originalEvent),t.context=a}}),250)}else t._clickHandler(e.originalEvent);else t._editorIsOpen&&!t._scrollBarDown&&t._closeEditor(),delete t._scrollBarDown}_emptyElementsStructure(e){const t=this,a=t.$.contentContainer;for(;a.firstChild;)a.removeChild(a.firstChild);t._valueFlat=e?[]:t._valueFlat,t._lastProcessedItemInCurrentGroup={parentId:null,id:null,position:null}}_resizeHandler(){this.$.scrollableContainer.refresh()}_getTotalConditions(){return this.getElementsByClassName("smart-filter-group-condition").length}_parseLinqToValue(){const e=this,t=e._queryParser;t&&(t.customOperations=e.customOperations,t.fields=e.fields,t.dynamicField="dynamic"===e.fieldsMode?e.getDynamicField:void 0,e.set("value",t.toValue(e.value)))}_validateValue(){const e=this;"string"==typeof e.value&&e._parseLinqToValue();const t=e.value;if(Array.isArray(t)&&""!==JSON.stringify(t).replace(/[\[\]]/g,"")){for(3===t.length&&"string"==typeof t[0]&&(e.value=[[t]]),Array.isArray(t[0])&&3===t[0].length&&"string"==typeof t[0][0]&&(e.value=[t]);"string"==typeof t[0];)t.shift();for(;"string"==typeof t[t.length-1];)t.pop();e.value.forEach((e=>{Array.isArray(e)&&0===e.length&&e.push([])}))}else e.value=[[[]]]}_convertValueToFlat(e){const t=this,a=["and","or","notAnd","notOr"];if(!e)return;let i=0,l=0;t._valueFlat=[],function e(o,r){let n;for(let s=0;s<o.length;s++){const d=o[s];let c={htmlNode:null};if("string"==typeof d&&(a.indexOf(d)>-1||t.customOperators[d]))n=(t.customOperators[d]||d).trim();else if(n=n||"and",Array.isArray(d)){let a=t._valueFlat.filter((e=>e.parentId+""==r+"")).length;if(d.find((e=>Array.isArray(e))))c.nodeId=(l+=1)+"",c.type="group",c.data=n,t._valueFlat.push(c),e(d,c.nodeId),n="";else{if(t.maxConditions&&i>=t.maxConditions||t.maxConditionsPerGroup&&a>=t.maxConditionsPerGroup)continue;0!==s&&(t._valueFlat.push({nodeId:r+"."+a,type:"operator",data:n,parentId:r+""}),n="",a++),c.nodeId=r+"."+a,c.parentId=r+"",c.type="condition",c.data=d,i++,t._valueFlat.push(c)}}}}(e,0),delete t._totalGroups}_getFieldsFromValue(){const e=this._valueFlat,t=[],a=[];for(let l=0;l<e.length;l++){const o=e[l];if("condition"===o.type){const e=o.data[0];if(e&&-1===t.indexOf(e)){const l={label:e,dataField:e,dataType:(i=o.data[2],"boolean"==typeof i?"boolean":i instanceof Date?i.getHours()>0||i.getMinutes()>0||i.getSeconds()>0?"dateTime":"date":isNaN(i)?"string":"number"),format:null};t.push(e),a.push(l)}}}var i;this._valueFields=a}_addElement(e,t,a,i){const l=this,o=l._valueFlat.filter((e=>e.parentId===t));let r=0,n="";if(a=a||("group"===e?"or":[]),o.length){let e=o.map((e=>{const t=e.nodeId.split(".");return parseInt(t[t.length-1])}));e=0===e.length?[0]:e,r=e.reduce(((e,t)=>Math.max(e,t)))+1}t&&t.length>0&&(n=".");let s=(t||"")+n+("group"===e?l._valueFlat.filter((e=>"group"===e.type)).length+1:r),d=o[0];if(o.length)for(let e=0;e<o.length;e++){const t=o[e],a=t.nodeId.split(".").pop();parseInt(a)>parseInt(d.nodeId.split(".").pop())&&(d=t)}else d=l._valueFlat.find((e=>e.nodeId===t));let c=d?l._valueFlat.indexOf(d)+1:l._valueFlat.length;"condition"===e&&o.length>0&&(l._valueFlat.splice(c,0,{nodeId:s,parentId:t,type:"operator",data:["and"],htmlNode:null}),s=(t||"")+n+(r+1),c++);const u={nodeId:s,parentId:t,type:e,data:a,htmlNode:null},m=l.autoPrompt;if("condition"===e&&m&&l._fields.length){const e=l._fields[0];if(e){const t=l._getFilterOperations(e);a[0]=e.value||e.label||"",t.length&&(a[1]=t[0].value)}}if(l._valueFlat.splice(c,0,u),"group"===e&&l._addElement("condition",s,[],!0),!i&&(l._refresh(),m&&u.htmlNode)){const e=u.htmlNode,t=e.querySelector(".smart-filter-value");t&&l._clickHandlerFilterButton(e.classList,u.nodeId,t)}}_deleteElement(e,t){const a=this,i="string"==typeof e?e:e.getAttribute("node-id");if(i&&1!==i.length&&("group"===t?r(i):o(i),!t||"condition"===t)){let e=i.split(".");if(e.pop(),e=e.join("."),!a._valueFlat.filter((t=>t.parentId===e)).length&&(a._valueFlat.filter((e=>"group"===e.type)).length>1&&r(e),"0"===e)){const e=a._valueFlat.find((e=>"group"===e.type)),t=e.nodeId;e.nodeId="0",e.htmlNode.setAttribute("node-id","0");const i=a._valueFlat.filter((e=>e.parentId===t));for(let e=0;e<i.length;e++){const t=i[e];t.parentId="0",t.nodeId="0."+e,t.htmlNode.setAttribute("node-id",t.nodeId)}}a._generateValue()}function l(e){const t=a._valueFlat[e];if(t&&"operator"===t.type)return a._valueFlat.splice(e,1),t.htmlNode.parentElement.removeChild(t.htmlNode),!0}function o(e){let t,i=0,o=e.split(".");o.pop(),o=o.join(".");for(let l=0;l<a._valueFlat.length;l++){const r=a._valueFlat[l];if("condition"===r.type){if(r.nodeId===e){t=r;break}r.parentId===o&&i++}}const r=a._valueFlat.indexOf(t);a._valueFlat.splice(r,1),t.htmlNode.parentElement.removeChild(t.htmlNode);const n=l(r-1);i||l(r-(n?1:0));const s=a._valueFlat.filter((e=>e.nodeId===o))[0].htmlNode;s.children[1].childElementCount>0&&s.children[2].hasAttribute("limit-selection")&&!s.children[1].lastElementChild.hasAttribute("limit-selection")&&s.children[2].removeAttribute("limit-selection")}function r(e){const t=a._valueFlat.filter((t=>e===t.nodeId&&"group"===t.type))[0];for(let t=0;t<a._valueFlat.length;t++){const i=a._valueFlat[t],l=i.nodeId;i.parentId===e&&("group"===i.type?r(l):o(l))}a._valueFlat.indexOf(t)>-1&&a._valueFlat.splice(a._valueFlat.indexOf(t),1),t.htmlNode.parentElement.removeChild(t.htmlNode)}}_generateHTMLStructureFromFlatValue(e){const t=this,a=document.createDocumentFragment();if(t._valueFlat&&0!==t._valueFlat.length){for(let e=0;e<t._valueFlat.length;e++){const i=t._valueFlat[e],l=!!t.customOperations&&t.customOperations.find((e=>e.name===i.data[1])),o=i.parentId?(t.shadowRoot||t).querySelector('[node-id="'+i.parentId+'"]').querySelector(".smart-filter-group-condition-container"):t.$.contentContainer;if("group"===i.type){const l=document.createElement("div"),o=t.localize(i.data)||"";l.className="smart-filter-group",l.innerHTML='<div class="smart-filter-group-operator" role="button" aria-expanded="false" aria-haspopup="menu">'+o+'</div><div class="smart-filter-group-condition-container" role="group"></div><div class="smart-filter-add-condition-btn" role="button" aria-label="Add condition"><div>'+t.localize("add")+'</div></div><div class="smart-filter-add-btn" role="button" aria-expanded="false" aria-haspopup="menu" aria-label="Add group"></div>',l.firstElementChild.data=o,a.appendChild(l),l.setAttribute("node-id",i.nodeId),t._valueFlat[e].htmlNode=l}else if("condition"===i.type){const o=t._newFilterConditionRow(i.data);if(o.setAttribute("node-id",i.nodeId),a.appendChild(o),t._valueFlat[e].htmlNode=o,void 0!==i.data[0]&&void 0===i.data[1]){const e=t._getFilterOperations(t._fields.find((e=>e.value===i.data[0])));t._handleOnlyOperation(e,i.data,o)}else(-1!==["isblank","isnotblank"].indexOf(i.data[1])||l&&l.hideValue)&&(i.data.splice(2,1),o.children[2].classList.add("smart-visibility-hidden"))}else{const l=document.createElement("div");l.className="smart-filter-nested-operator",l.setAttribute("node-id",i.nodeId),l.setAttribute("role","button"),l.setAttribute("aria-expanded",!1),l.setAttribute("aria-haspopup","menu"),l.innerHTML=t.localize(i.data),a.appendChild(l),t._valueFlat[e].htmlNode=l}o.appendChild(a)}e&&t._validateValueAdvanced(),t.$.scrollableContainer.refresh()}}_validateValueAdvanced(){const e=this,t=e.value;let a=!1,i=!1,l=0;for(let e=0;e<t.length;e++){const o=t[e];if("string"!=typeof o)for(let e=o.length-1;e>=0;e--){let t=o[e];if(Array.isArray(t)&&0===t.length&&e!==o.length-1)o.splice(e,1),0===e&&o.splice(0,1),a=!0;else if("string"==typeof t){t=t.toLowerCase(),l++,(l>1||"and"!==t&&"or"!==t)&&(i=!0);continue}l=0}}a&&(e._emptyElementsStructure(!0),e._convertValueToFlat(e.value),e._generateHTMLStructureFromFlatValue()),i&&e._generateValue(!0)}_restrictNesting(){Array.from(this.getElementsByClassName("smart-filter-add-condition-btn")).forEach((e=>{const t=e.previousElementSibling.lastElementChild;t&&t.hasAttribute("limit-selection")&&e.setAttribute("limit-selection","")}))}_clickHandler(e){const t=this,a=t.shadowRoot||t.isInShadowDOM?e.composedPath()[0]:e.target;if(t.disabled||!a||!a.closest||!t._isMobile&&0!==e.button)return;if(t._scrollBarDown)return void delete t._scrollBarDown;const i=a.closest(".smart-drop-down"),l=t._editor&&t._editor.contains(a)||i&&(t._editor.contains(i.ownerElement)||t._editor===i.ownerElement)||a.closest(".smart-custom-editor");t._editor&&t._editorIsOpen&&!l&&t._closeEditor();const o=a.closest(".smart-filter-group-condition")||a.closest(".smart-filter-nested-operator")||a.closest(".smart-filter-group");if(!o)return;const r=t._getItemById(o.getAttribute("node-id"));if(!r)return;if(t.$.fireEvent("itemClick",{id:r.nodeId,type:r.type,data:r.data}),a.closest(".smart-filter-delete-btn"))return void t._clickHandlerDeleteButton(r.htmlNode);const n=a.closest(".smart-filter-add-btn")||a.closest(".smart-filter-add-condition-btn");if(n){const e=n.closest(".smart-filter-group").getAttribute("node-id");return void(n.classList.contains("smart-filter-add-condition-btn")&&(t.maxConditions&&t._getTotalConditions()<t.maxConditions||!t.maxConditions)?t._addElement("condition",e,[]):t._clickHandlerFilterButton(n.classList,r.nodeId,a))}const s=a.closest(".filter-builder-item")||a.closest(".smart-filter-group-operator")||a.closest(".smart-filter-nested-operator");if(s){const e=s.classList;t._clickHandlerFilterButton(e,r.nodeId,a)}}_downHandler(e){const t=this;if(!e.originalEvent||!t._isMobile&&0!==e.button)return;const a=t.shadowRoot||t.isInShadowDOM?e.originalEvent.composedPath()[0]:e.originalEvent.target,i=t.rightToLeft?e.pageX>a.getBoundingClientRect().right:e.pageX<a.getBoundingClientRect().left;if(t.allowDrag&&a.classList.contains("smart-filter-group-condition")&&i){const i=t._valueFlat.filter((e=>"condition"===e.type));if(1===i.length||2===i.length&&i[0].parentId===i[1].parentId&&i[1].htmlNode.hasAttribute("limit-selection"))return;return t._dragDetails={coords:{x:e.pageX,y:e.pageY},item:a,originalEvent:e},t.$.scrollableContainer._scrollView.disableSwipeScroll=!0,t._hoveredCondition=a,void window.getSelection().removeAllRanges()}this._scrollBarDown=a.closest("smart-scroll-bar"),e.stopPropagation(),e.preventDefault()}_scrollableContainerTouchmoveHandler(e){this._dragDetails&&e.cancelable&&(e.preventDefault(),e.stopPropagation())}_documentMoveHandler(e){const t=this,a=t._dragDetails;if(!a)return;const i=a.item;if(!a.feedbackShown){if(!(Math.abs(a.coords.x-e.pageX)>5||Math.abs(a.coords.y-e.pageY)>5))return;{const l=t._valueFlat.filter((e=>e.htmlNode===i))[0];if(t.$.fireEvent("dragStart",{data:l.data,item:i,originalEvent:e}).defaultPrevented)return delete t._dragDetails,delete t._hoveredCondition,void(t.$.scrollableContainer._scrollView.disableSwipeScroll=!1);a.allConditions=Array.from((t.shadowRoot||t).querySelectorAll(".smart-filter-group-condition")),a.data=l,a.feedback=t._addDragFeedback(),a.feedbackShown=!0,i.classList.add("dragged")}}const l=e.clientY;let o,r=t.shadowRoot||t.isInShadowDOM?e.originalEvent.composedPath()[0]:e.originalEvent.target;if(t.$.fireEvent("dragging",{data:a.data,item:i,originalEvent:e}),t.setAttribute("dragging",""),a.feedback.style.left=e.pageX+10+"px",a.feedback.style.top=e.pageY+10+"px",t._isMobile){const a=t._hoveredCondition;a&&(a.classList.remove("drop-target","top","bottom"),delete t._hoveredCondition);const i=document.elementFromPoint(e.clientX,l);i&&(r=i)}let n,s=r.closest(".smart-filter-group-condition");if(s){o=s;const e=o.getBoundingClientRect(),t=Math.abs(l-e.top),a=Math.abs(l-e.bottom);n=t<a?"top":"bottom"}else{let e,t;a.allConditions.forEach((a=>{const i=a.getBoundingClientRect(),o=Math.abs(l-i.top),r=Math.abs(l-i.bottom),s=Math.min(o,r);(void 0===t||s<t)&&(e=a,t=s,n=o<r?"top":"bottom")})),s=e}if(s===i||s.hasAttribute("limit-selection")&&"bottom"===n)s=void 0;else{const e=Array.from(s.parentElement.getElementsByClassName("smart-filter-group-condition")),t=e.indexOf(i);-1!==t&&("top"===n&&s===e[t+1]||"bottom"===n&&s===e[t-1])&&(s=void 0)}if(o=s,a.side=n,clearInterval(t._dragInterval),t._dragInterval=setInterval((function(){const a=t.getBoundingClientRect();t.$.scrollableContainer.scrollHeight>0&&a.left<=e.clientX&&a.left+a.width>=e.clientX?l>=a.top&&l<=a.top+36?t.$.scrollableContainer.scrollTop-=t._autoScrollCoefficient:l>=a.top+a.height-36&&l<=a.top+a.height?t.$.scrollableContainer.scrollTop+=t._autoScrollCoefficient:clearInterval(t._dragInterval):clearInterval(t._dragInterval)}),1),o){t._hoveredCondition&&o!==t._hoveredCondition&&t._hoveredCondition.classList.remove("drop-target","top","bottom");const e=o.closest(".smart-filter-group");if(e&&e.hasAttribute("restricted"))return void(t._hoveredCondition=void 0);t._hoveredCondition=o,o.classList.remove("top","bottom"),o.classList.add(n,"drop-target")}else t._hoveredCondition&&(t._hoveredCondition.classList.remove("drop-target","top","bottom"),delete t._hoveredCondition)}_addDragFeedback(){const e=this,t=document.createElement("div");return e.rightToLeft?t.setAttribute("right-to-left",""):t.removeAttribute("right-to-left"),t.className="smart-query-builder-drag-feedback",e.theme&&t.setAttribute("theme",e.theme),document.body.appendChild(t),t}_documentUpHandler(e){const t=this,a=t._dragDetails;if(!a)return void(t.$.conditionsMenu.opened&&t._selectedElement&&!t._selectedElement.classList.contains("smart-filter-add-btn")&&t.$.conditionsMenu._hoverViaKeyboard(t.$.conditionsMenu.querySelector('smart-menu-item[value="'+t._editedItem.data+'"]')));const i=a.item,l=a.data,o=t._hoveredCondition;if(delete t._dragDetails,delete t._hoveredCondition,t.$.scrollableContainer._scrollView.disableSwipeScroll=!1,!t.hasAttribute("dragging"))return;if(clearInterval(t._dragInterval),window.getSelection().removeAllRanges(),t.removeAttribute("dragging"),i.classList.remove("dragged"),a.feedback.remove(),!o)return void t.$.fireEvent("dragEnd",{data:l.data,item:i,originalEvent:e,target:null,targetData:null,targetSide:null});const r=t._valueFlat.filter((e=>e.htmlNode===o))[0],n=t.$.fireEvent("dragEnd",{data:l.data,item:i,originalEvent:e,target:o,targetData:r.data,targetSide:a.side});if(o.classList.remove("drop-target","top","bottom"),n.defaultPrevented)return;const s=t.value,d=l.nodeId.split(".").map((e=>parseFloat(e))),c=s[2*(d[0]-1)],u=r.nodeId.split(".").map((e=>parseFloat(e))),m=s[2*(u[0]-1)];let p="and";c.length>1&&(0===d[1]?(p=c[1],c[1]="!remove!"):(p=c[d[1]-1],c[d[1]-1]="!remove!")),c[d[1]]="!remove!","top"===a.side?m.splice(u[1],0,l.data,p):m.splice(u[1]+1,0,p,l.data);for(let e=0;e<s.length;e++)Array.isArray(s[e])&&(s[e]=s[e].filter((e=>"!remove!"!==e)));for(let e=s.length-1;e>=0;e--)Array.isArray(s[e])&&0===s[e].length&&(0===e?s.splice(0,2):(s.splice(e-1,2),e--));t._emptyElementsStructure(!0),t._convertValueToFlat(s),t._generateHTMLStructureFromFlatValue(),t._validValue=t._getValidValue();const f=JSON.stringify(t._validValue);t._oldValueAsString!==f&&(t._oldValueAsString=f,t.$.fireEvent("change",{value:JSON.parse(f),linq:t._queryParser.toLinq(t._validValue)}))}_clickHandlerDeleteButton(e,t){const a=this;if(e&&e.classList){if(a._closeEditor(),1===a.getElementsByClassName("smart-filter-group-condition").length){const e=a._valueFlat[1].htmlNode.children;a.value=[[[]]],a._validValue=a._getValidValue(),a._valueFlat[1].data=[],a._valueFlat[1].htmlNode.setAttribute("limit-selection",""),e[0].setAttribute("placeholder",""),e[1].setAttribute("placeholder",""),e[2].setAttribute("placeholder",""),e[2].removeAttribute("invalid-value"),e[0].firstElementChild.innerHTML=a.propertyPlaceholder,e[1].firstElementChild.innerHTML=a.operatorPlaceholder,e[2].firstElementChild.innerHTML=a.valuePlaceholder;const t=JSON.stringify(a._validValue);return a._oldValueAsString!==t&&(a._oldValueAsString=t,a.$.fireEvent("change",{value:JSON.parse(t),linq:a._queryParser.toLinq(a._validValue)})),void a._restrictNesting()}if(e.classList.contains("smart-filter-group")){if(t&&a._valueFlat.filter((t=>t.parentId===e.getAttribute("node-id"))).length>0)return;a._deleteElement(e,"group")}else a._deleteElement(e);a._generateValue(),a.$.scrollableContainer.refresh(),Array.from(a.$.contentContainer.children).forEach(((e,t)=>{const i=(t+1).toString();e.setAttribute("node-id",i),a._valueFlat.filter((t=>t.htmlNode===e))[0].nodeId=i,Array.from(e.children[1].children).forEach(((e,t)=>{const l=a._valueFlat.filter((t=>t.htmlNode===e))[0],o=i+"."+t;e.setAttribute("node-id",o),l.parentId=i,l.nodeId=o}))}))}}_menuCloseHandler(){const e=this.$.conditionsMenu.controlledBy;e.setAttribute("aria-expanded",!1),e.removeAttribute("aria-controls"),delete this.$.conditionsMenu.controlledBy}_menuClosingHandler(e){const t=e.detail;"interaction"===t.trigger&&this._selectedElement===t.target&&e.preventDefault()}_menuItemClickHandler(e){const t=this,a=t._selectedElement.closest(".smart-filter-group-operator, .smart-filter-nested-operator"),i=e.detail,l=i.value;let o;if(a){a.innerHTML=t.localize(l)||i.label,a.value=l,o=a.classList.contains("smart-filter-nested-operator")?a.getAttribute("node-id"):a.parentElement.getAttribute("node-id");for(let e=0;e<t._valueFlat.length;e++)if(t._valueFlat[e].nodeId===o){t._valueFlat[e].data=a.value;break}t._generateValue()}else o=t._selectedElement.parentElement.getAttribute("node-id"),t._addElement("group",null,l);t.$.scrollableContainer.refresh()}_newFilterConditionRow(e=[]){const t=this,a=e[0];let i,l=t._fields.find((e=>e.value===a)),o=l?l.label:void 0;void 0===a||!o&&"static"===t.fieldsMode?e.length=0:(o||(l=t._getDynamicFieldInfo(a),o=l.label,e[0]=l.dataField),i=t._getFilterOperations(l).find((t=>t.value===e[1])),i&&(i=i.label));const r=t._formatValueStringRepresentation(e[2],e),n=t._validateValueField(void 0,e[1],e[2]);let s=document.createElement("div"),d="condition"+Math.floor(65536*(1+Math.random())).toString(16).substring(1),c='<div class="filter-builder-item smart-filter-field-name" id="'+d+'Field" '+(o?'><div class="smart-value-container" role="presentation">'+o:'placeholder><div class="smart-value-container" role="presentation">'+t.propertyPlaceholder)+'</div></div><div class="filter-builder-item smart-filter-operation" id="'+d+'Operation" '+(i?'><div class="smart-value-container" role="presentation">'+i:'placeholder><div class="smart-value-container" role="presentation">'+t.operatorPlaceholder)+'</div></div><div class="filter-builder-item smart-filter-value" id="'+d+'Value" '+(n?"":"invalid-value")+(void 0!==e[2]?'><div class="smart-value-container" role="presentation">'+r:'placeholder><div class="smart-value-container" role="presentation">'+t.valuePlaceholder)+'</div></div><div class="smart-filter-delete-btn" role="button" aria-label="Close"></div>';return s.className="smart-filter-group-condition",s.setAttribute("role","group"),s.innerHTML=c,t._setAriaLabel(s),e.length||s.setAttribute("limit-selection",""),s}_setAriaLabel(e){const t=[];for(let a=0;a<e.children.length-1;a++){const i=e.children[a];i.classList.contains("smart-visibility-hidden")||i.hasAttribute("placeholder")||t.push(e.children[a].innerText)}0!==t.length?e.setAttribute("aria-label",t.join(" ")):e.setAttribute("aria-label","Empty condition row")}_formatValueStringRepresentation(e,t){const a=this,i=t[2],l=t[0],o=a._getFieldByFieldName(l);let r,n=t[1];if(!o)return e;if(null==e)return a.valuePlaceholder;if(void 0!==n&&a.customOperations&&a.customOperations.length>0&&(n=a.customOperations.find((e=>e.name===n)),n&&n.valueTemplate))return"<span>"+n.valueTemplate(a._editor,e)+"</span>";switch(o.dataType.toLowerCase()){case"date":case"datetime":(e=e instanceof Date||"string"==typeof e||"number"==typeof e&&!isNaN(e)?new Smart.Utilities.DateTime(e):e).calendar.days=a._localizedDays,e.calendar.months=a._localizedMonths,e.calendar.locale=a.locale,r=e.toString("date"===o.dataType?a.formatStringDate:a.formatStringDateTime);break;case"array":r="string"==typeof e?e.split(","):e;break;case"object":r="string"==typeof e?e:JSON.stringify(e);break;case"number":r=e;break;case"boolean":r=!!e;break;default:r=e+""}if(!a.valueFormatFunction)return"<span>"+r+"</span>";const s={label:r,value:i,dataField:l,dataType:o.dataType||"string"};return"<span>"+a.valueFormatFunction(s)+"</span>"}_getFieldByFieldName(e){return Object.assign({},this._fields.find((t=>t.value===e)))}_refresh(){const e=this;e._generateValue(),e._emptyElementsStructure(),e._generateHTMLStructureFromFlatValue(),e._restrictNesting()}_generateValue(e){const t=this;let a=[],i=t._valueFlat.slice(0),l=[];for(let e=0;e<i.length;e++){const t=i[e];let l={};"group"===t.type&&(l.nodeId=t.nodeId,l.parentId=t.parentId,l.data=t.data,l.structure=[],a.push(l))}for(let e=0;e<a.length;e++){const t=a[e];for(let e=0;e<i.length;e++){const a=i[e];if(a.parentId===t.nodeId&&"condition"===a.type){const l=i[e-1];l&&l.parentId===t.nodeId&&"operator"===l.type&&t.structure.push(l.data.toString()),t.structure.push(a.data)}}}a=a.filter((e=>e.structure.length>0)),a.sort((function(e,t){return t.nodeId.split(".").length-e.nodeId.split(".").length}));for(let e=0;e<a.length;e++){const t=a[e],i=a.filter((e=>e.nodeId===t.parentId))[0];i&&i.structure?i.structure.push(t.structure):"0"!==t.nodeId?t.data&&(e>0&&l.push(t.data),l.push(t.structure)):l=l.concat(t.structure)}if(t.value=l,t._validateValue(),t._validValue=t._getValidValue(),t._updateValidationStatus(),!e){const e=JSON.stringify(t._validValue);t._oldValueAsString!==e&&(t._oldValueAsString=e,t.$.fireEvent("change",{value:JSON.parse(e),linq:t._queryParser.toLinq(t._validValue)}))}}_updateValidationStatus(){const e=this,t=e.customOperations.filter((e=>"function"==typeof e.validateValue)),a=e._valueFlat,i=!!e._validationStatus;let l=!0;for(let e=0,i=a.length;e<i;e+=1){const i=a[e];if("condition"!==i.type)continue;const o=i.data[1],r=t.find((e=>e.name===o));if(r&&0==!!r.validateValue(i.data[2])){l=!1;break}}if(e._validationStatus!==l){const t=void 0!==e._validationStatus;e._validationStatus=l,t&&e.$.fireEvent("validationChange",{oldValue:i,newValue:l})}}_getItemById(e,t){const a=this._valueFlat.filter((a=>t?a.parentId===e:a.nodeId===e));return a.length>0?a[0]:null}_validateStoredValue(e,t){const a=this;if(!t&&!a._editedItem)return e;if(!t&&!(t=a._editedItem.data[0]))return e;const i=a._getFieldByFieldName(t).dataType;if(void 0===i)return e+"";switch(i.toLowerCase()){case"date":case"datetime":e=new Smart.Utilities.DateTime(e).toDate();break;case"number":"number"!=typeof e&&(e=parseFloat(e));break;case"boolean":"boolean"!=typeof e&&(e=!!e);break;case"object":"object"!=typeof e&&(e={});break;case"array":Array.isArray(e)||(e=[e]);break;default:"string"!=typeof e&&(e+="")}return e}_closeEditor(e){const t=this;let a;if(!t._editedItem||!t._editorIsOpen)return;const i=t._editedItem,l=t._editor.closest(".filter-builder-item"),o=l.querySelector(".smart-value-container"),r=l.parentElement,n=r.children[2];if(t._editor===t.$.dateTimePickerEditor)t._editor._inputChangeHandler(),a=t._editor.value,a&&(a=a.toDate());else if(t._editor===t.$.checkBoxEditor)a=t._editor.checked;else if(t._editor===t.$.customEditor)t._editor&&Array.from(t._editor.getElementsByTagName("smart-numeric-text-box")).forEach((e=>e._inputBlurHandler())),a=t._validateStoredValue(t._selectedCustomCondition.handleValue(t._editor));else if(t._editor===t.$.numericTextBoxEditor)t._editor._inputBlurHandler(),a=t._editor.value;else if(l.classList.contains("smart-filter-value")){const e=t._getFieldByFieldName(t._editedItem.data[0]);if("array"===e.dataType)a=t._editor.value.split(",");else if("object"===e.dataType)a=JSON.parse(t._editor.value);else{const i=t._editor.value;a=e.lookup&&e.lookup.dataSource?{label:i,value:t._editor.dataset.value||i}:i}}else a=t._editor.value;if(l.classList.contains("smart-filter-field-name")){if(""===a.trim())return void t._hideEditor(l,void 0===i.data[0]);r.hasAttribute("limit-selection")&&(r.removeAttribute("limit-selection"),r.parentElement.nextElementSibling.removeAttribute("limit-selection"));const e=t._fields.find((e=>e.label===a)),s=i.data[0];if(e)i.data[0]=e.value;else{if("dynamic"!==t.fieldsMode)return o.innerHTML=t._fields.find((e=>e.value===s)).label,void t._hideEditor(l);{const e=t._getDynamicFieldInfo(a);a=e.label,i.data[0]=e.dataField}}o.innerHTML=a,t._handleFieldChange([s,i.data[0]],[n,i,r])}else if(l.classList.contains("smart-filter-operation"))t._handleOperationChange([i,a,t._editor.$.input.dataValue],[o,n]);else{let e,l;"object"==typeof a&&void 0!==a.value?(e=a.label,l=a.value,void 0===e&&(e=l)):e=l=a,i.data[2]=l,o.innerHTML=t._formatValueStringRepresentation(e,i.data)}t._validateValueField(n,i.data[1],i.data[2]),t._generateValue(e),t._hideEditor(l)}_validateValueField(e,t,a){const i=this.customOperations;let l=!0;if(e&&e.removeAttribute("invalid-value"),i&&i.length>0){const o=i.find((e=>e.name===t));o&&"function"==typeof o.validateValue&&(l=!!o.validateValue(a),!l&&e&&e.setAttribute("invalid-value",""))}return l}_getDynamicFieldInfo(e){const t=this,a={label:e,dataField:e,dataType:"string"};if(t.getDynamicField){const i=t.getDynamicField(e);i.label&&(a.label=i.label),i.dataField&&(a.dataField=i.dataField),i.dataType&&(a.dataType=i.dataType),i.filterOperations&&Array.isArray(i.filterOperations)&&i.filterOperations.length>0&&(a.filterOperations=i.filterOperations),i.lookup&&(a.lookup=i.lookup)}return t._manuallyAddedFields.push(a),t._mapFieldsToMenu(),a}_handleFieldChange(e,t){const a=this,i=e[0],l=t[1],o=t[2],r=t[0],n=a._fields.find((t=>t.value===e[1])),s=a._getFilterOperations(n),d=function(){n.value!==i&&a.$.fireEvent("propertySelected",{label:n.label,value:n.value})};if(!i||void 0===l.data[1])return a._handleOnlyOperation(s,l.data,o),void d();const c=a._fields.find((e=>e.value===i)),u=c.dataType,m=n.dataType;if(n!==c&&(m!==u||"enum"===m||n.filterOperations||c.filterOperations)){if(s.find((e=>e.value===l.data[1]))){if(m===u&&"enum"!==m)return;return"date"===m&&"dateTime"===u||"dateTime"===m&&"date"===u?(r.firstElementChild.innerHTML=a._formatValueStringRepresentation(l.data),void d()):(l.data.splice(2,1),r.setAttribute("placeholder",""),r.firstElementChild.innerHTML=a.valuePlaceholder,void d())}l.data.splice(1,2),o.children[1].setAttribute("placeholder",""),o.children[1].firstElementChild.innerHTML=a.operatorPlaceholder,r.setAttribute("placeholder",""),r.firstElementChild.innerHTML=a.valuePlaceholder,r.classList.remove("smart-visibility-hidden"),a._handleOnlyOperation(s,l.data,o),d()}}_handleOnlyOperation(e,t,a){const i=this.autoPrompt;if(1===e.length||i&&"immediately"===this.applyMode&&e.length>1){const i=e[0];t[1]=i.value,a.children[1].removeAttribute("placeholder",""),a.children[1].firstElementChild.innerHTML=e[0].label,("isblank"===i.value||"isnotblank"===i.value||i.custom&&i.hideValue)&&(t.splice(2,1),a.children[2].classList.add("smart-visibility-hidden"))}}_handleOperationChange(e,t){const a=this,i=e[0],l=e[1],o=e[2],r=t[0],n=t[1],s=void 0!==i.data[1]?a._filterOperationDescriptions.find((e=>e.value===i.data[1])):void 0,d=a._filterOperationDescriptions.find((e=>e.value===o));if(!d||d===s)return;const c=i.data[0],u=i.data[1],m=i.data[2],p=d.value;if(i.data[1]=p,r.innerHTML=l,"isblank"===p||"isnotblank"===p||d.custom&&d.hideValue)i.data.splice(2,1),n.classList.add("smart-visibility-hidden");else if(n.classList.contains("smart-visibility-hidden"))n.setAttribute("placeholder",""),n.classList.remove("smart-visibility-hidden"),n.firstElementChild.innerHTML=a.valuePlaceholder;else if(d.custom){const e=a._getFieldByFieldName(c);if(d.editorTemplate){const t=d.editorTemplate(e.dataType,u,e);t&&(a.$.customEditor.innerHTML="",a.$.customEditor.appendChild(t))}d.valueTemplate?n.firstElementChild.innerHTML=d.valueTemplate(a.$.customEditor,m):void 0===m?(n.setAttribute("placeholder",""),n.firstElementChild.innerHTML=a.valuePlaceholder):n.firstElementChild.innerHTML=m}else void 0===m?(i.data.splice(2,1),n.setAttribute("placeholder",""),n.firstElementChild.innerHTML=a.valuePlaceholder):d.custom||(n.firstElementChild.innerHTML=a._formatValueStringRepresentation(m,i.data))}_hideEditor(e,t){const a=this;t&&e.setAttribute("placeholder",""),e.removeAttribute("edited"),a.$.editorsContainer.removeAttribute("open"),a._editor.close&&a._editor.close(),a._editor.classList.add("smart-hidden"),a._editorIsOpen=a._enterIsPressedInEditor=!1,a.$.scrollableContainer.refresh(),a._setAriaLabel(e.parentElement)}_clickHandlerFilterButton(e,t,a){const i=this;function l(e,t,a){i._contextMenuOptions=0===t.length?i._defaultFilterOperationDescriptions:t,i._handleContextMenu(e),i.$.conditionsMenu.opened&&(i.$.conditionsMenu._discardKeyboardHover(),i.$.conditionsMenu._hoverViaKeyboard(i.$.conditionsMenu.querySelector('smart-menu-item[value="'+a+'"]')))}a.closest(".smart-editors-container")||(i._closeEditor(),i._editedItem=i._getItemById(t),e.contains("smart-filter-add-btn")?l(a,i._groupOperationDescriptions):(e.contains("smart-filter-field-name")||i._editedItem.data&&i._editedItem.data.length)&&(e.contains("smart-filter-group-operator")||e.contains("smart-filter-nested-operator")?l(a,i._groupOperationDescriptions,i._editedItem.data):(a.closest(".filter-builder-item").removeAttribute("placeholder"),i._openEditor(a))))}_handleContextMenu(e){const t=this;if(t._selectedElement===e&&t.$.conditionsMenu.opened)return void t.$.conditionsMenu.close();if(t._closeEditor(),t.disableContextMenu)return void(t._selectedElement=e);const a=e.getBoundingClientRect(),i=t.getBoundingClientRect(),l=a.left+t.$.contentContainer.scrollLeft-i.left,o=a.top+t.$.contentContainer.scrollTop-i.top+a.height;e.hasAttribute("aria-haspopup")&&(t.$.conditionsMenu.controlledBy&&(t.$.conditionsMenu.controlledBy.setAttribute("aria-expanded",!1),t.$.conditionsMenu.controlledBy.removeAttribute("aria-controls")),e.setAttribute("aria-controls",t.$.conditionsMenu.id),e.setAttribute("aria-expanded",!0),t.$.conditionsMenu.controlledBy=e),t.$.conditionsMenu.dataSource=t._contextMenuOptions,t.$.conditionsMenu.open(l,o+3),t._selectedElement=e,t.$.scrollableContainer.refresh()}_openEditor(e){const t=this,a=e&&e.closest(".smart-filter-group-condition")?e.closest(".smart-filter-group-condition").getAttribute("node-id"):null,i=e.closest(".filter-builder-item"),l=t._getItemById(a);let o="";void 0!==l.data[0]?o=l.data[0]:t._fields.length&&(o=t._fields[0].value);let r,n,s=t._getFieldByFieldName(o),d="";if(i.classList.contains("smart-filter-field-name"))n=0,t._fields||t._mapFieldsToMenu(),s.lookup={dataSource:t._fields.slice(),readonly:!1},d=s.label||"",r=s.value;else if(i.classList.contains("smart-filter-operation")){n=1;let e=t._getFilterOperations(s);s.lookup={dataSource:e,readonly:!0};let a=e.find((e=>e.value===l.data[n]))||e[0];d=a.label,r=a.value}else n=2,d=l.data[n],void 0===d&&(d="");t._editorIsOpen&&t._closeEditor(),i.setAttribute("edited",""),t._editedItem=l;const c=t._fields.filter((e=>e.value===o)),u=t._filterOperationDescriptions.filter((e=>e.value===l.data[1]&&e.custom)),m=c.length>0?c[0]:null,p=s.lookup&&s.lookup.dataSource?"lookup":m?m.dataType:void 0;2===n&&0!==u.length&&u[0].editorTemplate?(t._selectedCustomCondition=u[0],t._openCustomEditor(p,d,s)):t._openEditorByFieldType(p,d,s,r),i.appendChild(t.$.editorsContainer),t._editor.classList.remove("smart-hidden"),t._editorIsOpen=!0,t.$.editorsContainer.setAttribute("open",""),t.$.scrollableContainer.refresh(),t._editor.classList.contains("smart-custom-editor")||requestAnimationFrame((()=>t._editor.focus())),s.lookup&&s.lookup.readonly&&t._editor.open()}_getFilterOperations(e){const t=this;let a=t._filterOperationDescriptions.slice();if(e.filterOperations)a=t._filterOperationDescriptions.filter((t=>e.filterOperations.indexOf(t.value)>-1));else{let i;switch(e.dataType){case"date":case"dateTime":case"number":i=["=","<>","<",">","<=",">=","isblank","isnotblank"];break;case"boolean":i=["=","<>","isblank","isnotblank"];break;case"object":i=["isblank","isnotblank"];break;case"string":i=["contains","notcontains","startswith","endswith","=","<>","isblank","isnotblank"];break;default:i=["contains","notcontains","startswith","endswith","=","<>","<",">","<=",">=","isblank","isnotblank"]}a=t._filterOperationDescriptions.filter((e=>i.indexOf(e.value)>-1))}return t.showIcons&&a.map((e=>e.icon=t.icons[e.value])),a}_openCustomEditor(e,t,a){const i=this,l=i.customOperations[i._selectedCustomCondition.index].editorTemplate(e,t,a);i.$.customEditor.innerHTML="",l&&i.$.customEditor.appendChild(l),i._editor=i.$.customEditor}_openEditorByFieldType(e,t,a,i){const l=this;if(e)switch(e.toLowerCase()){case"boolean":return l._initializeEditor("checkBox"),void(l._editor.checked=!!t);case"date":case"datetime":return l._initializeEditor("dateTimePicker"),l._editor.formatString="date"===e?l.formatStringDate:l.formatStringDateTime,void(l._editor.value=t);case"number":return l._initializeEditor("numericTextBox"),void(l._editor.value=t||0)}if(l._initializeEditor("input"),l._editor.dropDownWidth=l.dropDownWidth,"lookup"===e){const i=a.lookup.minLength,o=a.lookup.dataSource;if(l._editor.autoCompleteDelay=a.lookup.autoCompleteDelay||100,l._editor.dropDownAppendTo=l.$.container,l._editor.dropDownButtonPosition=l.rightToLeft?"left":"right",l._editor.minLength=isNaN(i)||null===i?1:i,l._editor.readonly=!!a.lookup.readonly,"function"==typeof o?l._editor.dataSource=o:o instanceof Promise?o.then((e=>{if(!(l._editor instanceof Smart.Input))return;const a=l._editor.opened;l._editor.dataSource=e,a&&(l._editor.open(),""===t&&l._editor.readonly&&e.length&&(l._editor.value=e[0].label||e[0]))})):l._editor.dataSource=o,"object"===e)t=JSON.stringify(t||{});else if(""===t&&l._editor.readonly){const e=l._editor.dataSource;if(Array.isArray(e)){const a=e[0];t=a&&(a.value||a.label)||""}else t=""}if(l._editor.$){const e=l._editor.$.input.dataValue;null!=e&&e===t||(l._editor.value=void 0!==t?t+"":"")}else l._editor.value=void 0!==t?t+"":""}else l._editor.dataSource=[],l._editor.dropDownButtonPosition="none",l._editor.readonly=!1,l._editor.value=void 0!==t?t+"":"";i&&"object"!==e&&l._editor.$&&(l._editor.$.input.dataValue=i)}_initializeEditor(e){const t=this;if(t.$[e+"Editor"])return void(t._editor=t.$[e+"Editor"]);const a=document.createElement("smart-"+Smart.Utilities.Core.toDash(e));"numericTextBox"===e?(a.spinButtons=!0,a.inputFormat="floatingPoint"):"dateTimePicker"===e&&(a.dropDownAppendTo=t.$.container,a.calendarButton=!0,a.dropDownDisplayMode="auto",a.enableMouseWheelAction=!0,a.locale=t.locale,a.autoClose=!0,a.messages[t.locale]||(a.messages[t.locale]={}),a.messages[t.locale].dateTabLabel=t.localize("dateTabLabel"),a.messages[t.locale].timeTabLabel=t.localize("timeTabLabel")),a.rightToLeft=t.rightToLeft,a.theme=t.theme,a.animation=t.animation,a.$.addClass("smart-hidden underlined"),t.$.editorsContainer.appendChild(a),t._editor=t.$[e+"Editor"]=a}_getValidValue(){const e=this,t=e.properties.value.value,a=[];let i=!1;return t.forEach((t=>{if(Array.isArray(t)){let l=!1,o=!1;const r=[];t.forEach((t=>{if(Array.isArray(t)){const a=t[0],i=t[1],n=t[2];if(void 0===a||void 0===i)return void(o=!0);if(void 0!==n||"isblank"===i||"isnotblank"===i)return l=!0,void r.push(t);const s=e._filterOperationDescriptions.find((e=>e.value===i));s.custom&&s.hideValue?(l=!0,r.push(t)):o=!0}else o?o=!1:r.push(t)})),l?("string"==typeof r[r.length-1]&&r.pop(),a.push(r)):i=!0}else i?i=!1:a.push(t)})),"string"==typeof a[a.length-1]&&a.pop(),a}}),Smart.Utilities.Assign("QueryParser",class{constructor(e,t,a){const i=this;i.customOperations=t||[],i.fields=e||[],i.dynamicField=a}toLinq(e){return Array.isArray(e)&&this._arePropertiesValid()?this._parseQueryToLinq(e):""}toValue(e){return"string"==typeof e&&this._arePropertiesValid()?this._parseLinqToValue(e):[]}_validateProperties(){const e=this;Array.isArray(e.customOperations)||(e.customOperations=[]),Array.isArray(e.fields)||(e.fields=[]),"function"==typeof e.dynamicField&&delete e.dynamicField}_arePropertiesValid(){return Array.isArray(this.customOperations)?!!Array.isArray(this.fields)||(console.log('Invalid "fields" property.'),!1):(console.log('Invalid "customOperations" property.'),!1)}_parseQueryToLinq(e){const t=this,a={and:"&&",or:"||"};let i="";for(let l=0;l<e.length;l++){const o=e[l];if(Array.isArray(o))if(o.indexOf("and")>-1||o.indexOf("or")>-1||1===o.length&&Array.isArray(o[0])){const e=t._parseQueryToLinq(o);e?i+=o.length>1?"("+e+")":e:/\s(&|\|){2}\s$/gm.test(i)&&(i=i.replace(/\s(&|\|){2}\s$/gm,""))}else i+=t._getExpressionFromQuery(o)||"";else i&&(i+=" "+a[o]+" ")}return i}_getExpressionFromQuery(e){const t=e[0],a=e[1];let i=e[2];const l=this.customOperations.find((e=>e.name===a));return l&&l.expressionTemplate?("string"==typeof i&&i.includes('"')&&l.expressionTemplate.includes('"')&&(i=JSON.stringify(i).slice(1,-1)),l.expressionBuilderCallback?l.expressionBuilderCallback(t,a,i):l.expressionTemplate.replace("{0}",t).replace("{1}",i)):""}_parseLinqToValue(e){const t=this;let a,i=0,l=[];for(let t=0;t<e.length;t++)if("("===e[t])i++,void 0===a&&(a=t);else if(")"===e[t]&&i>0&&(i--,0===i)){let i=e.substring(a,t+1).trim();i.length&&(i.includes("&&")||i.includes("||"))&&l.push({expr:i}),a=void 0}let o,r=[];if(l.length)for(let a=0;a<l.length;a++){let i;l[a].query=t._getQueryFromExpression(l[a].expr),i=o?e.substring(e.indexOf(o)+o.length,e.indexOf(l[a].expr)).trim():e.substring(0,e.indexOf(l[a].expr)).trim(),i&&r.push(i),o=l[a].expr}o?r.push(e.substring(e.indexOf(o)+o.length).trim()):r.push(e.trim());for(let e=0;e<r.length;e++){const a=r[e].replace(/^&{2}|^\|{2}|&{2}$|\|{2}$/gm,"").trim();a.length&&l.push({expr:a,query:t._getQueryFromExpression(a),outher:!0})}return t._constructValueFromQueries(e,l)}_getQueryFromExpression(e){const t=this,a=t.fields,i=t.dynamicField;let l=[],o=e;const r=function(e){let o=[];const r=t.customOperations.filter((e=>e.expressionTemplate));r.sort(((e,t)=>t.expressionTemplate.length-e.expressionTemplate.length));for(let t=0;t<r.length;t++){const a=r[t],i=new RegExp(a.expressionTemplate.replace(/\(/gm,"\\(").replace(/\)/gm,"\\)").replace(/\[/gm,"\\[").replace(/\]/gm,"\\]").replace(/"{\d+}"/gm,'\\W*"([^"]*)[^a-zA-Z0-9-\\s\\)]+').replace(/{\d+}/gm,"([@|$]*\\w+[.]*\\w+(?!\\s)*)\\s{0}").replace(/ /gm,"\\s"),"gm");if(i.test(e)){i.lastIndex=0;let t,l,r=i.exec(e);if(r=r.filter(((e,t)=>r.indexOf(e)===t)),a.expressionReaderCallback){let e=a.expressionReaderCallback(r[0],r.slice(1));e&&(t=e.fieldName,l=e.value)}void 0===t&&(t=r[1]||""),void 0===l&&(l=r[2]||""),o.push({operator:a.name,field:t,value:l,query:r[0]})}}let n=o.find((e=>a.find((t=>t.filterOperations.indexOf(e.operator)>-1&&t.dataField===e.field))));if(!n&&i)for(let e=0;e<o.length;e++){const t=o[e],a=i(t.field);if(a&&Array.isArray(a.filterOperations)&&a.filterOperations.indexOf(t.operator)>-1){n=t;break}}if(n)return l.push({expr:n.query,query:[n.field,n.operator,n.value]}),n.query};if(o){for(;o.length;){o&&(o=o.trim(),"("===o[0]&&")"===o[o.length-1]&&(o=o.trim().replace(/^\(|\)$/gm,"")),o=o.replace(/^&{2}|^\|{2}|&{2}$|\|{2}$/gm,"").trim());const e=r(o);if(!e)break;o=o.replace(e,"").trim()}return t._constructValueFromQueries(e,l)}}_constructValueFromQueries(e,t){let a=[];t.sort(((t,a)=>e.indexOf(t.expr)-e.indexOf(a.expr)));for(let i=0;i<t.length;i++){let l=t[i-1];if(l){const o=e.substring(e.indexOf(l.expr)+l.expr.length,e.indexOf(t[i].expr)).trim();a.push("||"===o?"or":"and")}t[i].outher?t[i].query.forEach((e=>a.push(Array.isArray(e)?[e]:e))):a.push(t[i].query)}return a}});