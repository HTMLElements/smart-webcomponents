
/* Smart UI v12.0.0 (2022-01-16) 
Copyright (c) 2011-2021 jQWidgets. 
License: https://htmlelements.com/license/ */ //

Smart("smart-pivot-table",class extends Smart.Table{static get properties(){return{columnTotals:{value:!1,type:"boolean"},columnTotalsPosition:{value:"near",allowedValues:["near","far"],type:"string"},defaultSortByRowGroups:{value:!1,type:"boolean"},designer:{value:!1,type:"boolean"},designerPosition:{value:"far",allowedValues:["near","far"],type:"string"},drillDown:{value:!1,type:"boolean"},drillDownDataExport:{value:"",allowedValues:["","xlsx","pdf","html","json","csv","tsv","xml"],type:"string"},drillDownDataExportFileName:{value:"smartPivotTableDrillDownDetails",type:"string"},drillDownTableInit:{value:null,type:"function?"},drillDownCustomAction:{value:null,type:"function?"},enableSortByRowGroups:{value:!1,type:"boolean"},getDefaultSummaryFunction:{value:null,type:"function?"},grandTotal:{value:!1,type:"boolean"},groupLayout:{value:"default",allowedValues:["default","classic"],type:"string"},hideCellSelectionTooltip:{value:!1,type:"boolean"},hideEmptyRows:{value:!1,type:"boolean"},messages:{value:{en:{average:"Average",calculation:"Calculation",center:"center",clear:"Clear",columns:"Columns",columnSettings:"Column settings",count:"Count",decimalPlaces:"Decimal places",decimalSeparator:"Decimal separator",details:"Details",dragHereRowGroups:"Drag here to set row groups",dragHereSummaries:"Drag here to set summaries",dragHerePivots:"Drag here to set pivots",fields:"Fields",filter:"Filter",filters:"Filters",grandTotal:"Grand Total",groupHeader:"Group",left:"left",moveTo:"Move to",negativesInBrackets:"Negatives in brackets",numberAlignment:"Number alignment",numberFormat:"Number format",numberPrefix:"Number prefix",notApplicable:"N/A",export:"Export to",pivots:"Pivots",right:"right",row:"Row",rowGroups:"Row Groups",sameSummaryFunctionRequired:'smartPivotTable: When "columnTotals" is enabled, all summary columns must have the same "summary" function set (e.g. \'{{example}}\').',search:"Search...",showRows:"Show records where:",sum:"Sum",summaries:"Summaries",summaryRequired:'smartPivotTable: At least one column with "summary" is required.',textAlignment:"Text alignment",total:"Total",thousandsSeparator:"Thousands separator"}},type:"object",extend:!0},nullDefaultValue:{value:null,type:"number?"},rowSort:{value:!1,type:"boolean"},rowSummary:{value:!0,type:"boolean"},rowTotals:{value:!1,type:"boolean"},rowTotalsPosition:{value:"near",allowedValues:["near","far"],type:"string"},selectionMode:{value:"many",type:"string",allowedValues:["many","extended","cell"]},toolbar:{value:!1,type:"boolean"}}}static get listeners(){return{resize:"_overriddenTableHandler","designerContainer.change":"_designerChangeHandler","designerContainer.clear":"_designerFilterHandler","designerContainer.filter":"_designerFilterHandler","fieldsButton.click":"_fieldsButtonClickHandler","tableContainer.change":"_overriddenTableHandler","tableContainer.keyup":"_overriddenTableHandler","tableContainer.touchmove":"_tableContainerTouchmoveHandler","toolbar.close":"_breadcrumbCloseHandler","toolbar.dragEnd":"_breadcrumbDragEndHandler","toolbar.dragging":"_breadcrumbDraggingHandler"}}template(){return'<div id="container" class="smart-container" role="presentation">\n                    <div id="toolbar" class="smart-pivot-table-toolbar" role="toolbar">\n                        <smart-breadcrumb id="rowGroupBreadcrumb" class="smart-pivot-table-row-group-breadcrumb" allow-drag allow-drop animation="[[animation]]" close-buttons right-to-left="[[rightToLeft]]" theme="[[theme]]"></smart-breadcrumb>\n                        <smart-breadcrumb id="pivotBreadcrumb" class="smart-pivot-table-pivot-breadcrumb" allow-drag allow-drop animation="[[animation]]" close-buttons right-to-left="[[rightToLeft]]" theme="[[theme]]"></smart-breadcrumb>\n                        <smart-button id="conditionalFormattingButton" class="smart-table-toolbar-button conditional-formatting" animation="[[animation]]" right-to-left="[[rightToLeft]]" theme="[[theme]]" aria-label="Conditional Formatting"></smart-button>\n                        <smart-button id="fieldsButton" class="smart-table-toolbar-button fields" animation="[[animation]]" right-to-left="[[rightToLeft]]" theme="[[theme]]" aria-label="Fields"></smart-button>\n                    </div>\n                    <div id="main" class="smart-pivot-table-main-container">\n                        <table id="tableContainer" class="smart-table-container"></table>\n                    </div>\n                    <div id="designerContainer" class="smart-pivot-table-designer-container"></div>\n                </div>'}clearFilters(){const e=this;e._filterInfo.appliedFilters&&(e._clearSortByRow(!0),delete e._filterInfo.appliedFilters,e._clearDesignerFilters(),e.dataSource.clearFilter(),e.refresh(!0),e._originalDynamicColumnsOrder=e._dynamicColumns.map((e=>e.id)),e.$.fireEvent("filter",{action:"remove"}))}clearSelection(){const e=this;"cell"===e.selectionMode?e._clearCellSelection(!0):super.clearSelection()}exportData(e,t,l){const a=this,o=getComputedStyle(a),i=o.borderRightColor,r={hierarchical:!0},n={},s=a._dynamicColumns;let d=[];if(s&&0!==s.length){if(r.style={border:"1px solid "+i,borderCollapse:"collapse",backgroundColor:o.backgroundColor,color:o.color,fontFamily:"Helvetica",header:{border:"1px solid "+i,fontWeight:"bold"},columns:{border:"1px solid "+i}},-1!==["csv","json","tsv","xml"].indexOf(e)){for(let e=0;e<s.length;e++){const t=s[e];t.group?n[t.id]=t.label:n[t.id]=t.dataFields.map((e=>e.label)).join(" -> ")}d.push(n)}else{const e=[],t=[];for(let l=0;l<s.length;l++){const o=s[l],i=o.id,n={},d={};if(a._getColumnExportFormat(o,n,d),r.style.columns[i]=d,r.style.header[i]=n,o.group){n.width=1.25*a._cellWidth+"px",e.push({label:o.label,dataField:i});continue}n.width=a._cellWidth+"px";const c=o.dataFields,u={label:c[c.length-1].label,dataField:i};if(e.push(u),1!==c.length)for(let e=c.length-2;e>=0;e--){const l=c[e].label,a=c.slice(0,e+1).map((e=>e.label)).join("_").replace(/[ ,]/g,"_");if(e===c.length-2&&(u.columnGroup=a),t.find((e=>e.name===a)))continue;const o={label:l,name:a};c[e-1]&&(o.parentGroup=c[e-1].label.replace(/[ ,]/g,"_")),t.push(o)}}n.columns=e,n.columngroups=t,r.header=n}for(let t=0;t<a.rows.length;t++){const l=a.rows[t],o={};for(let t in l){if(-1!==["$","children","count","expanded","leaf","level","parent","sortOrder","tr"].indexOf(t))continue;if("id"===t){o._keyDataField=l.id;continue}if("parentid"===t){o._parentDataField=l.parentid;continue}const a=l[t];o[t]=null!==a?a:"pdf"===e?" ":""}!0!==l.leaf&&(o._expanded=!0===l.expanded),d.push(o)}return new Smart.Utilities.DataExporter(r).exportData(d,e,t,l)}}getDynamicColumns(){return this._dynamicColumns}getSelection(){const e=this;return"cell"===e.selectionMode?e._selectedCells.collection.map((e=>({dataField:e.dataField,rowId:e.rowData.$.id}))):super.getSelection()}select(e,t){const l=this;l.selection&&("cell"!==l.selectionMode?super.select(e):l._toggleCellSelectionProgrammatically(e,t,!0))}sortBy(e,t){const l=this;let a;if(e){let t=null;if(e.group&&(t=l._rowGroupColumns.find((t=>t.label===e.label?t:null))),!t&&(-1===l._dynamicColumns.indexOf(e)||0===l._rowGroupColumns.length))return;if(!1===e.dataFields[e.dataFields.length-1].originalColumn.allowSort)return;a=e.id}l._sortBy({column:e,columnDataField:a,sortOrder:t,dataFields:l._dynamicDataFields,columnByDataField:"_getDynamicColumnById"})}unselect(e,t){const l=this;l.selection&&("cell"!==l.selectionMode?super.unselect(e):l._toggleCellSelectionProgrammatically(e,t,!1))}propertyChangedHandler(e,t,l){const a=this;function o(){a._dynamicColumns.filter((e=>e.rowTotal)).forEach((e=>{delete a._getDynamicColumnById[e.id],a._dynamicDataFields=a._dynamicDataFields.filter((t=>t.name!==e.id))})),a._dynamicColumns=a._dynamicColumns.filter((e=>!0!==e.rowTotal))}switch(e){case"animation":case"rightToLeft":case"theme":super.propertyChangedHandler(e,t,l),a._designer&&(a._designer[e]=l,"rightToLeft"===e&&(a._designer.inverted=a.designer&&("near"===a.designerPosition&&!l||"far"===a.designerPosition&&l))),"rightToLeft"===e&&a.selection&&"cell"===a.selectionMode&&a._showSelectionDetails(!0);break;case"columns":a._conditionalFormatting&&delete a._conditionalFormatting,a._updateColumns(),a._formattingPanel&&(a._formattingPanel.columns=a._aggregateColumns.map((e=>({label:`${e.summary}(${e.label})`,dataField:e.dataField,dataType:"number"}))));break;case"columnTotals":a._clearSortByRow(!0),a.refresh(!0),a._originalDynamicColumnsOrder=a._dynamicColumns.map((e=>e.id));break;case"columnTotalsPosition":{if(!a.columnTotals)return;a._clearSortByRow(!0,!0),o();const e=a._dynamicColumns.filter((e=>e.columnTotal&&0===e.pivotLevel)),t=a._dynamicColumns.filter((e=>e.group)),i=[];!function e(t,a){for(let o=0;o<t.length;o++){const i=t[o];"far"===l&&i.columnTotal&&e(i.children,a),a.push(i),"near"===l&&i.columnTotal&&e(i.children,a)}}(e,i),t.push(...i),a._dynamicColumns=t,a._addRowTotalsDynamicColumnDefinitions(),a.refresh(void 0,a._getCurrentDataStructure()),a._originalDynamicColumnsOrder=a._dynamicColumns.map((e=>e.id));break}case"conditionalFormatting":a._applyInitialConditionalFormatting(a.rows),a.refresh(void 0,a._getCurrentDataStructure());break;case"dataSource":delete a._dataSourceSortedByDefault,delete a._filterInfo.appliedFilters,a._sortColumns=[],a._clearSortByRow(!0),a._clearDesignerFilters(),a._validateDataSource(),a.refresh(!0),a._originalDynamicColumnsOrder=a._dynamicColumns.map((e=>e.id));break;case"designer":l&&(a._designer?(a._dialog&&a._dialog.classList.contains("fields")&&a._dialog.close(),a._designer.inverted="near"===a.designerPosition&&!a.rightToLeft||"far"===a.designerPosition&&a.rightToLeft,a.$.designerContainer.appendChild(a._designer)):a._initDesigner(a.$.designerContainer));break;case"designerPosition":a.designer&&(a._designer.inverted="near"===l&&!a.rightToLeft||"far"===l&&a.rightToLeft);break;case"disabled":case"unfocusable":case"keyboardNavigation":super.propertyChangedHandler(e,t,l),a._designer&&(a._designer.unfocusable=a.disabled||a.unfocusable||!a.keyboardNavigation);break;case"filtering":l||a.clearFilters();break;case"grandTotal":l?(a.footerRow="footer",a.freezeFooter=!0,a._createGrandTotalRow(a.rows.boundHierarchy,!0)):(a.footerRow=null,a.freezeFooter=!1,a.$.tableContainer.querySelector("tfoot").remove());break;case"groupLayout":a.refresh(!0);break;case"hideCellSelectionTooltip":if(!a.selection||"cell"!==a.selectionMode)return;if(l){const e=a.$.tableContainer.querySelector("[selection-detail]");e&&(e.removeAttribute("selection-detail"),e.removeAttribute("detail-position-x"),e.removeAttribute("detail-position-y"))}else a._showSelectionDetails();break;case"hideEmptyRows":a._rowGroupColumns.length>0&&a.refresh(!0,a._getCurrentDataStructure());break;case"locale":case"messages":if(super.propertyChangedHandler(e,t,l),a._rowGroupColumns){const e=a.$.tableContainer.querySelectorAll(".smart-pivot-table-grouping-header");e[e.length-1].innerHTML=a.localize("groupHeader")}a.columnTotals&&a._dynamicColumns.forEach((e=>{e.columnTotal&&(e.cell.textContent=`${a._totalSummaryFunction}(${a.localize("total")})`)})),a._designer&&(a._designer[e]=a[e]),a.selection&&"cell"===a.selectionMode&&a._showSelectionDetails();break;case"nullDefaultValue":a.refresh(!0,a._getCurrentDataStructure());break;case"rowSort":!l&&a._sortRow&&a._clearSortByRow();break;case"rowTotals":case"rowTotalsPosition":{if(0===a._pivotColumns.length||"rowTotalsPosition"===e&&!a.rowTotals)return;let t=!1;a._clearSortByRow(!0,!0),"rowTotals"===e?l?(t=!0,a._addRowTotalsDynamicColumnDefinitions()):o():"rowTotalsPosition"===e&&(o(),a._addRowTotalsDynamicColumnDefinitions()),a.refresh(t,a._getCurrentDataStructure()),a._originalDynamicColumnsOrder=a._dynamicColumns.map((e=>e.id));break}case"selection":{const e="cell"!==a.selectionMode;e&&a.refresh(void 0,a._getCurrentDataStructure()),l?(a.$.tableContainer.setAttribute("aria-multiselectable",!0),e?a._updateSelectAllState():(a._selectedCells.collection.forEach((e=>e.element.classList.add("selected"))),a._showSelectionDetails(),a.$.main.onscroll=a._mainContainerOnscroll.bind(a))):(a.$.tableContainer.removeAttribute("aria-multiselectable"),e||(a._clearCellSelection(),a.$.main.onscroll=null));break}case"selectionMode":if(super.propertyChangedHandler(e,t,l),"many"===t&&"extended"===l||"many"===l&&"extended"===t)return;"cell"===l?a._selectedIds=[]:a._selectedCells={collection:[]},a.selection&&(a.refresh(void 0,a._getCurrentDataStructure()),a.$.main.onscroll="cell"===l?a._mainContainerOnscroll.bind(a):null);break;default:super.propertyChangedHandler(e,t,l)}}_updateColumns(e){const t=this,l=t._filterInfo.appliedFilters;if(delete t._filterInfo.appliedFilters,t._sortColumns=[],t._clearSortByRow(!0),t._initColumns(),t._designerFiltersApplied)if(e){t._applyingDesignerFilters=!0,t._restoringFilters=!0;for(const e in l)t.addFilter(e,l[e]);delete t._applyingDesignerFilters,delete t._restoringFilters}else t._clearDesignerFilters();t.refresh(!0),t._originalDynamicColumnsOrder=t._dynamicColumns.map((e=>e.id))}_createElement(){const e=this;e.classList.add("smart-table"),e._cellWidth=parseFloat(getComputedStyle(e.$.container).getPropertyValue("--smart-pivot-table-cell-width")),e._autoScrollCoefficient*=2,e._filterInfo={},e._selectedCells={collection:[]},e.$.header={offsetHeight:0},e.$.pager={offsetHeight:0},e.grandTotal&&(e.footerRow="footer",e.freezeFooter=!0),e.selection&&"cell"===e.selectionMode&&(e.$.main.onscroll=e._mainContainerOnscroll.bind(e)),e._setMainContainerMaxHeight(),e._localize(),e._validateDataSource(),e._initColumns(),e.refresh(!0),e.designer&&e._initDesigner(e.$.designerContainer),e._originalDynamicColumnsOrder=(e._dynamicColumns||[]).map((e=>e.id))}_setMainContainerMaxHeight(){const e=getComputedStyle(this.$.container).maxHeight;isNaN(parseFloat(e))||(this.$.main.style.maxHeight=`calc(${e} - 2 * var(--smart-border-width)`)}_validateDataSource(){const e=this,t=e.dataSource;if(!(t instanceof Smart.DataAdapter))if(Array.isArray(e.dataSource)){let l;if(t.length>0){const e=t[0];l=[];for(let t in e){const a=e[t];"number"==typeof a?l.push({name:t,dataType:"number"}):"boolean"==typeof a?l.push({name:t,dataType:"boolean"}):a instanceof Date?l.push({name:t,dataType:"date"}):l.push({name:t,dataType:"string"})}}e.dataSource=new Smart.DataAdapter({dataSource:e.dataSource,dataFields:l})}else e.dataSource=new Smart.DataAdapter({dataSource:[]})}_processPivotColumns(){const e=this,t=e.columnTotals,l=[],a=[],o=[],i=[],r=[];let n,s=e.dataSource;if(0===e._columns.length)return!1;for(let s=0;s<e._columns.length;s++){const d=e._columns[s];d.pivot&&d.allowPivot&&(l.push(d),i.push(d.dataField)),d.rowGroup&&d.allowRowGroup&&(a.push(d),r.push(d.dataField)),d.summary&&(o.push(d),n?t&&n!==d.summary&&e.error(e.localize("sameSummaryFunctionRequired",{example:n})):n=d.summary)}return 0===o.length&&e.error(e.localize("summaryRequired")),e._groupByPrimary=i,e._groupBySecondary=r,e._pivotColumns=l,e._rowGroupColumns=a,e._aggregateColumns=o,e._totalSummaryFunction=n,e.defaultSortByRowGroups&&!e._dataSourceSortedByDefault&&a.length>0&&(s=new Smart.DataAdapter({dataSource:e._defaultSortByRowGroups(s),dataFields:s.dataFields}),e.dataSource=s),s.groupBy=i,s.refreshHierarchy(),e._primaryHierarchy=s.boundHierarchy,e.$.rowGroupBreadcrumb.dataSource=a.map((e=>({label:e.label,value:e}))),e.$.pivotBreadcrumb.dataSource=l.map((e=>({label:e.label,value:e}))),!0}refresh(e,t){const l=this,a=l.isRendered;if(l.columns.canNotify=!1,a&&!t&&(l.$.tableContainer.innerHTML=""),t){const e=l.$.tableContainer.firstElementChild,a=document.createDocumentFragment();e.innerHTML="",l._createHeaderCells(t,a),e.appendChild(a)}else{if(!l._processPivotColumns())return;l._createHeader()}l._hideColumnTotalsBorder(),e&&(l._selectedCells={collection:[]},l._createAggregatesSource(),l._applyInitialConditionalFormatting(l.rows)),l._createDataRows(!t);const o=l._sortColumns;a&&(e||t)&&o&&(delete l._sortColumns,o.forEach((e=>{const t=l._getDynamicColumnById[e.dataField];t&&(delete t.sortOrder,l.sortBy(t,e.direction))}))),l.columns.canNotify=!0}_createHeader(){const e=this,t=e.columnTotals,l=e.columnTotalsPosition,a=document.createElement("thead"),o=document.createDocumentFragment(),i=e._pivotColumns.length,r=[];function n(l,a,o){if(t)for(let t=0;t<=i;t++)t<l?r[t].push(a[t]):t===l?r[t].push(o.label):t===i?r[t].push(`TL="${l}"${e._totalSummaryFunction}(${e.localize("total")})`):r[t].push("")}function s(l){const a=e._aggregateColumns;return t&&0===l&&r[0].push(`TL="0"${e._totalSummaryFunction}(${e.localize("total")})`),a.forEach((e=>{r[l].push(`${e.summary}(${e.label})`)})),a.length}for(let e=0;e<=i;e++)r.push([]);i>0?function t(a,o,i){let d=0;for(let c=0;c<a.length;c++){const u=a[c];let m=0;e._filterInfo.appliedFilters&&!e._areChildrenFiltered(void 0,u.children)||("near"===l&&n(o,i,u),u.children&&u.children.length>0&&!0!==u.children[0].leaf?m+=t(u.children,o+1,i.concat([u.label])):m+=s(o+1),"far"===l&&n(o,i,u),r[o].push(...Array(m).fill(u.label)),d+=m)}return d}(e._primaryHierarchy,0,[]):s(0),e._createDynamicColumnDefinitions(r),e._createHeaderCells(r,o),a.appendChild(o),e.$.tableContainer.appendChild(a)}_createDynamicColumnDefinitions(e){const t=this,l=e[e.length-1].length,a=[],o=[],i={};let r=-1;t._dynamicColumns=a,t._dynamicDataFields=o,t._getDynamicColumnById=i;for(let n=0;n<l;n++){const l=e[e.length-1][n];if(t._createTotalColumnDefinition(l,e,n))continue;const s={dataFields:[]},d=[];r++;for(let l=0;l<e.length-1;l++){const a=e[l][n],o=t._pivotColumns[l],i={originalColumn:o,label:a,dataField:o.dataField};s.dataFields.push(i),d.push(a),e[l][n]={label:a,columnDefinition:s,info:i}}const c=t._aggregateColumns[r%t._aggregateColumns.length],u={originalColumn:c,label:l,dataField:c.dataField,summary:c.summary};s.dataFields.push(u),d.push(c.dataField),e[e.length-1][n]={label:l,columnDefinition:s,info:u},s.id=d.join(",").replace(/[ ,]/g,"_"),a.push(s),o.push({name:s.id,dataType:"any"}),i[s.id]=s}if(t._rowGroupColumns.length>0){const e=t.localize("groupHeader"),l={dataFields:t._rowGroupColumns.map((t=>({originalColumn:t,label:e}))),id:"pivotgroup",label:e,group:!0};let r;a.unshift(l),i.pivotgroup=l;for(let e=0;e<l.dataFields.length&&(r=l.dataFields[e].originalColumn.dataType,"string"!==r);e++);o.push({name:"pivotgroup",dataType:r}),o.push({name:"count",dataType:"number"})}t._setColumnTotalsRelations(),t._addRowTotalsDynamicColumnDefinitions(),t.$.tableContainer.removeAttribute("aria-colcount")}_createTotalColumnDefinition(e,t,l){const a=this,o=/TL="(\d+)"/.exec(e);if(!o)return!1;const i=parseFloat(o[1]),r={dataFields:[]},n=[];e=e.replace(/TL="(\d+)"/,"");for(let e=0;e<t.length-1;e++){if(e>i){t[e][l]=Object.assign({},t[e-1][l],{label:""});continue}const o=t[e][l],s=a._pivotColumns[e],d={originalColumn:s,label:o,dataField:s.dataField};r.dataFields.push(d),n.push(o),t[e][l]={label:o,columnDefinition:r,info:d}}return n.push("TOTAL"),r.columnTotal=!0,r.emptyCells=[],r.expanded=!1,r.id=n.join(",").replace(/[ ,]/g,"_"),r.pivotLevel=i,t[t.length-1][l]={label:e,columnDefinition:r,info:{originalColumn:{},label:e,dataField:"TOTAL"}},a._dynamicColumns.push(r),a._dynamicDataFields.push({name:r.id,dataType:"any"}),a._getDynamicColumnById[r.id]=r,!0}_setColumnTotalsRelations(){const e=this;if(!e.columnTotals)return;const t=e._dynamicColumns;for(let l=0;l<e._dynamicColumns.length;l++){const a=e._dynamicColumns[l];if(!a.columnTotal)continue;const o=a.id.replace("_TOTAL","");let i;0===e._pivotColumns.length?(a.expanded=!0,i=t.filter((e=>{if(!e.columnTotal&&!e.group)return e.parent=a,!0}))):i=a.pivotLevel===e._pivotColumns.length-1?t.filter((e=>{if(!e.columnTotal&&0===e.id.indexOf(o))return e.parent=a,!0})):t.filter((e=>{if(e.columnTotal&&e.pivotLevel===a.pivotLevel+1&&0===e.id.indexOf(o))return e.parent=a,!0})),a.children=i}}_addRowTotalsDynamicColumnDefinitions(){const e=this;if(!e.rowTotals||0===e._pivotColumns.length)return;const t=[];e._aggregateColumns.forEach((l=>{const a=l.dataField,o="TOTAL_"+a,i={dataFields:[{originalColumn:l,label:`${l.summary}(${l.label})`,dataField:a,summary:l.summary}],id:o,rowTotal:!0};t.push(i),e._getDynamicColumnById[o]=i,e._dynamicDataFields.push({name:o,dataType:"any"})})),"near"===e.rowTotalsPosition?e._dynamicColumns.splice(0+Number(e._rowGroupColumns.length>0),0,...t):e._dynamicColumns.push(...t)}_createHeaderCells(e,t){const l=this,a=e[e.length-1].length,o=l.columnTotals,i=l.selection&&"cell"!==l.selectionMode,r=l.onColumnRender,n=l.rowTotalsPosition,s=l._rowGroupColumns.length>0,d=l._cellWidth;function c(t,l){if(0===l)return!0;let a=t,o=!1;for(;a>=0&&!o;){const t=e[a][l-1],i=e[a][l];o=t.label!==i.label||JSON.stringify(t.info)!==JSON.stringify(i.info),a--}return o}for(let u=0;u<e.length;u++){const m=document.createElement("tr"),p=e[u];if(i)if(u===e.length-1)m.innerHTML='<th class="smart-pivot-table-selection-header smart-table-select-all freeze-near"><div role="checkbox" aria-checked="false" aria-label="Toggle selection of all rows"></div></th>';else{const e=document.createElement("th");0===u&&(e.style.width=getComputedStyle(l.$.container).getPropertyValue("--smart-table-row-height")),e.classList.add("smart-pivot-table-selection-header","freeze-near"),m.appendChild(e)}s&&l._createGroupHeaderCells(u,e,m),"near"===n&&l._createRowTotalsHeaders(u,e,m);const g={};for(let t=0;t<a;t++){let i=p[t],n=i.label,s=i.columnDefinition;if(void 0===n)break;const f=document.createElement("th");if(c(u,t)){if(g.cell&&!o&&(g.span>1&&(g.cell.colSpan=g.span),0===u&&(g.cell.style.width=d*g.span+"px")),t===a-1&&0===u?o||(f.style.width=d+"px"):(g.cell=f,g.span=1),f.columnDefinition=s,s.columnTotal&&""===n)s.emptyCells.push(f),f.classList.add("empty");else if(r){const e={text:n,cell:f,column:i.info,fullDefinition:s};l.onColumnRender(e),n=e.text}u===e.length-1&&(l._addSortingCapability(f,s),n=`<div class="wrapper" role="presentation"><div class="label">${n}</div></div>`),i.info&&i.info.originalColumn&&i.info.originalColumn.align&&f.classList.add("align-"+i.info.originalColumn.align),f.innerHTML=n,o&&l._processColumnTotalsHeaderCells(f,s,u),m.appendChild(f)}else g.span++,t!==a-1||o||(g.cell.colSpan=g.span,0===u&&(g.cell.style.width=d*g.span+"px"))}"far"===n&&l._createRowTotalsHeaders(u,e,m),t.appendChild(m)}}_createGroupHeaderCells(e,t,l){const a=this,o="classic"===a.groupLayout,i=o?a._rowGroupColumns.length:1;for(let r=0;r<i;r++){const i=document.createElement("th");if(i.classList.add("smart-pivot-table-grouping-header"),e===t.length-1){const e=a._dynamicColumns[0];let t=o?e.dataFields[r].originalColumn.label:a.localize("groupHeader");if(a.onColumnRender){const l={text:t,cell:i,column:e.dataFields[0],fullDefinition:e};a.onColumnRender(l),t=l.text}if(0===r)a._addSortingCapability(i,e),t=`<div class="wrapper" role="presentation"><div class="label">${t}</div></div>`;else if(o&&a.enableSortByRowGroups){const l=JSON.parse(JSON.stringify(a._dynamicColumns[0]));l.dataFields=[],l.dataFields.push(e.dataFields[r]),l.headerCellElement=i,l.cell=i,l.id=e.dataFields[r].originalColumn.dataField,l.label=e.dataFields[r].originalColumn.label,a._getDynamicColumnById[l.id]=l,a._addSortingCapability(i,l),t=`<div class="wrapper" role="presentation"><div class="label">${t}</div></div>`}i.innerHTML=t}l.appendChild(i)}}_processColumnTotalsHeaderCells(e,t,l){const a=this,o=a.columnTotalsPosition;if(l<a._pivotColumns.length&&!e.classList.contains("empty")){const i=document.createElement("div");if(i.className="total-arrow smart-arrow smart-arrow-right",i.setAttribute("role","button"),i.setAttribute("aria-label","Toggle column"),!a.keyboardNavigation||a.disabled||a.unfocusable||(i.tabIndex=0),e.appendChild(i),"far"!==o||t.columnTotal)e.controller=t;else{let o=a._pivotColumns.length,i=t;for(;o>l;)i=i.parent,o--;e.controller=i}e.controller.arrowCell=e,a._getColumnTotalColspan(e)}const i=function e(t){return!!t.parent&&(!t.parent.expanded||e(t.parent))}(t);t.hidden=i,"near"===o?(e.classList.toggle("smart-hidden",i),e.classList.toggle("expanded",t.expanded)):(e.controller&&t!==e.controller||e.classList.toggle("smart-hidden",i),t.arrowCell&&t.arrowCell!==e&&(t.arrowCell.classList.toggle("smart-hidden",i),t.arrowCell.classList.toggle("expanded",t.expanded)))}_getColumnTotalColspan(e){const t=function e(t){let l=1;if(t.expanded)for(let a=0;a<t.children.length;a++){const o=t.children[a];o.columnTotal?l+=e(o):l+=1}return l}(e.controller);t>1?e.colSpan=t:e.removeAttribute("colspan"),e.style.width=this._cellWidth*t+"px"}_createRowTotalsHeaders(e,t,l){const a=this;if(a.rowTotals&&0!==a._pivotColumns.length)for(let o=0;o<a._aggregateColumns.length;o++){const i=a._getDynamicColumnById["TOTAL_"+a._aggregateColumns[o].dataField],r=document.createElement("th");if(r.classList.add("smart-pivot-table-total-header"),e===t.length-1){let e=i.dataFields[0].label;if(a.onColumnRender){const t={text:e,cell:r,column:i.dataFields[0],fullDefinition:i};a.onColumnRender(t),e=t.text}r.innerHTML=`<div class="wrapper" role="presentation"><div class="label">${e}</div></div>`,a._addSortingCapability(r,i)}l.appendChild(r)}}_createAggregatesSource(){const e=this,t=e.dataSource,l=e.hideEmptyRows,a=e.nullDefaultValue,o=e._aggregateColumns,i=[],r=[],n={id:0,totals:[]},s=[],d=e._selectedIds.slice(0);let c;for(let e=0;e<o.length;e++){const t=o[e],l={};l[t.dataField]=[t.summary],r.push(l)}function u(t,l){for(let a=e._groupByPrimary.length-1;a>=0;a--){const o=t[e._groupByPrimary[a]],i=l[e._groupByPrimary[a]];if(o instanceof Date){if(o.getTime()!==i.getTime())return!1}else if(o!==i)return!1}return!0}function m(l,a,o,i){if(0!==e._pivotColumns.length)for(let n=0;n<l.length;n++){const s=l[n];if(s.children&&s.children.length>0&&!0!==s.children[0].leaf)m(s.children,a,o,i.concat([s.label]));else{const l=a.children.filter((e=>!1!==e.$.filtered&&(!c||u(s.data,e))));if(0===l.length)continue;const n=i.concat([s.label]).filter((e=>void 0!==e)),d=t.summarize(r,l);e._setRowValue(o,n,d,l)}}else{const l=a.children.filter((e=>!1!==e.$.filtered));if(l.length>0){const a=t.summarize(r,l);e._setRowValue(o,i,a,l)}}}if(e._originalRecords={},0===e._rowGroupColumns.length?(function l(a,o){if(0!==e._pivotColumns.length)for(let i=0;i<a.length;i++){const s=a[i];if(s.children&&s.children.length>0){const a=o.concat([s.label]);if(!0!==s.children[0].leaf)l(s.children,a);else{const l=s.children.filter((e=>!1!==e.$.filtered));if(0===l.length)continue;const o=t.summarize(r,l);e._setRowValue(n,a,o,l)}}}else{const l=e.dataSource.toArray().filter((e=>!1!==e.$.filtered));if(0===l.length)return;const a=t.summarize(r,l);e._setRowValue(n,o,a,l)}}(e._primaryHierarchy,[]),i.push(n),s.push(n.id)):(c=e._groupByPrimary[e._groupByPrimary.length-1],function a(o,r,n){let d=e._getSecondaryHierarchy(o);if(r)for(let e=0;e<n.length;e++)d=d[n[e]].children;d.forEach(((d,c)=>{let u=d.children.length;if(e._filterInfo.appliedFilters&&(u=e._areChildrenFiltered(void 0,d.children),!1===d.data.$.filtered&&!u))return;const p={},g=new Smart.DataAdapter({dataSource:d.children,dataFields:t.dataFields,groupBy:e._groupByPrimary});if(r&&(p.parentid=r.id),p.id=(r?r.id:"")+d.label+o,p.level=o,p.totals=[],s.push(p.id),m(g.boundHierarchy||g,d,p,[]),l){let e=!0;for(const t in p){if(-1!==["children","count","expanded","pivotgroup","group","id","level","parent","parentid","totals","tr"].indexOf(t))continue;const l=p[t];if(0!==l&&null!==l){e=!1;break}}if(e)return void(r&&(r.hiddenChildren?r.hiddenChildren++:r.hiddenChildren=1))}i.push(p),o<e._groupBySecondary.length-1&&a(o+1,p,n.concat([c])),p.hiddenChildren&&(u-=p.hiddenChildren,delete p.hiddenChildren),p[e._dynamicColumns[0].id]=d.label,p.count=u}))}(0,void 0,[])),e._setRowTotalsSource(i,r),e._setColumnTotalsSource(i),null!==a)for(const t of i)for(const l of e._dynamicDataFields)void 0===t[l.name]&&(t[l.name]=a);if(e.rows=new Smart.DataAdapter({dataSource:i,id:"id",keyDataField:"id",parentDataField:"parentid",dataFields:e._dynamicDataFields}),!e.isRendered&&e.onInit&&e.onInit(),d.length>0){const t=[];for(let e=0;e<d.length;e++)-1!==s.indexOf(d[e])&&t.push(d[e]);e._selectedIds=t}delete e._selectionStart,e.selection&&"cell"!==e.selectionMode&&e._updateSelectAllState()}_setRowValue(e,t,l,a){const o=this;let i=[];o._aggregateColumns.forEach((r=>{const n=r.dataField,s=l[n][r.summary],d=t.concat([n]).join(",").replace(/[ ,]/g,"_");e[d]=s,o._originalRecords[e.id+d]=a,i.push({dataPoint:s})})),e.totals=e.totals.concat(a)}_setRowTotalsSource(e,t){const l=this;if(!l.rowTotals||0===l._pivotColumns.length)return;const a=new Smart.DataAdapter({dataSource:[],dataFields:l.dataSource._dataFields});for(let o=0;o<e.length;o++){const i=e[o],r=i.id,n=i.totals,s=a.summarize(t,n);for(let e in s)i["TOTAL_"+e]=Object.values(s[e])[0],l._originalRecords[r+"TOTAL_"+e]=n;delete i.totals}}_setColumnTotalsSource(e){const t=this;if(!t.columnTotals)return;const l=t._dynamicColumns.filter((e=>e.columnTotal)),a=new Smart.DataAdapter({dataSource:[],dataFields:[{name:"dataPoint"}]});for(let o=0;o<e.length;o++){const i=e[o],r=i.id;for(let e=0;e<l.length;e++){const o=l[e],n=t._getColumnTotalsOriginalRecords(o,r);0!==n.length&&(t._originalRecords[r+o.id]=n,i[o.id]=t._getTotalSummary(n,a))}}}_getTotalSummary(e,t){const l=[];return this._aggregateColumns.forEach((t=>{e.forEach((e=>{l.push({dataPoint:e[t.dataField]})}))})),t.summarize([{dataPoint:[this._totalSummaryFunction]}],l).dataPoint[this._totalSummaryFunction]}_getSecondaryHierarchy(e){const t=this.dataSource;return t.groupBy=this._groupBySecondary.slice(0,e+1),t.refreshHierarchy(),t.boundHierarchy}_createDataRows(e){const t=this,l=t.rows.boundHierarchy,a=document.createDocumentFragment(),o={collection:[]};let i,r;l&&l.length>0&&("default"===t.groupLayout?t._createRowElements(l,a,o):(t._expanded=[],t._hidden={},t._rowGroupColumns.forEach(((e,l)=>{t._expanded.push([]),t._hidden[l]=!1})),t._createRowElementsClassic(l,a,o))),a.appendChild(t._createLastRow()),e?(i=document.createElement("tbody"),t.$.tableContainer.appendChild(i)):(i=t.$.tableContainer.querySelector("tbody"),i.innerHTML=""),i.appendChild(a),"classic"===t.groupLayout&&(t._updateGroupColumnsVisibility(),t._updateDisplayedRecordsVisibility(t.rows.boundHierarchy),t._updateDisplayedRecordsUIVisibility(t.rows.boundHierarchy)),t._createGrandTotalRow(l,e),t._selectedCells=o,t.selection&&"cell"===t.selectionMode&&(r=!0,t._showSelectionDetails()),t.getRootNode().activeElement===t.$.tableContainer&&(r&&o.start?super._focusCell(o.start.element):t._tableContainerFocusHandler())}_createRowElements(e,t,l){const a=this,o=a.selection&&"cell"!==a.selectionMode,i=a._dynamicColumns;for(let r=0;r<e.length;r++){const n=document.createElement("tr"),s=e[r],d=s.level;if(s.tr=n,n.data=s,o){const e=document.createElement("td"),t=-1!==a._selectedIds.indexOf(s.$.id);e.className="smart-table-select-row freeze-near"+(t?" selected":""),e.innerHTML=`<div class="selection-checkbox" role="checkbox" aria-checked="${t}" aria-label="Toggle row selection"></div>`,n.appendChild(e),n.setAttribute("aria-selected",t)}for(let e=0;e<i.length;e++){const t=document.createElement("td"),o=i[e],r=s[o.id];let c,u,m=r;if(a._restoreSelectedCells(t,o,s,m,l),0===e&&o.group){const e=s.leaf;c=o.dataFields[d].originalColumn,m=a._formatCellValue(s,c,t,m),a.rowSummary&&(m=`${m}<span class="group-label-count"> (${s.count})</span>`),e||(t.classList.add("tree-cell"),u=!0),d>0&&(t.classList.add("outline-level-"+d),e&&t.classList.add("tree-leaf")),c.align&&t.classList.add("align-"+c.align),s.sortOrder&&(t.classList.add("sort-by",s.sortOrder),t.setAttribute("aria-sort",s.sortOrder+"ending"))}else c=o.columnTotal?a._aggregateColumns[0]:o.dataFields[o.dataFields.length-1].originalColumn,m=a._formatSummaryValue(s,c,t,m);a.onCellRender&&a.onCellRender(s,o,r,t),a._applyConditionalFormattingToCell(t,o.id,s.$.index),t.setAttribute("data-field",o.id),t.classList.toggle("smart-hidden",!0===o.hidden),a._setCellContent(t,m,u),n.appendChild(t)}s.expanded&&(n.setAttribute("aria-expanded",!0),n.classList.add("expanded")),d>0&&a._isCollapsed(s)&&(n.setAttribute("aria-hidden",!0),n.classList.add("collapsed","smart-hidden")),n.setAttribute("row-id",s.$.id),t.appendChild(n),s.children&&s.children.length>0&&a._createRowElements(s.children,t,l)}}_restoreSelectedCells(e,t,l,a,o){const i=this._selectedCells;if(0===i.collection.length)return;if(!i.collection.find((e=>e.dataField===t.id&&e.rowData.$.id===l.$.id)))return;const r={dataField:t.id,element:e,row:l.tr,rowData:l,value:a};o.collection.push(r),r.dataField===i.start.dataField&&r.rowData.$.id===i.start.rowData.$.id&&(o.start=r),r.dataField===i.end.dataField&&r.rowData.$.id===i.end.rowData.$.id&&(o.end=r),this.selection&&e.classList.add("selected")}_createRowElementsClassic(e,t,l){const a=this,o=a.selection&&"cell"!==a.selectionMode,i=a._dynamicColumns;for(let r=0;r<e.length;r++){const n=e[r],s=n.level;if(s>0&&0===r){n.expanded&&a._expanded[s].push(n),n.children&&n.children.length>0&&a._createRowElementsClassic(n.children,t,l);continue}const d=document.createElement("tr");let c=a._getRecordToDisplay(n);if(n.tr=d,d.data=n,n.expanded&&(d.setAttribute("aria-expanded",!0),d.classList.add("expanded"),a._expanded[s].push(n)),s>0&&a._isCollapsed(n)&&(d.setAttribute("aria-hidden",!0),d.classList.add("collapsed","smart-hidden")),o){const e=document.createElement("td"),t=-1!==a._selectedIds.indexOf(n.$.id);e.className="smart-table-select-row freeze-near"+(t?" selected":""),e.innerHTML=`<div class="selection-checkbox" role="checkbox" aria-checked="${t}" aria-label="Toggle row selection"></div>`,d.appendChild(e),d.setAttribute("aria-selected",t)}for(let e=0;e<i.length;e++){const t=i[e];let o,r=n[t.id],s=r;if(0===e&&t.group){a._createGroupCellsClassic(d,n,t,r,l);continue}const u=document.createElement("td");r=c[t.id],s=r,a._restoreSelectedCells(u,t,n,s,l),o=t.columnTotal?a._aggregateColumns[0]:t.dataFields[t.dataFields.length-1].originalColumn,s=a._formatSummaryValue(c,o,u,s),a.onCellRender&&a.onCellRender(c,t,r,u),a._applyConditionalFormattingToCell(u,t.id,c.$.index),u.setAttribute("data-field",t.id),u.classList.toggle("smart-hidden",!0===t.hidden),a._setCellContent(u,s),d.appendChild(u)}d.setAttribute("row-id",n.$.id),t.appendChild(d),n.children&&n.children.length>0&&a._createRowElementsClassic(n.children,t,l)}}_updateGroupColumnsVisibility(){const e=this,t=e._expanded;function l(e){return!e.parent||!!e.parent.expanded&&l(e.parent)}if(!(t.length<2)){for(let a=0;a<t.length-1;a++){const o=t[a],i=a+1;let r=0;if(o.forEach((e=>r+=Number(l(e)))),0===r&&!e._hidden[i]||r>0&&e._hidden[i]||e._hidden[a]&&!e._hidden[i]){e._hidden[i]=!e._hidden[i];const t=Array.from(e.$.tableContainer.querySelectorAll(`.smart-pivot-table-grouping-header:nth-child(${i+1+Number(e.selection&&"cell"!==e.selectionMode)})`)).concat(Array.from(e.$.tableContainer.querySelectorAll(`td[data-field="group${i}"]`)));e._hidden[i]?t.forEach((e=>e.classList.add("smart-hidden"))):t.forEach((e=>e.classList.remove("smart-hidden")))}}if(e._focusedCell&&e._focusedCell.classList.contains("smart-hidden")&&-1!==e._focusedCell.getAttribute("data-field").indexOf("pivotgroup")){let t=e._focusedCell.previousElementSibling;for(;t.classList.contains("smart-hidden");)t=t.previousElementSibling;e._focusCell(t)}}}_getRecordToDisplay(e){return e.leaf||!e.expanded?e:this._getRecordToDisplay(e.children[0])}_getFirstChildAtLevel(e,t){let l=t.children[0];for(;l.children&&l.level!==e;)l=l.children[0];return l}_createGroupCellsClassic(e,t,l,a,o){const i=this,r=i._rowGroupColumns.length,n=t.level;for(let s=0;s<r;s++){const r=document.createElement("td");if(i._restoreSelectedCells(r,l,t,a,o),r.setAttribute("data-field","pivotgroup"+s),e.appendChild(r),s<n)continue;let d,c=t,u=l.dataFields[s].originalColumn;s>n?(c=i._getFirstChildAtLevel(s,t),a=c[l.id]):r.classList.add("main"),c.cell=r,c.sortOrder&&(r.classList.add("sort-by",c.sortOrder),r.setAttribute("aria-sort",c.sortOrder+"ending"));let m=a;m=i._formatCellValue(c,u,r,m),i.rowSummary&&(m=`${m}<span class="group-label-count"> (${c.count})</span>`),c.leaf||(r.data=c,d=!0,r.classList.add("tree-cell"),c.expanded&&r.classList.add("expanded","main")),u.align&&r.classList.add("align-"+u.align),i.onCellRender&&i.onCellRender(c,l,a,r),i._applyConditionalFormattingToCell(r,l.id,t.$.index),i._setCellContent(r,m,d)}}_createGrandTotalRow(e,t){const l=this;if(!l.grandTotal||0===l._rowGroupColumns.length||!e)return;const a=l.columnTotals,o=l._dynamicColumns,i=a?new Smart.DataAdapter({dataSource:[],dataFields:[{name:"dataPoint"}]}):void 0,r=document.createElement("tr"),n={grandTotal:!0};let s;function d(e){const t=[{}],o=e.dataFields[e.dataFields.length-1],i=o.dataField;return t[0][i]=[a?l._totalSummaryFunction:o.summary],t}if(l.selection&&"cell"!==l.selectionMode){const e=document.createElement("td");e.className="freeze-near",r.appendChild(e)}for(let t=0;t<o.length;t++){const a=document.createElement("td"),s=o[t];let c,u,m;if(0===t&&s.group)c=l.localize("grandTotal"),u=c,l._sortRow&&l._sortRow.grandTotal&&(n.sortOrder=l._sortRow.sortOrder,l._sortRow=n,a.classList.add("sort-by",n.sortOrder),a.setAttribute("aria-sort",n.sortOrder+"ending"));else{const t=s.columnTotal?l._aggregateColumns[0]:s.dataFields[s.dataFields.length-1].originalColumn;let o=[];for(let t=0;t<e.length;t++){const a=l._originalRecords[e[t].id+s.id];a&&(o=o.concat(a))}0!==o.length&&(s.columnTotal?(m=l._getTotalSummary(o,i),c=m):(m=l.rows.summarize(d(s),o),c=Object.values(Object.values(m)[0])[0]),l._originalRecords["GRAND_TOTAL"+s.id]=o),u=c,void 0!==m&&void 0!==u&&(u=l._formatSummaryValue(m,t,a,u))}if(l.onCellRender&&l.onCellRender(m,s,c,a),n[s.id]=void 0!==c?c:0,a.setAttribute("data-field",s.id),a.classList.toggle("smart-hidden",!0===s.hidden),l._setCellContent(a,u),r.appendChild(a),0===t&&s.group&&"classic"===l.groupLayout){a.setAttribute("data-field","pivotgroup0");for(let e=1;e<l._rowGroupColumns.length;e++){const t=document.createElement("td");t.setAttribute("data-field","pivotgroup"+e),l._hidden[e]&&t.classList.add("smart-hidden"),r.appendChild(t)}}}r.classList.add("grand-total"),r.data=n,t?(s=document.createElement("tfoot"),l.$.tableContainer.appendChild(s)):(s=l.$.tableContainer.querySelector("tfoot"),s.innerHTML=""),s.appendChild(r)}_updateGrandTotalRow(){const e=this;if(!e.grandTotal||0===e._rowGroupColumns.length)return;const t=e._dynamicColumns,l=e.querySelector("tfoot .grand-total");for(let a=0;a<t.length;a++){const o=t[a];if(0===a&&o.group&&"classic"===e.groupLayout)for(let t=1;t<e._rowGroupColumns.length;t++){const a=l.children[t];e._hidden[t]?a.classList.add("smart-hidden"):a.classList.remove("smart-hidden")}}}_formatSummaryValue(e,t,l,a){const o=this;let i=t.summarySettings;if(t.formatFunction||!i)return o._formatCellValue(e,t,l,a);if(i.align&&l.classList.add("align-"+i.align),isNaN(a)||""===a|null===a)return o._formatCellValue(e,t,l,a);let r=a;if(void 0!==i.decimalPlaces||void 0!==i.thousandsSeparator&&""!==i.thousandsSeparator||void 0!==i.decimalSeparator){const e=new Smart.Utilities.NumberRenderer(a);let t="F";void 0!==i.thousandsSeparator&&""!==i.thousandsSeparator&&(e.localizationObject.thousandsseparator=i.thousandsSeparator,t="N"),void 0!==i.decimalSeparator&&(e.localizationObject.decimalseparator=i.decimalSeparator),isNaN(i.decimalPlaces)&&(i.decimalPlaces=e.localizationObject.defaultPrecision),r=e.formatNumber(a,t+i.decimalPlaces)}return!0===i.negativesInBrackets&&a<0&&(r=`(${r.toString().replace("-","")})`),void 0!==i.prefix&&(r=i.prefix.toString()+r),o._formatCellValue(e,t,l,r)}_overriddenTableHandler(){}_hierarchyArrowClickHandler(e,t,l){const a=this;let o,i,r;function n(e){e.forEach((e=>{const t=e.children;a._expandSingleChildRow(e.tr),t&&e.expanded&&requestAnimationFrame((()=>n(t)))}))}if("classic"===a.groupLayout){for(t=t&&t.data?t:Array.from(e.querySelectorAll('td[data-field^="pivotgroup"]')).find((e=>e.data));!t.classList.contains("main")&&!t.previousElementSibling.classList.contains("expanded");)t=t.previousElementSibling;o=t.data;const l=o.level;r=o.children,i=!o.expanded,o.expanded=i,0===l?(e.setAttribute("aria-expanded",i),e.classList.toggle("expanded",i)):l>0&&o===o.parent.children[0]&&t.classList.toggle("main",i);let n=o.children[0],s=t.nextElementSibling;for(;n&&!n.leaf&&n.expanded;)s.classList.toggle("main",i),n=n.children[0],s=t.nextElementSibling;t.classList.toggle("expanded",i),i?a._expanded[l].push(o):a._expanded[l]=a._expanded[l].filter((e=>e!==o)),a._updateDisplayedRecord(o,e),a._updateGroupColumnsVisibility(),a._updateDisplayedRecordsVisibility(a.rows.boundHierarchy),a._updateDisplayedRecordsUIVisibility(a.rows.boundHierarchy),a._updateGrandTotalRow()}else o=e.data,r=o.children,i=!o.expanded,o.expanded=i,e.setAttribute("aria-expanded",i),e.classList.toggle("expanded",i);if(i?(requestAnimationFrame((()=>n(r))),a.$.fireEvent("expand",{record:o})):(function e(t){t.forEach((t=>{const l=t.children;a._collapseSingleChildRow(t.tr),l&&e(l)}))}(r),a.$.fireEvent("collapse",{record:o})),l&&"cell"===a.selectionMode){const e=a._selectedCells.collection;e.length>1&&(a._selectedCells.isDirty=!0),e.forEach(((t,l)=>{e[l]=a._getCellInfo(t.element)})),a._selectedCells.start&&(a._selectedCells.start=a._getCellInfo(a._selectedCells.start.element)),a._selectedCells.end&&(a._selectedCells.end=a._getCellInfo(a._selectedCells.end.element)),"none"!==a.animation?a.$.tableContainer.ontransitionend=function(){requestAnimationFrame(a._showSelectionDetails.bind(a)),a.$.tableContainer.ontransitionend=null}:requestAnimationFrame(a._showSelectionDetails.bind(a))}}_updateDisplayedRecord(e,t){const l=this;if("classic"!==l.groupLayout)return;const a=l._getRecordToDisplay(e);for(let e=0;e<l._dynamicColumns.length;e++){const o=l._dynamicColumns[e],i=o.id;if("pivotgroup"===i)continue;const r=t.querySelector('td[data-field="'+i+'"]'),n=o.columnTotal?l._aggregateColumns[0]:o.dataFields[o.dataFields.length-1].originalColumn;let s=a[o.id];s=l._formatSummaryValue(a,n,r,s),r.style.backgroundColor=null,r.style.color=null,r.style.fontFamily=null,r.style.fontSize=null,l._applyConditionalFormattingToCell(r,o.id,a.$.index),l._setCellContent(r,s)}}_updateDisplayedRecordsUIVisibility(e){const t=this;if("classic"!==t.groupLayout)return;const l=t._rowGroupColumns.length;for(let a=0;a<e.length;a++){const o=e[a];let i=t._getRecordToDisplay(o),r=i.tr;if((!r||r&&!r.parentNode)&&i.parent){r=i.parent.tr;let e=i.parent;for(;e&&(r=e.tr,!r);)e=e.parent}o.level>0&&l>1&&o.level<=l-1&&((()=>{let e=o.parent,t=e.expanded;for(;e;)!1===e.expanded&&(t=!1),e=e.parent;return t})()?r.children[o.level].style.color="":r.children[o.level].style.color="rgba(0,0,0,0)"),o.children&&o.children.length>0&&t._updateDisplayedRecordsUIVisibility(o.children)}}_updateDisplayedRecordsVisibility(e){const t=this;if("classic"!==t.groupLayout)return;const l=t._dynamicColumns;for(let a=0;a<e.length;a++){const o=e[a];if(o.level>0&&0===a){o.children&&o.children.length>0&&t._updateDisplayedRecordsVisibility(o.children);continue}let i=t._getRecordToDisplay(o),r=i.tr;if((!r||r&&!r.parentNode)&&i.parent){r=i.parent.tr;let e=i.parent;for(;e&&(r=e.tr,!r);)e=e.parent}for(let e=0;e<l.length;e++){const a=l[e];0===e&&a.group&&r&&t._updateGroupCellsClassic(r,o)}o.children&&o.children.length>0&&t._updateDisplayedRecordsVisibility(o.children)}}_updateGroupCellsClassic(e,t){const l=this,a=l._rowGroupColumns.length,o=t.level;for(let t=0;t<a;t++){const a=e.children[t];t<o||(l._hidden[t]?a.classList.add("smart-hidden"):a.classList.remove("smart-hidden"))}}_addSortingCapability(e,t){const l=this;t.cell=e,"pivotgroup"!==t.id&&e.setAttribute("data-field",t.id),0!==l._rowGroupColumns.length&&(t.headerCellElement=e,e.onclick=function(){const a=t.dataFields[t.dataFields.length-1].originalColumn;l.$.fireEvent("columnClick",{columnDefinition:t,dataField:a.dataField}),"none"===l.sortMode||!1===a.allowSort||l._preventClickSort||(l._addSortIconContainer(t),e.sortIconContainerElement.classList.contains("asc")?l.sortBy(t,"desc"):e.sortIconContainerElement.classList.contains("desc")?l.sortBy(t,null):l.sortBy(t,"asc"))})}_sortCallback(e,t,l){const a=this,o=a.rows;if(a._rowGroupColumns.length>0&&a.enableSortByRowGroups){const l=e[0],i=a._rowGroupColumns.find((e=>e.dataField===l?e:null));if(i){i.sortOrder=t[0];const e=a._rowGroupColumns.indexOf(i);for(let l=0;l<o.length;l++){const a=o[l];if(a.children.length>0&&a.level===e-1){const e=Smart.DataAdapter.Sort(a.children,["pivotgroup"],t);a.children=e}}return void a._createDataRows()}}o._sort(o.boundSource,e,t,l),o.refreshHierarchy(),a._createDataRows()}_selectAllCheckboxClickHandler(e){super._selectAllCheckboxClickHandler(e,this.rows)}_updateSelectAllState(){super._updateSelectAllState(this.rows.length)}_refreshFilters(e){const t=this,l=[];for(const e in t._filterInfo.appliedFilters){let a=t._filterInfo.appliedFilters[e];l.push([e,a])}0!==l.length?(t.dataSource._filter(l,t._applyingDesignerFilters?"and":"or"),t._applyingDesignerFilters||t.refresh(!0),t._restoringFilters&&t.$.fireEvent("filter",{action:e,filters:l})):t.clearFilters()}_areChildrenFiltered(e,t){if(1===arguments.length&&(t=e.children),!t||0===t.length)return;let l=0;for(let e=0;e<t.length;e++)!1===t[e].leaf?l+=this._areChildrenFiltered(void 0,t[e].children)?1:0:!1!==t[e].$.filtered&&l++;return l}_localize(){const e=this;e.$.rowGroupBreadcrumb.placeholder=e.localize("dragHereRowGroups"),e.$.pivotBreadcrumb.placeholder=e.localize("dragHerePivots"),e.$.conditionalFormattingButton.setAttribute("tooltip",e.localize("conditionalFormatting")),e.$.fieldsButton.setAttribute("tooltip",e.localize("fields"))}_columnNotify(e){const t=this,l=e.propertyName,a=e.target;switch(l){case"allowFilter":{const l=t._designer;if(l&&l._filtersViewInitialized){const o=Array.from(l.$.filtersView.querySelectorAll("smart-filter-panel")).find((e=>e.column.dataField===a.dataField));o&&(!1===e.newValue?(o.closest("smart-accordion-item.filtered")&&(t._clearDesignerFilters(a.dataField),t._designerFilterHandler({target:o})),o.disabled=!0):o.disabled=!1)}break}case"allowPivot":if(!0!==a.pivot)return;break;case"allowRowGroup":if(!0!==a.rowGroup)return;break;case"pivot":if(!0!==a.allowPivot)return;break;case"rowGroup":if(!0!==a.allowRowGroup)return;break;case"summary":if(!e.newValue&&e.oldValue&&1===t._aggregateColumns.length||t.columnTotals&&e.newValue!==t._totalSummaryFunction)return void(a.summary=e.oldValue)}t._refreshColumns()}_refreshColumns(){const e=this;e._columns=e.columns._array,e.columnByDataField=[],e._columns.forEach((t=>e.columnByDataField[t.dataField]=t)),e.refresh(!0),e._designer&&(e._designer.columns=JSON.parse(JSON.stringify(e._columns)))}_initDesigner(e){const t=this,l=t.rightToLeft,a=document.createElement("smart-pivot-panel");a.animation=t.animation,a.columns=JSON.parse(JSON.stringify(t._columns)),a.dataSource=t.dataSource.toArray(),a.inverted=e===t.$.designerContainer&&("near"===t.designerPosition&&!l||"far"===t.designerPosition&&l),a.locale=t.locale,a.messages=t.messages,a.rightToLeft=l,a.theme=t.theme,a.unfocusable=!t.keyboardNavigation||t.disabled||t.unfocusable,a.ownerElement=t,t._designer=a,e&&e.appendChild(a)}_designerChangeHandler(e){const t=this;(t.isInShadowDOM?e.composedPath()[0]:e.target)instanceof Smart.PivotPanel!=0&&(t.columns=e.detail.columns,t._updateColumns(!0))}_designerFilterHandler(){const e=this,t=Array.from(e._designer.$.filtersView.querySelectorAll("smart-filter-panel")),l=[];if(t.forEach((e=>{const t=e.column,a=e.getFilter();a.filters.length>0&&l.push([t.dataField,a])})),e._filterInfo.appliedFilters){if(0===l.length)return void e.clearFilters();delete e._filterInfo.appliedFilters,e.dataSource.clearFilter()}e._applyingDesignerFilters=!0,l.forEach((t=>e.addFilter(...t))),delete e._applyingDesignerFilters,e.refresh(!0),e._designerFiltersApplied=!0}_clearDesignerFilters(e){const t=this;if(!t._designerFiltersApplied||t._applyingDesignerFilters)return;const l=t._designer,a=l.view,o=Array.from(l.$.filtersView.querySelectorAll("smart-filter-panel"));l.view="filters",o.forEach((t=>{e&&e!==t.column.dataField||(t._filterHandler.excelClear(),t.closest("smart-accordion-item").classList.remove("filtered"))})),l.view=a}_setFocusable(){const e=this,t=!e.keyboardNavigation||e.disabled||e.unfocusable;super._setFocusable(),e._designer&&(e._designer.unfocusable=t);const l=Array.from(e.$.tableContainer.getElementsByClassName("total-arrow"));t?l.forEach((e=>e.removeAttribute("tabindex"))):l.forEach((e=>e.setAttribute("tabindex",0)))}_addDragFeedback(){const e=this,t=e._dragDetails.Item,l=document.createElement("div");return l.className="smart-table-feedback",l.setAttribute("parent-table-id",e.id),l.innerHTML=t.columnDefinition.dataFields.map((e=>e.label)).join("→"),e.theme&&l.setAttribute("theme",e.theme),document.body.appendChild(l),l}_applyColumnReorder(e,t){const l=this,a=l.rightToLeft,o=l._dynamicColumns,i=e.Item.columnDefinition,r=t.classList.contains("right"),n=l._dynamicColumns.filter((e=>e!==i)),s=n.indexOf(t.columnDefinition);t.classList.remove("drop-column","left","right"),r&&!a||!r&&a?n.splice(s+1,0,i):n.splice(s,0,i),o.map((e=>e.id)).join(",")!==n.map((e=>e.id)).join(",")&&(l._clearSortByRow(!0),l._dynamicColumns=n,l.refresh(void 0,l._getCurrentDataStructure()))}_getCurrentDataStructure(){const e=this,t=e._dynamicColumns,l=[],a=`${e._totalSummaryFunction}(${e.localize("total")})`;let o=Number(e._rowGroupColumns.length>0),i=0;if(e.rowTotals&&e._pivotColumns.length>0){const t=e._aggregateColumns.length;"near"===e.rowTotalsPosition?o+=t:i=t}const r=t.find((e=>!e.rowTotal&&!e.columnTotal&&!e.group)).dataFields.length;for(let e=0;e<r;e++)for(let n=o;n<t.length-i;n++){void 0===l[e]&&(l[e]=[]);const o=t[n];if(o.columnTotal){const t=o.dataFields[e];e===r-1?l[e].push({label:a,columnDefinition:o,info:{dataField:"TOTAL",label:a,originalColumn:{}}}):t?l[e].push({label:t.label,columnDefinition:o,info:t}):l[e].push({label:"",columnDefinition:o,info:o.dataFields[e-1]})}else l[e].push({label:o.dataFields[e].label,columnDefinition:o,info:o.dataFields[e]})}return l}_breadcrumbCloseHandler(e){const t=this,l=t.columns.find((t=>t.dataField===e.detail.item.value.dataField));l&&((t.isInShadowDOM?e.composedPath()[0]:e.target===t.$.rowGroupBreadcrumb)?l.rowGroup=void 0:l.pivot=void 0)}_breadcrumbDragEndHandler(e){const t=this,l=t.isInShadowDOM?e.composedPath()[0]:e.target,a=l===t.$.rowGroupBreadcrumb,o=t._breadcrumbOperation;let i=t.columns.find((t=>t.dataField===e.detail.item.data.value.dataField));if("forbidden"===o)return void(l.dataSource=a?t._rowGroupColumns.map((e=>({label:e.label,value:e}))):t._pivotColumns.map((e=>({label:e.label,value:e}))));const r=t.columns;if("remove"!==o){if("reorder"===o){const l=e.detail.target;if(!l)return;const a=l.data.value;if(void 0===i||void 0===a||i.dataField===a.dataField)return;const o=e.detail.droppedBeforeTarget?"top":"bottom",n=r.findIndex((e=>e.dataField===i.dataField));let s=r.findIndex((e=>e.dataField===a.dataField));if(n>s&&"bottom"===o||n<s&&"top"===o)return;r.canNotify=!1,r.splice(n,1),s=r.findIndex((e=>e.dataField===a.dataField)),"bottom"===o?r.splice(s+1,0,i):r.splice(s,0,i),t.columns=r,r.canNotify=!0}else o instanceof HTMLElement&&(o.$.container.classList.remove("drop-target"),r.canNotify=!1,o===t.$.rowGroupBreadcrumb||t._designer&&o===t._designer.$.rowGroupsTree?(i.pivot=void 0,i.rowGroup=!0):t._designer&&o===t._designer.$.summariesTree?(i[a?"rowGroup":"pivot"]=void 0,i.summary=t._getDefaultSummaryFunction(i)):(o===t.$.pivotBreadcrumb||t._designer&&o===t._designer.$.pivotsTree)&&(i.rowGroup=void 0,i.pivot=!0),r.canNotify=!0);t._refreshColumns()}else a?i.rowGroup=void 0:i.pivot=void 0}_getDefaultSummaryFunction(e){const t=this;return t.columnTotals?t._totalSummaryFunction:t.getDefaultSummaryFunction?t.getDefaultSummaryFunction(e):"count"}_breadcrumbDraggingHandler(e){const t=this,l=t.isInShadowDOM?e.composedPath()[0]:e.target,a=l._dragDrop.dragDetails.feedback,o=e.detail.item.data.value,i=e.detail.originalEvent,r=t._isMobile?t.getRootNode().elementFromPoint(i.clientX,i.clientY):t.isInShadowDOM?i.composedPath()[0]:i.target;let n,s;if(a){if(a.classList.remove("cancel","delete","row-group","summary","pivot"),t._breadcrumbOperation&&t._breadcrumbOperation instanceof HTMLElement&&t._breadcrumbOperation.$.container.classList.remove("drop-target"),l.contains(r))s="reorder";else if(r===document)n="delete",s="remove";else{const e=t._designer;if(s=r.closest("smart-breadcrumb, smart-tree"),s&&s instanceof Smart.Breadcrumb)s===t.$.rowGroupBreadcrumb&&!o.allowRowGroup||s===t.$.pivotBreadcrumb&&!o.allowPivot?(n="cancel",s="forbidden"):n=s===t.$.rowGroupBreadcrumb?"row-group":"pivot";else if(s&&e&&s!==e.$.columnsTree)switch(s){case e.$.rowGroupsTree:l===t.$.rowGroupBreadcrumb?(n="row-group",s="forbidden"):o.allowRowGroup?n="row-group":(n="cancel",s="forbidden");break;case e.$.summariesTree:n="summary";break;case e.$.pivotsTree:l===t.$.pivotBreadcrumb?(n="pivot",s="forbidden"):o.allowPivot?n="pivot":(n="cancel",s="forbidden")}else n="delete",s="remove"}n&&a.classList.add(n),t._breadcrumbOperation=s,s instanceof HTMLElement&&s.$.container.classList.add("drop-target")}}_tableContainerClickHandler(e){const t=this,l=t.isInShadowDOM?e.composedPath()[0]:e.target;if(l.classList.contains("total-arrow"))t._totalArrowClickHandler(l);else{if(t.rowSort&&!l.classList.contains("hierarchy-arrow")){const e=l.closest('td[data-field^="pivotgroup"]');if(e){if("classic"===t.groupLayout&&(""===e.textContent||e.closest('td:not(.expanded)+td[data-field^="pivotgroup"]:not(.main), td.expanded:not(.main)+td[data-field^="pivotgroup"]:not(.main)')))return;return void t._sortByRow(e)}}super._tableContainerClickHandler(e)}}_tableContainerKeydownHandler(e){const t=this,l=t.getRootNode().activeElement;"Enter"===e.key&&l.classList.contains("total-arrow")?t._totalArrowClickHandler(l):"F2"===e.key&&t._focusedCell?t._drillDown({cell:t._focusedCell,dataField:t._focusedCell.getAttribute("data-field"),rowElement:t._focusedCell.parentElement}):super._tableContainerKeydownHandler(e)}_totalArrowClickHandler(e){const t=this,l=e.parentElement,a=l.controller;a.expanded?(a.expanded=!1,function e(l){if(l.children)for(let a=0;a<l.children.length;a++){const o=l.children[a];Array.from(t.$.tableContainer.querySelectorAll(`td[data-field="${o.id}"]`)).forEach((e=>e.classList.add("smart-hidden"))),e(o),o.hidden=!0,o.cell.classList.add("smart-hidden"),o.columnTotal&&(o.arrowCell.classList.add("smart-hidden"),o.emptyCells.forEach((e=>e.classList.add("smart-hidden"))))}}(a),t.$.fireEvent("collapseTotalColumn",{columnDefinition:a})):(a.expanded=!0,function e(l){if(l.children)for(let a=0;a<l.children.length;a++){const o=l.children[a];Array.from(t.$.tableContainer.querySelectorAll(`td[data-field="${o.id}"]`)).forEach((e=>e.classList.remove("smart-hidden"))),o.expanded&&e(o),o.hidden=!1,o.cell.classList.remove("smart-hidden"),o.columnTotal&&(o.arrowCell.classList.remove("smart-hidden"),o.emptyCells.forEach((e=>e.classList.remove("smart-hidden"))))}}(a),t.$.fireEvent("expandTotalColumn",{columnDefinition:a})),l.classList.toggle("expanded",a.expanded),function e(l){const a=l.controller;t._getColumnTotalColspan(l),a.parent&&e(a.parent.arrowCell)}(l),t._hideColumnTotalsBorder(),"cell"===t.selectionMode&&t._selectedCells.collection.length>1&&(t._selectedCells.isDirty=!0)}_hideColumnTotalsBorder(){if(!this.columnTotals)return;const e=this.$.tableContainer.firstElementChild;Array.from(e.querySelectorAll(".last-visible")).forEach((e=>e.classList.remove("last-visible")));for(let t=1;t<e.childElementCount;t++){const l=e.children[t].querySelectorAll("th:not(.smart-hidden)");l[l.length-1].classList.add("last-visible")}}_getColumnExportFormat(e,t,l){if(e.columnTotal)return;const a=e.dataFields[e.dataFields.length-1].originalColumn;if(a.align&&(e.group?l.textAlign=a.align:t.textAlign=a.align),e.group||!a.summarySettings)return;const o=a.summarySettings;let i="#.",r=!1;o.align&&(l.textAlign=o.align),void 0!==o.thousandsSeparator&&""!==o.thousandsSeparator&&(i="#"+o.thousandsSeparator+i,r=!0),void 0!==o.decimalPlaces&&(i+="0".repeat(o.decimalPlaces),r=!0),void 0!==o.prefix&&(i=o.prefix.toString()+i,r=!0),o.negativesInBrackets&&(i=`${i};(${i})`,r=!0),r&&(l.format=i)}_beginEdit(e){this._drillDown(e)}_drillDown(e){const t=this,l=e.dataField;if(/^group\d*$/g.test(l))return;const a=e.rowElement,o=e.cell,i=document.createElement("div"),r=document.createElement("smart-table"),n=t._dynamicColumns.find((e=>e.id===l)),s=[],d=JSON.parse(JSON.stringify(t._columns)),c=t.localize("total");let u,m,p,g,f=a.data;if(f&&!a.classList.contains("grand-total"))if("classic"===t.groupLayout&&(f=t._getRecordToDisplay(f)),u=f.$.id,f.group){for(m=[f.group.replace(/ \(\d+\)/,"")],g=f.parent;g;)m.push(g.group.replace(/ \(\d+\)/,"")),g=g.parent;m=m.reverse().join("→")}else if(f.pivotgroup){for(m=[f.pivotgroup.replace(/ \(\d+\)/,"")],g=f.parent;g;)m.push(g.pivotgroup.replace(/ \(\d+\)/,"")),g=g.parent;m=m.reverse().join("→")}else m=t.localize("notApplicable");else u="GRAND_TOTAL",m=t.localize("grandTotal");if(!n)return;if(n.rowTotal)s.push(c);else if(n.columnTotal){for(let e=0;e<=n.dataFields.length-1;e++)s.push(n.dataFields[e].label);s.push(c),p=`${t._totalSummaryFunction}(${c})`}else for(let e=0;e<n.dataFields.length;e++)s.push(n.dataFields[e].label);const h=t._originalRecords[u+n.id];if(h&&0!==h.length){if(i.innerHTML=`<div class="drill-down-details">\n                <span>${t.localize("row")}:</span><strong>${m}</strong>\n                <span>${t.localize("column")}</span><strong>${s.join("→")||t.localize("notApplicable")}</strong>\n                <span>${p||n.dataFields[n.dataFields.length-1].label}:</span><strong>${o.textContent}</strong>\n            </div>`,i.appendChild(r),""!==t.drillDownDataExport){const e=document.createElement("smart-button");e.innerHTML=t.localize("export")+" "+t.drillDownDataExport.toUpperCase(),e.onclick=()=>{r.exportData(t.drillDownDataExport,t.drillDownDataExportFileName)},i.appendChild(e)}d.forEach((e=>e.width=t._cellWidth)),r.columns=d,r.dataSource=new window.Smart.DataAdapter({dataSource:h,dataFields:t.dataSource._dataFields}),r.freezeHeader=!0,r.keyboardNavigation=t.keyboardNavigation,h&&h.length>100&&d&&d.length>10&&(r.virtualization=!0,r.style.height="100%",r.style.width="100%"),t.drillDownTableInit&&t.drillDownTableInit(r),t.drillDownCustomAction?t.drillDownCustomAction(h):t._openDialog(t.localize("details"),i,"drill-down")}}_getColumnTotalsOriginalRecords(e,t){const l=this;let a=[];for(let o=0;o<e.children.length;o++){const i=e.children[o];if(!i.columnTotal){const e=l._originalRecords[t+i.id];e&&(a=e);break}a=a.concat(l._getColumnTotalsOriginalRecords(i,t))}return a}_conditionalFormattingButtonClickHandler(e){const t=this._aggregateColumns.map((e=>({label:`${e.summary}(${e.label})`,dataField:e.dataField,dataType:"number"})));super._conditionalFormattingButtonClickHandler(e,t,this.rows)}_applyConditionalFormatting(){const e=this,t=e._conditionalFormatting;e._conditionalFormatting=e._formattingPanel.apply(),e.conditionalFormatting=e._formattingPanel.getItems(),e._conditionalFormatting!==t&&e.refresh(void 0,e._getCurrentDataStructure())}_fieldsButtonClickHandler(){const e=this;e._designer?e._designer.inverted=!1:e._initDesigner(),e._openDialog(e.localize("fields"),e._designer,"fields")}_addDialogHandlers(){const e=this,t=e._dialog;t.addEventListener("change",e._dialogEventHandler),t.addEventListener("clear",e._dialogEventHandler),t.addEventListener("filter",e._dialogEventHandler),super._addDialogHandlers()}_dialogEventHandler(e){const t=e.type;if(-1===["change","clear","filter"].indexOf(t))return void super._dialogEventHandler(e);const l=this.ownerElement;if(!(this.isInShadowDOM?e.composedPath()[0]:e.target).closest("smart-pivot-panel"))return;const a=l.context;l.context=l,"change"===t?l._designerChangeHandler(e):l._designerFilterHandler(e),l.context=a}_sortByRow(e){const t=this,l=t.columnTotalsPosition,a=t._originalDynamicColumnsOrder,o=e.parentElement,i=o.data;let r=i;function n(e){"asc"===r.sortOrder?e.sort((function(e,t){return e.value-t.value})):e.sort((function(e,t){return t.value-e.value}))}if("classic"===t.groupLayout&&(r=e.data?e.data:t._getRecordToDisplay(i)),r.sortOrder?"asc"===r.sortOrder?r.sortOrder="desc":delete r.sortOrder:r.sortOrder="asc",t._sortRow&&t._sortRow!==r&&delete t._sortRow.sortOrder,r.sortOrder){if(t.columnTotals){const e=[];if(function e(a,o){const i=[];for(const e of a)i.push({dynamicColumnName:e.id,value:r[e.id]});n(i);for(const a of i){const i=t._getDynamicColumnById[a.dynamicColumnName];"near"===l&&o.push(i),i.children&&e(i.children,o),"far"===l&&o.push(i)}}(t._dynamicColumns.filter((e=>e.columnTotal&&0===e.pivotLevel)),e),t._rowGroupColumns.length>0&&e.unshift(t._dynamicColumns[0]),t.rowTotals){const l=t._dynamicColumns.filter((e=>e.rowTotal));"near"===t.rowTotalsPosition?e.splice(1,0,...l):e.push(...l)}t._dynamicColumns=e}else{let e=[];Object.keys(r).filter((e=>-1===["$","children","count","expanded","pivotgroup","group","id","leaf","level","parent","parentid","sortOrder","tr"].indexOf(e))).forEach((t=>{e.push({dynamicColumnName:t,value:r[t]})})),n(e),t._dynamicColumns=t._dynamicColumns.sort((function(l,a){return l.group||l.rowTotal||a.group||a.rowTotal?t._dynamicColumns.indexOf(l)-t._dynamicColumns.indexOf(a):e.findIndex((e=>e.dynamicColumnName===l.id))-e.findIndex((e=>e.dynamicColumnName===a.id))}))}t._sortRow=r}else t._dynamicColumns=t._dynamicColumns.sort((function(e,t){return a.findIndex((t=>t===e.id))-a.findIndex((e=>e===t.id))})),delete t._sortRow;t.refresh(void 0,t._getCurrentDataStructure()),t._focusCell(t.$.tableContainer.querySelector(`tr[row-id="${o.getAttribute("row-id")}"] td[data-field="${e.getAttribute("data-field")}"]`))}_clearSortByRow(e,t){const l=this;if(!l._sortRow)return;if(delete l._sortRow.sortOrder,delete l._sortRow,e&&!t)return;const a=l._originalDynamicColumnsOrder;l._dynamicColumns=l._dynamicColumns.sort((function(e,t){return a.findIndex((t=>t===e.id))-a.findIndex((e=>e===t.id))})),e||l.refresh(void 0,l._getCurrentDataStructure())}_defaultSortByRowGroups(e){const t=this,l=t._rowGroupColumns,a=l.find((e=>-1!==e.dataField.toLowerCase().indexOf("month")&&"string"===e.dataType)),o=new Smart.DataAdapter({dataSource:e,dataFields:e.dataFields}),i=[],r=[],n=[];let s;if(l.forEach((e=>{const t=e.sortOrder?e.sortOrder:"asc";i.push(e.dataField),r.push(t),n.push(e.dataType)})),a){const e=new Intl.DateTimeFormat(t.locale,{month:"long"}),l=[0,1,2,3,4,5,6,7,8,9,10,11].map((t=>e.format(new Date(2e3,t,1))));s=function(e,t,i,r){e.sort((function(e,o){for(let n=0;n<t.length;n++){if(a.dataField===t[n])return l.indexOf(e.month)-l.indexOf(o.month);const s=r[n](e[t[n]],o[t[n]]);if(0===s){if(t[n+1])continue;return void 0!==e.$.index?(e.$.index-o.$.index)*("asc"===i[n]?1:-1):0}return s*("asc"===i[n]?1:-1)}}));for(let t=0;t<e.length;t++)o[t]=e[t]}}return o._sort(o.boundSource,i,r,n,s),t._dataSourceSortedByDefault=!0,o.toArray()}_tableContainerDownHandler(e){const t=this;if(super._tableContainerDownHandler(e),"cell"!==t.selectionMode)return;clearTimeout(t._mobileScrollTimeout),delete t._selectDrag;const l=(t.isInShadowDOM?e.originalEvent.composedPath()[0]:e.originalEvent.target).closest("tbody td[data-field]");if(!l)return;const a=t._selectedCells;if((e.ctrlKey||e.metaKey)&&a.collection.length>0){const e=a.collection.findIndex((e=>e.element===l));if(-1===e)l.classList.add("selected"),a.collection.push(t._getCellInfo(l));else{l.classList.remove("selected"),a.collection.splice(e,1);const t=a.start&&a.start.element===l,o=a.end&&a.end.element===l;(t||o)&&(delete a.start,delete a.end)}return a.collection.length>0&&(a.isDirty=!0),t._showSelectionDetails(),void t.$.fireEvent("change",{type:"interaction"})}if(e.shiftKey&&a.start)return void t._selectTo(e);const o=(new Date).getTime();let i;function r(){const e=a.collection.slice(0);a.collection.forEach((e=>e.element.classList.remove("selected"))),l.classList.add("selected"),delete a.isDirty,a.start=t._getCellInfo(l),a.end=a.start,a.collection=[a.start],a.time=o,t._selectDrag=!0,t._showSelectionDetails(),1===e.length&&e[0].element===l||t.$.fireEvent("change",{type:"interaction"})}t._isMobile&&(i=l.getBoundingClientRect()),t._isMobile?(clearTimeout(t._mobileScrollTimeout),t._mobileScrollTimeout=setTimeout((function(){const e=l.getBoundingClientRect();Math.abs(i.top-e.top)<5&&Math.abs(i.left-e.left)<5&&r()}),500)):r()}_getCellInfo(e){const t=this,l=e.parentElement,a=e.getAttribute("data-field");let o=l.data,i=o[a];return"classic"===this.groupLayout&&(o=t._getRecordToDisplay(o),i=/^group\d*$/.test(a)?o.group:o[a]),{dataField:a,element:e,row:l,rowData:o,value:i}}_documentMoveHandler(e){!this._selectDrag||e.ctrlKey||e.metaKey?super._documentMoveHandler(e):this._selectTo(e)}_selectTo(e){const t=this,l=t._selectedCells;let a;if(a=t._isMobile?t.getRootNode().elementFromPoint(e.originalEvent.clientX,e.originalEvent.clientY):t.isInShadowDOM?e.originalEvent.composedPath()[0]:e.originalEvent.target,!a)return;const o=a.closest("tbody td[data-field]");if(!o||o===l.end.element)return;l.collection.forEach((e=>e.element.classList.remove("selected"))),l.collection=[],l.end=t._getCellInfo(o);let i=Array.from(t.$.tableContainer.querySelectorAll("tbody>tr:not(.smart-hidden)")),r=i.indexOf(l.start.row),n=l.start.row===l.end.row?r:i.indexOf(l.end.row),s=t._getDynamicColumnsForCellSelection(),d=s.findIndex((e=>e.id===l.start.dataField)),c=l.start.dataField===l.end.dataField?d:s.findIndex((e=>e.id===l.end.dataField));for(let e=Math.min(r,n);e<=Math.max(r,n);e++){const t=i[e],a=t.data;for(let e=Math.min(d,c);e<=Math.max(d,c);e++){const o=s[e].id,i=t.querySelector(`td[data-field="${o}"]`);l.collection.push({dataField:o,element:i,row:t,rowData:a,value:a[o]}),i.classList.add("selected")}}t._showSelectionDetails(),t.$.fireEvent("change",{type:"interaction"}),"down"===e.type&&(t._selectDrag=!0,super._focusCell(l.start.element))}_getDynamicColumnsForCellSelection(){const e=this;let t=e._dynamicColumns.filter((e=>!0!==e.hidden));if(e._rowGroupColumns.length>0&&"classic"===e.groupLayout){const l=t.splice(0,1)[0];for(let a=e._rowGroupColumns.length-1;a>=0;a--)t.unshift(Object.assign({},l,{id:"pivotgroup"+a}))}return t}_tableContainerTouchmoveHandler(e){const t=this;t._selectDrag&&t._isMobile&&(t._isMobile&&(new Date).getTime()-t._selectedCells.time<500?delete t._selectDrag:(t.$.main.classList.add("prevent-scroll"),e.preventDefault()))}_showSelectionDetails(e){const t=this;if(t.hideCellSelectionTooltip)return;const l=t._selectedCells.collection,a=t.$.tableContainer.querySelector("[selection-detail]");let o;if(a&&(e&&(o=a.getAttribute("selection-detail")),a.removeAttribute("selection-detail"),a.removeAttribute("detail-position-x"),a.removeAttribute("detail-position-y")),!(l.length<=1)){if(void 0===o){let e=0,a=0;for(const t of l)null===t.value||/^group\d*$/.test(t.dataField)||(e++,a+=t.value);if(e<=1)return;let i=a/e;const r=t._aggregateColumns.find((e=>e.summarySettings));if(r){const e=document.createElement("td"),l={summarySettings:r.summarySettings};a=t._formatSummaryValue(void 0,l,e,a),i=t._formatSummaryValue(void 0,l,e,i)}o=`${t.localize("average")}: ${i}; ${t.localize("count")}: ${e}; ${t.localize("sum")}: ${a}`}t._positionTooltipOnLastVisible(l,o)}}_positionTooltipOnLastVisible(e,t){const l=this,a=l.rightToLeft,o=l._getDynamicColumnsForCellSelection(),i=l.getRootNode(),r=l.$.main,n=l.$.tableContainer,s=Array.from(n.children[1].querySelectorAll("tr:not(.smart-hidden):not(.last-visible)")),d=parseFloat(getComputedStyle(l).getPropertyValue("--smart-pivot-table-cell-width")),c=l.grandTotal?n.lastElementChild.offsetHeight:0,u=r.getBoundingClientRect(),m=u.left,p=u.top,g=r.clientWidth,f=r.clientHeight;let h=n.firstElementChild.offsetHeight,_=1,b=1,v=0;l.freezeHeader||(h=Math.max(0,h-r.scrollTop)),l._rowGroupColumns.length>0&&"classic"===l.groupLayout&&(a?(b=.7,v=Math.max(0,r.offsetWidth-g)):_=.7);const y=i.elementFromPoint(m-d*_+5,p+h+5),C=i.elementFromPoint(m+g+d*b-5,p+h+5);let w,T=i.elementFromPoint(m+5,p+h+5),S=i.elementFromPoint(m+g-5,p+h+5);if(y!==T?(T=i.elementFromPoint(m+d*_-5,p+h+5),w=i.elementFromPoint(m+d*_-5,p+f-c-l._rowHeight-5)):w=i.elementFromPoint(m+5,p+f-c-l._rowHeight-5),T||(T=s[0].querySelector("td:not(.smart-hidden)")),w&&"td"===w.tagName.toLowerCase()||(w=s[s.length-1].querySelector(`td[data-field="${T.getAttribute("data-field")}"]`)),C!==S&&(S=i.elementFromPoint(m+g-d*b+v,p+h+5)),!S){const e=s[0].querySelectorAll("td:not(.smart-hidden)");S=e[e.length-1]}const $=s.indexOf(T.parentElement),F=s.indexOf(w.parentElement);let D,x,L,A=o.findIndex((e=>e.id===T.getAttribute("data-field"))),E=o.findIndex((e=>e.id===S.getAttribute("data-field")));if(a){const e=A;A=E,E=e}for(const t of e){if(t.row.classList.contains("smart-hidden"))continue;let e,l;if(void 0===t.rowIndex?(e=s.indexOf(t.row),t.rowIndex=e):e=t.rowIndex,void 0===t.columnIndex?(l=o.findIndex((e=>e.id===t.dataField)),t.columnIndex=l):l=t.columnIndex,l>=A&&l<=E)if(e>=$&&e<=F){const a=D,o=x;(!D||D.temp||e>=D.rowIndex&&l>=D.columnIndex)&&(D=t),(!x||e>=x.rowIndex&&l<=x.columnIndex)&&(x=t),a&&a.temp&&delete a.temp,o&&o.temp&&delete o.temp}else e>F&&((!D||D.temp&&e<=D.rowIndex&&l>=D.columnIndex)&&(D=t,t.temp=!0),(!x||x.temp&&e<=D.rowIndex&&l<=x.columnIndex)&&(x=t,t.temp=!0))}D&&(Math.abs(D.columnIndex-A)>Math.abs(D.columnIndex-E)?(L=D,a||L.element.setAttribute("detail-position-x","right")):(L=x,a&&L.element.setAttribute("detail-position-x","right")),L.temp&&(L.element.setAttribute("detail-position-y","top"),delete L.temp),L.element.setAttribute("selection-detail",t))}_mainContainerOnscroll(){const e=this;e._selectedCells.collection.length>1&&e._showSelectionDetails(!0)}_focusCell(e,t,l){const a=this;if(!l||"cell"!==a.selectionMode||!a.selection)return void super._focusCell(e,t);const o=a._selectedCells,i=l&&l.shiftKey&&0===l.key.indexOf("Arrow");if(o.isDirty||!i||0===o.collection.length){if(!1===super._focusCell(e,t))return;o.collection.forEach((e=>e.element.classList.remove("selected"))),e.classList.add("selected"),o.start=a._getCellInfo(e),o.end=o.start,o.collection=[o.start],delete o.isDirty,a.$.fireEvent("change",{type:"interaction"})}else a._shiftArrowSelection(l);a._showSelectionDetails()}_shiftArrowSelection(e){const t=this,l=t._selectedCells,a=t._getDynamicColumnsForCellSelection(),o=e.key,i=Array.from(t.$.tableContainer.children[1].querySelectorAll("tr:not(.smart-hidden):not(.last-visible)")),r=i.indexOf(l.start.row),n=i.indexOf(l.end.row),s=a.findIndex((e=>e.id===l.start.dataField)),d=a.findIndex((e=>e.id===l.end.dataField));if("ArrowUp"===o||"ArrowDown"===o){if("ArrowUp"===o&&n<r||"ArrowDown"===o&&n>r||n===r){if("ArrowUp"===o&&0===n||"ArrowDown"===o&&n===i.length-1)return;const e=i[n+1*("ArrowUp"===o?-1:1)];for(let o=Math.min(s,d);o<=Math.max(s,d);o++){const i=e.querySelector(`td[data-field="${a[o].id}"]`),r=t._getCellInfo(i);l.end.dataField===r.dataField&&(l.end=r,super._focusCell(i,!0)),l.collection.push(r),i.classList.add("selected")}}else if("ArrowDown"===o&&n<r||"ArrowUp"===o&&n>r){const e=i[n+1*(n>r?-1:1)];l.collection.filter((e=>e.row===l.end.row)).forEach((e=>e.element.classList.remove("selected"))),l.collection=l.collection.filter((e=>e.row!==l.end.row));const t=l.collection.find((t=>t.row===e&&t.dataField===l.end.dataField));l.end=t,super._focusCell(t.element,!0)}}else{let e="ArrowRight",c="ArrowLeft";if(t.rightToLeft&&(e="ArrowLeft",c="ArrowRight"),o===c&&d<s||o===e&&d>s||d===s){if(o===c&&0===d||o===e&&d===a.length-1)return;const s=a[d+1*(o===c?-1:1)];for(let e=Math.min(r,n);e<=Math.max(r,n);e++){const a=i[e].querySelector(`td[data-field="${s.id}"]`),o=t._getCellInfo(a);l.end.row===o.row&&(l.end=o,super._focusCell(a,!0)),l.collection.push(o),a.classList.add("selected")}}else if(o===e&&d<s||o===c&&d>s){const e=a[d+1*(d>s?-1:1)];l.collection.filter((e=>e.dataField===l.end.dataField)).forEach((e=>e.element.classList.remove("selected"))),l.collection=l.collection.filter((e=>e.dataField!==l.end.dataField));const t=l.collection.find((t=>t.dataField===e.id&&t.row===l.end.row));l.end=t,super._focusCell(t.element,!0)}}t.$.fireEvent("change",{type:"interaction"})}_clearCellSelection(e){const t=this,l=t.$.tableContainer.querySelector("[selection-detail]");l&&(l.removeAttribute("selection-detail"),l.removeAttribute("detail-position-x"),l.removeAttribute("detail-position-y")),t._selectedCells.collection.forEach((e=>e.element.classList.remove("selected"))),e&&(t._selectedCells={collection:[]})}_toggleCellSelectionProgrammatically(e,t,l){const a=this,o=a._getDynamicColumnsForCellSelection(),i=a.rows.dataItemById[e];"pivotgroup"===t&&"classic"===a.groupLayout&&(t="pivotgroup0");const r=o.find((e=>e.id===t));if(!i||!r)return;const n=a._selectedCells,s=n.collection.find((e=>e.rowData.$.id===i.$.id&&e.dataField===t));if(l){if(s)return;const e=a.$.tableContainer.querySelector(`tr[row-id="${i.$.id}"]>td[data-field="${t}"]`),l=a._getCellInfo(e);e.classList.add("selected"),super._focusCell(e,!0),n.collection.push(l),1===n.collection.length?(n.start=l,n.end=l,delete n.isDirty):n.isDirty=!0}else{if(!s)return;const e=n.start&&n.start.rowData.$.id===i.$.id&&n.start.dataField===t,l=n.end&&n.end.rowData.$.id===i.$.id&&n.end.dataField===t;s.element.classList.remove("selected"),n.collection.splice(n.collection.indexOf(s),1),n.isDirty=!0,(e||l)&&(delete n.start,delete n.end)}a._showSelectionDetails(),a.$.fireEvent("change",{type:"programmatic"})}}),Smart("smart-pivot-panel",class extends Smart.BaseElement{static get properties(){return{columns:{value:[],type:"any",reflectToAttribute:!1},dataSource:{value:[],type:"any?",reflectToAttribute:!1},inverted:{value:!1,type:"boolean"},messages:{value:{en:{calculation:"Calculation",cancel:"Cancel",center:"center",clear:"Clear",columns:"Columns",columnSettings:"Column settings",decimalPlaces:"Decimal places",decimalSeparator:"Decimal separator",dragHereRowGroups:"Drag here to set row groups",dragHereSummaries:"Drag here to set summaries",dragHerePivots:"Drag here to set pivots",filter:"Filter",filters:"Filters",left:"left",moveTo:"Move to",negativesInBrackets:"Negatives in brackets",numberAlignment:"Number alignment",numberFormat:"Number format",numberPrefix:"Number prefix",ok:"OK",pivots:"Pivots",right:"right",rowGroups:"Row Groups",search:"Search...",showRows:"Show records where:",summaries:"Summaries",textAlignment:"Text alignment",thousandsSeparator:"Thousands separator"}},type:"object",extend:!0},view:{value:"columns",allowedValues:["columns","filters"],type:"string"}}}static get listeners(){return{keydown:"_keydownHandler","columnsView.click":"_settingsIconClickHandler","columnsView.dragEnd":"_dragEndHandler","columnsView.dragging":"_draggingHandler","filtersView.clear":"_filterPanelFilterHandler","filtersView.expanding":"_accordionItemExpandingHandler","filtersView.filter":"_filterPanelFilterHandler","summariesTree.dragStart":"_summariesTreeDragStartHandler","tabs.click":"_tabsClickHandler"}}template(){return'<div id="container" role="presentation">\n                    <div id="main" role="presentation">\n                        <div id="columnsView" class="smart-pivot-panel-columns-view" role="tabpanel">\n                            <div id="columns" class="smart-pivot-panel-columns-container" role="presentation">\n                                <smart-tree id="columnsTree" allow-drag allow-drop animation="[[animation]]" filterable selection-mode="zeroOrOne" right-to-left="[[rightToLeft]]" theme="[[theme]]" unfocusable="[[unfocusable]]" aria-label="Columns"></smart-tree>\n                            </div>\n                            <div id="rowGroups" class="smart-pivot-panel-active-columns" role="presentation">\n                                <div id="rowGroupsLabel" class="smart-pivot-panel-row-groups-label smart-pivot-panel-label"><span class="icon" aria-hidden="true"></span><span></span></div>\n                                <smart-tree id="rowGroupsTree" allow-drag allow-drop animation="[[animation]]" selection-mode="zeroOrOne" right-to-left="[[rightToLeft]]" theme="[[theme]]" unfocusable="[[unfocusable]]"></smart-tree>\n                            </div>\n                            <div id="summaries" class="smart-pivot-panel-active-columns" role="presentation">\n                                <div id="summariesLabel" class="smart-pivot-panel-summaries-label smart-pivot-panel-label"><span class="icon" aria-hidden="true"></span><span></span></div>\n                                <smart-tree id="summariesTree" allow-drag allow-drop animation="[[animation]]" selection-mode="zeroOrOne" right-to-left="[[rightToLeft]]" theme="[[theme]]" unfocusable="[[unfocusable]]"></smart-tree>\n                            </div>\n                            <div id="pivots" class="smart-pivot-panel-active-columns" role="presentation">\n                                <div id="pivotsLabel" class="smart-pivot-panel-pivots-label smart-pivot-panel-label"><span class="icon" aria-hidden="true"></span><span></span></div>\n                                <smart-tree id="pivotsTree" allow-drag allow-drop animation="[[animation]]" selection-mode="zeroOrOne" right-to-left="[[rightToLeft]]" theme="[[theme]]" unfocusable="[[unfocusable]]"></smart-tree>\n                            </div>\n                        </div>\n                        <div id="filtersView" class="smart-pivot-panel-filters-view" role="tabpanel"></div>\n                    </div>\n                    <div id="tabs" class="smart-pivot-panel-tabs smart-unselectable">\n                        <div id="columnsTab" class="smart-pivot-panel-tab-item" role="tab" aria-selected="false"><span class="icon" aria-hidden="true"></span><span></span></div>\n                        <div id="filtersTab" class="smart-pivot-panel-tab-item" role="tab" aria-selected="false"><span class="icon" aria-hidden="true"></span><span></span></div>\n                    </div>\n                </div>'}render(){const e=this;e._isMobile=Smart.Utilities.Core.isMobile,e._initializedFilters={},e._cachedFilters={},e._setFocusable(),e._localize(),e._setAriaRelations(),e.dataSource instanceof Smart.DataAdapter&&(e.dataSource=e.dataSource.toArray()),"columns"===e.view?(e.$.columnsTab.classList.add("selected"),e.$.columnsTab.setAttribute("aria-selected",!0),e.$.filtersView.remove(),e._initializeColumnsView()):(e.$.filtersTab.classList.add("selected"),e.$.filtersTab.setAttribute("aria-selected",!0),e.$.columnsView.remove(),e._initializeFiltersView()),super.render()}attached(){const e=this;super.attached(),e.isCompleted&&e._dialog&&(e._addDialogHandlers(),e.getShadowRootOrBody().appendChild(e._dialog))}detached(){const e=this;if(super.detached(),!e._dialog)return;const t=e._dialog;t.removeEventListener("close",e._dialogCloseHandler),t.removeEventListener("click",e._dialogClickHandler),t.remove()}propertyChangedHandler(e,t,l){super.propertyChangedHandler(e,t,l);const a=this;switch(e){case"animation":case"disabled":case"rightToLeft":case"theme":case"unfocusable":"disabled"!==e&&"unfocusable"!==e||a._setFocusable(),a._columnsViewInitialized&&"filters"===a.view&&[a.$.columnsTree,a.$.rowGroupsTree,a.$.summariesTree,a.$.pivotsTree].forEach((t=>t[e]=l)),a._filtersViewInitialized&&(Array.from(a.$.filtersView.querySelectorAll("smart-filter-panel")).forEach((t=>t[e]=l)),"animation"!==e&&(a.$.filtersView.querySelector("smart-accordion")[e]=l)),a._dialog&&(Array.from(a._dialog.$.container.querySelectorAll(".editor, .ok, .cancel")).forEach((t=>t[e]=l)),a._dialog[e]=l);break;case"columns":case"dataSource":"dataSource"===e&&a.dataSource instanceof Smart.DataAdapter&&(a.dataSource=a.dataSource.toArray()),"columns"===e&&a._columnsViewInitialized&&(delete a._columnsViewInitialized,"columns"===a.view&&a._initializeColumnsView()),a._filtersViewInitialized&&("columns"!==e||t.map((e=>e.dataField)).join(",")!==l.map((e=>e.dataField)).join(",")?("columns"===e&&Array.from(a.$.filtersView.querySelectorAll("smart-accordion-item.filtered smart-filter-panel")).forEach((e=>{a._cachedFilters[e.column.dataField]=e.$.mainContainer.firstElementChild.selectedIndexes})),delete a._filtersViewInitialized,a._initializedFilters={},a.$.filtersView.innerHTML="","filters"===a.view&&a._initializeFiltersView()):"columns"===e&&Array.from(a.$.filtersView.querySelectorAll("smart-accordion-item, smart-filter-panel")).forEach((e=>{e.column=l.find((t=>t.dataField===e.column.dataField))})));break;case"locale":case"messages":{const e=Array.from(a.$.filtersView.querySelectorAll("smart-filter-panel")),t=a._dialog;a._localize(),e.forEach((e=>{e.messages.en.clear=a.localize("clear"),e.messages.en.filter=a.localize("filter"),e.messages.en.showRows=a.localize("showRows"),e.propertyChangedHandler("messages")})),t&&(t.close(),t.removeEventListener("close",a._dialogCloseHandler),t.removeEventListener("click",a._dialogClickHandler),t.remove(),delete a._dialog);break}case"view":a._tabsClickHandler({target:a.$[l+"Tab"]})}}_localize(){const e=this;e.$.columnsTab.children[1].innerHTML=e.localize("columns"),e.$.filtersTab.children[1].innerHTML=e.localize("filters"),e.$.columnsTree.filterInputPlaceholder=e.localize("search"),e.$.rowGroupsLabel.children[1].innerHTML=e.localize("rowGroups"),e.$.summariesLabel.children[1].innerHTML=e.localize("summaries"),e.$.pivotsLabel.children[1].innerHTML=e.localize("pivots")}_initializeColumnsView(){const e=this;e._columnsViewInitialized||(e._columnsViewInitialized=!0,e._createColumnItems())}_initializeFiltersView(){const e=this;if(e._filtersViewInitialized)return;const t=e.columns,l=document.createElement("smart-accordion");e._filtersViewInitialized=!0;for(let a=0;a<t.length;a++){const o=t[a],i=document.createElement("smart-accordion-item");i.label=o.label,i.column=o,0===a&&e._initFilterPanel(i),e._cachedFilters[o.dataField]&&i.classList.add("filtered"),l.appendChild(i)}l.animation="none",l.expandMode="single",l.rightToLeft=e.rightToLeft,l.theme=e.theme,l.unfocusable=e.unfocusable,e.$.filtersView.appendChild(l)}_initFilterPanel(e){const t=this,l=e.column,a=l.dataField;if(t._initializedFilters[a]){const t=e.querySelector("smart-filter-panel");return void(0===t._filterHandler.filterObject.filters.length&&t._filterHandler.tree.select("0"))}const o=document.createElement("smart-filter-panel"),i=l.dataType;o.animation=t.animation,o.column=l,o.disabled=!1===l.allowFilter,o.filterType="number"===i?"numeric":i,o.mode="excel",o.data=t.dataSource,o.dataField=a,o.messages.en.clear=t.localize("clear"),o.messages.en.filter=t.localize("filter"),o.messages.en.showRows=t.localize("showRows"),o.rightToLeft=t.rightToLeft,o.theme=t.theme,o.unfocusable=t.unfocusable,e.isRendered?e.$.contentContainer.appendChild(o):e.appendChild(o),t._initializedFilters[a]=!0,t._cachedFilters[a]&&o.whenRendered((function(){o.$.mainContainer.firstElementChild.selectedIndexes=t._cachedFilters[a],o._filterHandler.excelFilter(),delete t._cachedFilters[a]}))}_accordionItemExpandingHandler(e){const t=this.isInShadowDOM?e.composedPath()[0]:e.target;if(t instanceof Smart.Accordion==0)return;const l=t._items[e.detail.index];this._initFilterPanel(l)}_filterPanelFilterHandler(e){const t=(this.isInShadowDOM?e.composedPath()[0]:e.target).closest("smart-accordion-item");"clear"!==e.type||t.classList.contains("filtered")||e.stopPropagation(),t.classList.toggle("filtered","filter"===e.type)}_tabsClickHandler(e){const t=this,l=t.view,a=e.type&&t.isInShadowDOM?e.composedPath()[0]:e.target;if(t.$.columnsTab.contains(a)){if("columns"===l&&e.type)return;return t.view="columns",t.$.columnsTab.classList.add("selected"),t.$.columnsTab.setAttribute("aria-selected",!0),t.$.filtersTab.classList.remove("selected"),t.$.filtersTab.setAttribute("aria-selected",!1),t.$.filtersView.remove(),t.$.main.appendChild(t.$.columnsView),void t._initializeColumnsView()}if(t.$.filtersTab.contains(a)){if("filters"===l&&e.type)return;t.view="filters",t.$.filtersTab.classList.add("selected"),t.$.filtersTab.setAttribute("aria-selected",!0),t.$.columnsTab.classList.remove("selected"),t.$.columnsTab.setAttribute("aria-selected",!1),t.$.columnsView.remove(),t.$.main.appendChild(t.$.filtersView),t._initializeFiltersView()}}_createColumnItems(e){const t=this,l=t.columns,a=[],o=[],i=[],r=[];for(let t=0;t<l.length;t++){const n=l[t];n.allowPivot&&n.pivot&&a.push(n),n.allowRowGroup&&n.rowGroup&&o.push(n),n.summary&&i.push(n),!1!==e&&r.push({label:n.label,value:n})}function n(e,l){const a=[];for(let l=0;l<e.length;l++)a.push({label:t._getTreeItemLabel(e[l]),value:e[l]});l.dataSource=a}n(a,t.$.pivotsTree),n(o,t.$.rowGroupsTree),n(i,t.$.summariesTree),!1!==e&&(t.$.columnsTree.dataSource=r)}_summariesTreeDragStartHandler(e){const t=this.$.summariesTree;1===Object.keys(t.items).length&&e.preventDefault()}_draggingHandler(e){const t=this,l=e.detail.data.Feedback,a=e.detail.item.closest("smart-tree"),o=e.detail.originalEvent.originalEvent,i=t._isMobile?t.getRootNode().elementFromPoint(o.clientX,o.clientY):t.isInShadowDOM?o.composedPath()[0]:o.target,r=i.closest("smart-tree"),n=e.detail.item.value,s=t.ownerElement;if(t._breadcrumbTarget&&(t._breadcrumbTarget.$.container.classList.remove("drop-target"),delete t._breadcrumbTarget),s&&s.contains(i)){const e=i.closest("smart-breadcrumb");if(e)return l.classList.remove("forbidden"),e===s.$.rowGroupBreadcrumb?n.allowRowGroup?n.rowGroup||e.$.container.classList.add("drop-target"):l.classList.add("forbidden"):n.allowPivot?n.pivot||e.$.container.classList.add("drop-target"):l.classList.add("forbidden"),void(t._breadcrumbTarget=e)}a===t.$.columnsTree&&!r||r===t.$.rowGroupsTree&&!n.allowRowGroup||r===t.$.pivotsTree&&!n.allowPivot?l.classList.add("forbidden"):l.classList.remove("forbidden")}_dragEndHandler(e){const t=this,l=e.detail,a=l.previousContainer,o=l.container,i=l.item,r=t.columns.find((e=>e.dataField===i.value.dataField)),n=l.target,s=l.data.DropDetails?l.data.DropDetails.position:void 0;function d(){switch(o){case t.$.rowGroupsTree:return!!r.allowRowGroup&&(r.rowGroup=!0,!0);case t.$.summariesTree:return r.summary||(r.summary=t._getDefaultSummaryFunction(r)),!0;case t.$.pivotsTree:return!!r.allowPivot&&(r.pivot=!0,!0)}}function c(){const e=document.createElement("smart-tree-item");return e.label=t._getTreeItemLabel(r),e.value=r,e}function u(){if(a!==o)switch(a){case t.$.rowGroupsTree:delete r.rowGroup;break;case t.$.summariesTree:delete r.summary;break;case t.$.pivotsTree:delete r.pivot}}function m(){if(n.value)return t.columns.find((e=>e.dataField===n.value.dataField))}if(t._breadcrumbTarget)t._breadcrumbDropHandler(r,a);else{if(a===t.$.columnsTree){if(o instanceof Smart.Tree==0)return i.selected=!!(r.pivot||r.rowGroup||r.summary),void e.preventDefault();if(o===a){let e=!1;return(r.rowGroup&&Object.keys(t.$.rowGroupsTree.items).length>1||r.summary&&Object.keys(t.$.summariesTree.items).length>1||r.pivot&&Object.keys(t.$.pivotsTree.items).length>1)&&(e=!0),void requestAnimationFrame((()=>{const l=t.context;t.context=t,t.columns=t.$.columnsTree.dataSource.map((e=>e.value)),e&&(t._createColumnItems(!1),t.$.fireEvent("change",{columns:JSON.parse(JSON.stringify(t.columns))})),t.context=l}))}return Object.values(o._menuItems).find((e=>e.value===r))||(d()?(0===o.dataSource.length?o.insert({label:t._getTreeItemLabel(r),value:r}):("top"===s?o.addBefore(c(),n):o.addAfter(c(),n),t._reorder(r,m(),s)),t.$.fireEvent("change",{columns:JSON.parse(JSON.stringify(t.columns))})):i.selected=!!(r.pivot||r.rowGroup||r.summary)),void e.preventDefault()}if(o instanceof Smart.Tree==0||o===t.$.columnsTree)return u(),a.removeItem(i),t.$.fireEvent("change",{columns:JSON.parse(JSON.stringify(t.columns))}),void e.preventDefault();d()?(u(),t._reorder(r,m(),s),t.$.fireEvent("change",{columns:JSON.parse(JSON.stringify(t.columns))})):e.preventDefault()}}_reorder(e,t,l){const a=this,o=a.columns,i=o.indexOf(e);let r=o.indexOf(t);void 0===e||void 0===t||i>r&&"bottom"===l||i<r&&"top"===l||(o.splice(i,1),r=o.indexOf(t),"bottom"===l?o.splice(r+1,0,e):o.splice(r,0,e),a.columns=o,a.$.columnsTree.dataSource=o.map((e=>({label:e.label,value:e,selected:!!(e.pivot||e.rowGroup||e.summary)}))))}_breadcrumbDropHandler(e,t){const l=this,a=l._breadcrumbTarget,o=l.ownerElement,i=o.columns.find((t=>t.dataField===e.dataField)),r=l.context;function n(){switch(l.context=document,o.columns.canNotify=!1,t){case l.$.rowGroupsTree:i.rowGroup=void 0;break;case l.$.summariesTree:i.summary=void 0;break;case l.$.pivotsTree:i.pivot=void 0}}if(a.$.container.classList.remove("drop-target"),delete l._breadcrumbTarget,a===o.$.rowGroupBreadcrumb){if(!e.allowRowGroup||e.rowGroup)return;n(),i.rowGroup=!0}else{if(!e.allowPivot||e.pivot)return;n(),i.pivot=!0}o._refreshColumns(),l.context=r,o.columns.canNotify=!0}_getTreeItemLabel(e){return'<span class="settings-icon"></span>'+e.label}_settingsIconClickHandler(e){const t=this.isInShadowDOM?e.composedPath()[0]:e.target;t.classList.contains("settings-icon")&&this._openDialog(t.closest("smart-tree-item"))}_openDialog(e){const t=this;t._dialog||t._createDialog();const l=t._dialog,a=e.value,o=!!a.summary,i=Array.from(l.$.container.querySelectorAll(".editor"));let r=a.align||"left";if(t.$.container.setAttribute("modal",""),t._editedItem=e,l.classList.toggle("summary",o),l.setAttribute("aria-controls",e.id),i[0].value="",i[0].$.input.dataValue="",i[0].disabled=e.menu===t.$.summariesTree&&1===Object.keys(e.menu.items).length,i[1].value=t.localize(r),i[1].$.input.dataValue=r,o){let e=Object.assign({align:"left",prefix:"",decimalPlaces:0,thousandsSeparator:"",decimalSeparator:".",negativesInBrackets:!1},a.summarySettings||{});i[2].value=a.summary,i[2].disabled=t.ownerElement&&t.ownerElement.columnTotals,i[3].value=t.localize(e.align),i[3].$.input.dataValue=e.align,i[4].value=e.prefix,i[5].value=e.decimalPlaces.toString(),i[6].value=e.thousandsSeparator,i[7].value=e.decimalSeparator,i[8].checked=e.negativesInBrackets}l.open()}_createDialog(){const e=this,t=e.id,l=document.createElement("smart-window"),a=document.createElement("template"),o=` animation=${e.animation} theme="${e.theme}"${e.rightToLeft?" right-to-left":""}${e.unfocusable?" unfocusable":""}`;a.innerHTML=`<smart-button class="ok primary"${o}>${e.localize("ok")}</smart-button>\n<smart-button class="cancel"${o}>${e.localize("cancel")}</smart-button>`;const i=JSON.stringify([{label:e.localize("columns"),value:"columns"},{label:e.localize("rowGroups"),value:"rowGroups"},{label:e.localize("summaries"),value:"summaries"},{label:e.localize("pivots"),value:"pivots"}]),r=JSON.stringify([{label:e.localize("left"),value:"left"},{label:e.localize("center"),value:"center"},{label:e.localize("right"),value:"right"}]),n=JSON.stringify(["min","max","sum","avg","stdev","stdevp","var","varp","product","count","median"]);l.animation=e.animation,l.footerTemplate=a,l.headerButtons=["close"],l.label=e.localize("columnSettings"),l.rightToLeft=e.rightToLeft,l.theme=e.theme,l.unfocusable=e.unfocusable,l.className="smart-pivot-window",l.innerHTML=`<div id="${t}MoveToLabel" class="label">${e.localize("moveTo")}</div>\n            <div><smart-input class="editor underlined move-to"${o} data-source='${i}' drop-down-button-position="right" readonly aria-labelledby="${t}MoveToLabel"></smart-input></div>\n            <div id="${t}TextAlignmentLabel" class="label">${e.localize("textAlignment")}</div>\n            <div><smart-input class="editor underlined text-alignment"${o} data-source='${r}' drop-down-button-position="right" readonly aria-labelledby="${t}TextAlignmentLabel"></smart-input></div>\n            <div id="${t}CalculationLabel" class="label summary">${e.localize("calculation")}</div>\n            <div class="summary"><smart-input class="editor underlined calculation"${o} data-source='${n}' drop-down-button-position="right" readonly aria-labelledby="${t}CalculationLabel"></smart-input></div>\n            <div class="label category summary">${e.localize("numberFormat")}</div>\n            <div id="${t}NumberAlignmentLabel" class="label summary">${e.localize("numberAlignment")}</div>\n            <div class="summary"><smart-input class="editor underlined number-alignment"${o} data-source='${r}' drop-down-button-position="right" readonly aria-labelledby="${t}NumberAlignmentLabel"></smart-input></div>\n            <div id="${t}NumberPrefixLabel" class="label summary">${e.localize("numberPrefix")}</div>\n            <div class="summary"><smart-input class="editor underlined number-prefix"${o} aria-labelledby="${t}NumberPrefixLabel"></smart-input></div>\n            <div id="${t}DecimalPlacesLabel" class="label summary">${e.localize("decimalPlaces")}</div>\n            <div class="summary"><smart-input class="editor underlined decimal-places"${o} aria-labelledby="${t}DecimalPlacesLabel"></smart-input></div>\n            <div id="${t}ThousandsSeparatorLabel" class="label summary">${e.localize("thousandsSeparator")}</div>\n            <div class="summary"><smart-input class="editor underlined thousands-separator"${o} aria-labelledby="${t}ThousandsSeparatorLabel"></smart-input></div>\n            <div id="${t}DecimalSeparatorLabel" class="label summary">${e.localize("decimalSeparator")}</div>\n            <div class="summary"><smart-input class="editor underlined decimal-separator"${o} aria-labelledby="${t}DecimalSeparatorLabel"></smart-input></div>\n            <div id="${t}NegativesInBracketsLabel" class="label summary">${e.localize("negativesInBrackets")}</div>\n            <div class="summary"><smart-check-box class="editor"${o} aria-labelledby="${t}NegativesInBracketsLabel"></smart-check-box></div>`,l.ownerElement=e,e._dialog=l,e._addDialogHandlers(),e.getShadowRootOrBody().appendChild(l),e.setAttribute("aria-owns",l.id)}_addDialogHandlers(){const e=this,t=e._dialog;t.addEventListener("close",e._dialogCloseHandler),t.addEventListener("click",e._dialogClickHandler)}_dialogClickHandler(e){const t=this,l=t.isInShadowDOM?e.composedPath()[0]:e.target;l.closest(".ok")?(t.ok=!0,t.close()):l.closest(".cancel")&&t.close()}_dialogCloseHandler(e){const t=this.ownerElement,l=t._dialog,a=t.context;if((l.isInShadowDOM?e.composedPath()[0]:e.target)!==l)return;const o=t._editedItem;if(t.context=t,t.$.container.removeAttribute("modal"),o.menu.focus(),l.ok){const e=o.value,a=Array.from(l.$.container.querySelectorAll(".editor")),i=a[0].$.input.dataValue,r=a[1].$.input.dataValue;let n=!1,s=!1;if(i&&!("rowGroups"===i&&(e.rowGroup||!e.allowRowGroup)||"summaries"===i&&e.summary||"pivots"===i&&(e.pivot||!e.allowPivot))){const l=o.menu;let a;switch(l.removeItem(o.path),l){case t.$.rowGroupsTree:delete e.rowGroup;break;case t.$.summariesTree:delete e.summary;break;case t.$.pivotsTree:delete e.pivot}switch(i){case"rowGroups":a=t.$.rowGroupsTree,e.rowGroup=!0;break;case"summaries":a=t.$.summariesTree,e.summary=t._getDefaultSummaryFunction(e),s=!0;break;case"pivots":a=t.$.pivotsTree,e.pivot=!0}if(a){const l=document.createElement("smart-tree-item");l.label=t._getTreeItemLabel(e),l.value=e,a.addTo(l),l.previousElementSibling&&t._reorder(e,l.previousElementSibling.value,"bottom")}n=!0}if((!e.align&&"left"!==r||e.align&&e.align!==r)&&(e.align=r,n=!0),e.summary&&!s){const t={align:"left",prefix:"",decimalPlaces:0,thousandsSeparator:"",decimalSeparator:".",negativesInBrackets:!1},l=e.summarySettings,o={align:a[3].$.input.dataValue,prefix:a[4].value,decimalPlaces:parseFloat(a[5].value),thousandsSeparator:a[6].value,decimalSeparator:a[7].value,negativesInBrackets:a[8].checked},i=a[2].value;if(isNaN(o.decimalPlaces)&&(o.decimalPlaces=l?l.decimalPlaces:0),i!==e.summary&&(e.summary=i,n=!0),l){const a=Object.assign({},t,l);Object.keys(a).forEach((t=>{a[t]!==o[t]&&(e.summarySettings[t]=o[t],n=!0)}))}else JSON.stringify(t)!==JSON.stringify(o)&&(e.summarySettings=o,n=!0)}delete l.ok,n&&t.$.fireEvent("change",{columns:JSON.parse(JSON.stringify(t.columns))})}delete t._editedItem,t.context=a}_setFocusable(){const e=this;if(e.disabled||e.unfocusable)return e.$.columnsTab.removeAttribute("tabindex"),void e.$.filtersTab.removeAttribute("tabindex");const t=e.$.columnsTab.getAttribute("tabindex");(null===t||t<0)&&(e.$.columnsTab.setAttribute("tabindex",0),e.$.filtersTab.setAttribute("tabindex",0))}_keydownHandler(e){const t=this,l=e.key,a=t.getRootNode().activeElement;if("Enter"!==l&&" "!==l||a!==t.$.columnsTab&&a!==t.$.filtersTab){if("Enter"===l&&-1!==[t.$.rowGroupsTree,t.$.summariesTree,t.$.pivotsTree].indexOf(a)){const e=a.querySelector("[focus]");e&&this._openDialog(e)}}else t._tabsClickHandler({target:a})}_getDefaultSummaryFunction(e){const t=this.ownerElement;return t&&t._getDefaultSummaryFunction?t._getDefaultSummaryFunction(e):"count"}_setAriaRelations(){const e=this,t=e.id;e.setAttribute("role","tablist"),e.$.columnsView.id=t+"ColumnsView",e.$.columnsTab.id=t+"columnsTab",e.$.columnsTab.setAttribute("aria-controls",e.$.columnsView.id),e.$.columnsView.setAttribute("aria-labelledby",e.$.columnsTab.id),e.$.filtersView.id=t+"FiltersView",e.$.filtersTab.id=t+"FiltersTab",e.$.filtersTab.setAttribute("aria-controls",e.$.filtersView.id),e.$.filtersView.setAttribute("aria-labelledby",e.$.filtersTab.id),e.$.rowGroupsLabel.id=t+"RowGroupsLabel",e.$.rowGroupsTree.setAttribute("aria-labelledby",e.$.rowGroupsLabel.id),e.$.summariesLabel.id=t+"SummariesLabel",e.$.summariesTree.setAttribute("aria-labelledby",e.$.summariesLabel.id),e.$.pivotsLabel.id=t+"PivotsLabel",e.$.pivotsTree.setAttribute("aria-labelledby",e.$.pivotsLabel.id)}});